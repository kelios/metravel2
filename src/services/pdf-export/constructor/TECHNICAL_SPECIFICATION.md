# Техническое задание: Визуальный конструктор PDF для статей

## Версия: 2.0
## Дата: 2024
## Статус: Требуется доработка

---

## 1. АНАЛИЗ ТЕКУЩЕЙ РЕАЛИЗАЦИИ

### 1.1. Что реализовано ✅

#### Архитектура и инфраструктура
- ✅ Модели данных (PdfDocument, PdfPage, PdfBlock, PdfTheme)
- ✅ Система тем (5 встроенных тем: Simple, Light, Dark, Magazine, Travel Book)
- ✅ Билдер документа (PdfDocumentBuilder)
- ✅ Импортер статей (ArticleImporter) - автоматическое создание блоков из HTML
- ✅ Рендерер страниц в изображения (PageImageRenderer) - Canvas → PNG/WebP
- ✅ Сборщик PDF из изображений (PdfAssembler) - использует pdf-lib
- ✅ Основной сервис (ArticleConstructorService)

#### UI компоненты
- ✅ Главный компонент конструктора (PdfConstructor)
- ✅ Палитра блоков (BlockPalette) - модальное окно с типами блоков
- ✅ Холст страницы (PageCanvas) - отображение страницы с блоками
- ✅ Панель стилей (StylePanel) - редактирование стилей блока
- ✅ Навигатор страниц (PageNavigator) - список страниц, переключение

#### Функциональность
- ✅ Добавление блоков на страницу
- ✅ Выбор и выделение блоков
- ✅ Редактирование стилей через панель
- ✅ Удаление блоков
- ✅ Добавление/удаление/дублирование страниц
- ✅ Переключение тем
- ✅ Экспорт в PDF с прогрессом
- ✅ Автоматический импорт статьи в конструктор

### 1.2. Что НЕ реализовано ❌

#### Критичные функции
- ❌ **Drag & Drop** - перетаскивание блоков для изменения позиции
- ❌ **Inline редактирование** - прямое редактирование текста на холсте
- ❌ **Изменение размеров блоков** - визуальное изменение размеров через маркеры
- ❌ **Параметры страницы в UI** - изменение формата (A4/A5/A6) и ориентации через интерфейс
- ❌ **Точный предпросмотр 1:1** - текущий предпросмотр масштабируется автоматически

#### Частично реализовано
- ⚠️ **Редактирование текста** - только через панель стилей, нет inline редактирования
- ⚠️ **Рендеринг всех типов блоков** - не все типы полностью реализованы в PageImageRenderer
- ⚠️ **Перемещение блоков** - нет визуального drag & drop, только через панель

#### Дополнительные функции
- ❌ История изменений (undo/redo)
- ❌ Копирование/вставка блоков
- ❌ Группировка блоков
- ❌ Выравнивание блоков (сетка, направляющие)
- ❌ Шаблоны страниц
- ❌ Сохранение/загрузка макетов
- ❌ Экспорт в другие форматы (EPUB, HTML)

---

## 2. ТРЕБОВАНИЯ ПОЛЬЗОВАТЕЛЯ (из исходного запроса)

### 2.1. Общая концепция
- ✅ Пользователь открывает статью
- ✅ Переходит в «Конструктор PDF»
- ✅ Видит будущие страницы как холсты
- ❌ Может перетаскивать блоки (не реализовано)
- ⚠️ Может настраивать стиль блоков (частично - через панель)
- ✅ Может менять темы документа
- ✅ Каждая страница рендерится в PNG/WebP
- ✅ Из изображений собирается PDF

### 2.2. Требования к конструктору
- ✅ Визуальный редактор
- ❌ Drag & drop перестановка блоков
- ❌ Inline-редактирование текста
- ✅ Панель компонентов
- ✅ Панель стилей
- ❌ Параметры страницы в UI (формат A4/A5/A6)
- ⚠️ Предпросмотр 1:1 (есть, но с автоматическим масштабированием)
- ✅ Дублирование страницы
- ✅ Автогенерация блоков из HTML статьи

### 2.3. Блоки
- ✅ Заголовки H1, H2, H3
- ✅ Абзац текста
- ✅ Фото
- ✅ Галерея (1, 2, 3, 4 фото)
- ✅ Фото с подписью
- ✅ Карта (PNG)
- ✅ Блок «Совет»
- ✅ Блок «Важно»
- ✅ Блок «Предупреждение»
- ✅ Цитата
- ✅ Чек-лист
- ✅ Таблица
- ✅ Разделитель
- ✅ Пустое пространство / Spacer
- ⚠️ Блок с подложкой-фоном (частично)
- ✅ Обложка (Template)
- ✅ Оглавление
- ✅ Блок «О авторе»
- ✅ Рекомендации / что посмотреть

### 2.4. Темы и стили
- ✅ Система тем (5 встроенных)
- ✅ JSON-конфигурации тем
- ✅ Шрифты, размеры, палитры цветов
- ✅ Оформление спецблоков
- ✅ Фон страниц
- ✅ Сетка/отступы
- ✅ Декор (рамки, тени)
- ✅ Возможность добавлять свои темы

### 2.5. Архитектура рендера
- ✅ Canvas-движок (Canvas API)
- ✅ canvas.toDataURL("image/png")
- ✅ WebP поддержка
- ✅ Каждая страница = отдельный canvas

### 2.6. Сборка PDF
- ✅ Сборка PDF из изображений (pdf-lib)
- ✅ DPI 300 для печати
- ✅ Сохранение порядка страниц
- ⚠️ Оптимизация веса (базовая)

### 2.7. Импорт существующей статьи
- ✅ Анализ HTML статьи
- ✅ Преобразование в структурированные блоки
- ✅ Автоматическое добавление в конструктор
- ✅ Возможность переставлять блоки (частично)
- ✅ Возможность менять стиль

---

## 3. НОВОЕ ТЕХНИЧЕСКОЕ ЗАДАНИЕ

### 3.1. Цель проекта

Создать полнофункциональный визуальный конструктор PDF документов из статей с возможностью:
- Визуального редактирования макета
- Drag & Drop перестановки блоков
- Inline редактирования контента
- Гибкой настройки стилей
- Экспорта в высококачественный PDF через рендеринг в изображения

### 3.2. Функциональные требования

#### 3.2.1. Визуальный редактор

**Требование FR-001: Drag & Drop блоков**
- **Приоритет**: Высокий
- **Описание**: Пользователь должен иметь возможность перетаскивать блоки на странице для изменения их позиции
- **Детали**:
  - При наведении на блок появляется курсор "move"
  - При начале перетаскивания блок визуально поднимается (shadow, opacity)
  - Во время перетаскивания показывается призрачная копия блока
  - При наведении на область вставки показывается индикатор позиции
  - Поддержка перетаскивания между страницами
  - Автоматическое обновление координат блока
- **Критерии приемки**:
  - Блок можно перетащить в любую точку страницы
  - Координаты обновляются в реальном времени
  - После отпускания блок остается на новой позиции
  - Работает на всех типах блоков

**Требование FR-002: Inline редактирование текста**
- **Приоритет**: Высокий
- **Описание**: Пользователь должен иметь возможность редактировать текст напрямую на холсте, без открытия панели
- **Детали**:
  - Двойной клик по текстовому блоку активирует режим редактирования
  - Текст становится редактируемым (contentEditable или input)
  - При потере фокуса изменения сохраняются
  - Поддержка форматирования (жирный, курсив) через горячие клавиши
  - Автоматическое изменение размера блока при изменении текста
- **Критерии приемки**:
  - Двойной клик активирует редактирование
  - Изменения сохраняются при потере фокуса
  - Работает для всех текстовых блоков (заголовки, параграфы)

**Требование FR-003: Изменение размеров блоков**
- **Приоритет**: Средний
- **Описание**: Пользователь должен иметь возможность изменять размеры блоков визуально через маркеры
- **Детали**:
  - При выделении блока появляются маркеры изменения размера (8 точек)
  - Перетаскивание маркеров изменяет размер блока
  - Сохранение пропорций при зажатом Shift
  - Минимальные и максимальные размеры для каждого типа блока
  - Автоматическое перенос текста при изменении размера
- **Критерии приемки**:
  - Маркеры появляются при выделении
  - Размер изменяется при перетаскивании
  - Пропорции сохраняются с Shift

**Требование FR-004: Параметры страницы в UI**
- **Приоритет**: Средний
- **Описание**: Пользователь должен иметь возможность изменять формат и ориентацию страницы через интерфейс
- **Детали**:
  - Выпадающий список форматов (A4, A5, A6, Letter)
  - Переключатель ориентации (Portrait/Landscape)
  - Кнопка применения изменений
  - Предупреждение при изменении (может повлиять на макет)
  - Автоматическое масштабирование блоков (опционально)
- **Критерии приемки**:
  - Формат можно изменить в любой момент
  - Ориентация меняется мгновенно
  - Блоки адаптируются к новому формату

**Требование FR-005: Точный предпросмотр 1:1**
- **Приоритет**: Низкий
- **Описание**: Пользователь должен иметь возможность видеть страницу в масштабе 1:1
- **Детали**:
  - Кнопка "Предпросмотр 1:1" в тулбаре
  - Переключение между автоматическим масштабом и 1:1
  - Индикатор текущего масштаба
  - Прокрутка для больших страниц
- **Критерии приемки**:
  - Предпросмотр показывает реальный размер страницы
  - Можно переключаться между режимами

#### 3.2.2. Улучшения существующего функционала

**Требование FR-006: Улучшение панели стилей**
- **Приоритет**: Средний
- **Описание**: Расширить возможности панели стилей
- **Детали**:
  - Вкладки для разных категорий стилей (Текст, Фон, Границы, Тени, Трансформации)
  - Визуальные селекторы цветов (color picker)
  - Предпросмотр стилей в реальном времени
  - Сброс стилей к теме по умолчанию
  - Копирование стилей между блоками
- **Критерии приемки**:
  - Все стили доступны через панель
  - Изменения применяются мгновенно

**Требование FR-007: Полная поддержка всех типов блоков в рендерере**
- **Приоритет**: Высокий
- **Описание**: Все типы блоков должны корректно рендериться в изображения
- **Детали**:
  - Проверить и доработать рендеринг всех типов блоков
  - Особое внимание: галереи, таблицы, чек-листы, оглавление
  - Тестирование на разных темах
- **Критерии приемки**:
  - Все блоки рендерятся корректно
  - Визуально соответствуют предпросмотру

**Требование FR-008: История изменений (Undo/Redo)**
- **Приоритет**: Средний
- **Описание**: Пользователь должен иметь возможность отменять и повторять действия
- **Детали**:
  - Сохранение состояния документа при каждом действии
  - Горячие клавиши Ctrl+Z / Ctrl+Shift+Z
  - Кнопки в тулбаре
  - Ограничение истории (например, 50 действий)
- **Критерии приемки**:
  - Можно отменить любое действие
  - Можно повторить отмененное действие

**Требование FR-009: Копирование/вставка блоков**
- **Приоритет**: Средний
- **Описание**: Пользователь должен иметь возможность копировать и вставлять блоки
- **Детали**:
  - Горячие клавиши Ctrl+C / Ctrl+V
  - Кнопки в контекстном меню
  - Копирование между страницами
  - Копирование стилей отдельно
- **Критерии приемки**:
  - Блок копируется со всеми стилями
  - Можно вставить на другую страницу

#### 3.2.3. Дополнительные функции

**Требование FR-010: Шаблоны страниц**
- **Приоритет**: Низкий
- **Описание**: Предустановленные макеты страниц для быстрого старта
- **Детали**:
  - Библиотека шаблонов (обложка, контент, финальная страница)
  - Применение шаблона к странице
  - Сохранение пользовательских шаблонов
- **Критерии приемки**:
  - Можно применить шаблон к странице
  - Шаблон заменяет текущие блоки

**Требование FR-011: Сохранение/загрузка макетов**
- **Приоритет**: Средний
- **Описание**: Пользователь должен иметь возможность сохранять и загружать макеты
- **Детали**:
  - Кнопка "Сохранить макет"
  - Список сохраненных макетов
  - Загрузка макета из списка
  - Экспорт/импорт макета в JSON
- **Критерии приемки**:
  - Макет сохраняется со всеми настройками
  - Можно загрузить сохраненный макет

**Требование FR-012: Выравнивание и сетка**
- **Приоритет**: Низкий
- **Описание**: Визуальные направляющие для выравнивания блоков
- **Детали**:
  - Включение/выключение сетки
  - Направляющие линии при перетаскивании
  - Автоматическое прилипание к сетке
  - Выравнивание блоков друг относительно друга
- **Критерии приемки**:
  - Сетка помогает выравнивать блоки
  - Прилипание работает корректно

### 3.3. Технические требования

#### 3.3.1. Drag & Drop реализация

**Требование TR-001: Библиотека для Drag & Drop**
- **Варианты**:
  1. **react-dnd** (React DnD) - популярная, но может быть избыточной
  2. **@dnd-kit/core** - современная, легковесная
  3. **react-beautiful-dnd** - для списков, не подходит для свободного позиционирования
  4. **Собственная реализация** - на основе mouse/touch events
- **Рекомендация**: @dnd-kit/core или собственная реализация
- **Обоснование**: Нужна поддержка свободного позиционирования, не только списков

**Требование TR-002: Производительность**
- Drag & Drop должен работать плавно (60 FPS)
- Не должно быть лагов при перетаскивании
- Оптимизация рендеринга во время перетаскивания

#### 3.3.2. Inline редактирование

**Требование TR-003: Редактор текста**
- Использовать contentEditable или специализированную библиотеку
- Поддержка форматирования через горячие клавиши
- Автоматическое сохранение при потере фокуса

#### 3.3.3. Изменение размеров

**Требование TR-004: Ресайз маркеры**
- 8 маркеров для изменения размера (углы + стороны)
- Визуальная обратная связь при наведении
- Ограничения минимальных/максимальных размеров

### 3.4. UX требования

#### 3.4.1. Интерфейс

**Требование UX-001: Интуитивность**
- Все действия должны быть понятны без инструкции
- Визуальная обратная связь на все действия
- Подсказки при наведении

**Требование UX-002: Производительность**
- Интерфейс должен отзываться мгновенно
- Нет видимых задержек при действиях
- Плавные анимации

**Требование UX-003: Адаптивность**
- Работает на разных размерах экранов
- Оптимизация для планшетов
- Мобильная версия (опционально)

### 3.5. Архитектурные требования

#### 3.5.1. Структура данных

**Требование AR-001: Сохранение состояния**
- Все изменения должны сохраняться в модель документа
- Поддержка истории изменений
- Возможность сериализации/десериализации

#### 3.5.2. Рендеринг

**Требование AR-002: Качество рендеринга**
- Высокое качество изображений (300 DPI)
- Корректное отображение всех стилей
- Поддержка WebP для оптимизации

#### 3.5.3. Производительность

**Требование AR-003: Оптимизация**
- Ленивая загрузка изображений
- Виртуализация для больших документов
- Кэширование отрендеренных страниц

### 3.6. Приоритизация задач

#### Фаза 1: Критичные функции (MVP+)
1. ✅ Базовый конструктор (реализовано)
2. ❌ Drag & Drop блоков
3. ❌ Inline редактирование текста
4. ❌ Изменение размеров блоков
5. ⚠️ Полная поддержка всех блоков в рендерере

#### Фаза 2: Улучшения UX
1. ❌ Параметры страницы в UI
2. ❌ История изменений (Undo/Redo)
3. ❌ Копирование/вставка блоков
4. ⚠️ Улучшение панели стилей

#### Фаза 3: Дополнительные функции
1. ❌ Шаблоны страниц
2. ❌ Сохранение/загрузка макетов
3. ❌ Выравнивание и сетка
4. ❌ Точный предпросмотр 1:1

---

## 4. ПЛАН РЕАЛИЗАЦИИ

### 4.1. Этап 1: Drag & Drop (2-3 дня)

**Задачи**:
1. Выбрать и установить библиотеку для DnD
2. Реализовать перетаскивание блоков на странице
3. Добавить визуальную обратную связь
4. Обновление координат в реальном времени
5. Тестирование на всех типах блоков

**Файлы для изменения**:
- `components/export/constructor/PageCanvas.tsx` - добавить DnD логику
- `components/export/constructor/DraggableBlock.tsx` - новый компонент (опционально)

### 4.2. Этап 2: Inline редактирование (1-2 дня)

**Задачи**:
1. Реализовать двойной клик для активации редактирования
2. Добавить contentEditable или input для текстовых блоков
3. Сохранение изменений при потере фокуса
4. Поддержка горячих клавиш для форматирования

**Файлы для изменения**:
- `components/export/constructor/PageCanvas.tsx` - добавить inline редактирование
- `components/export/constructor/EditableTextBlock.tsx` - новый компонент

### 4.3. Этап 3: Изменение размеров (1-2 дня)

**Задачи**:
1. Добавить маркеры изменения размера при выделении
2. Реализовать перетаскивание маркеров
3. Ограничения размеров
4. Сохранение пропорций с Shift

**Файлы для изменения**:
- `components/export/constructor/PageCanvas.tsx` - добавить ресайз маркеры
- `components/export/constructor/ResizeHandles.tsx` - новый компонент

### 4.4. Этап 4: Параметры страницы в UI (1 день)

**Задачи**:
1. Добавить UI для выбора формата
2. Добавить переключатель ориентации
3. Применение изменений
4. Обновление всех страниц

**Файлы для изменения**:
- `components/export/PdfConstructor.tsx` - добавить UI элементы
- `components/export/constructor/PageSettingsPanel.tsx` - новый компонент

### 4.5. Этап 5: История изменений (2 дня)

**Задачи**:
1. Реализовать систему истории (Command pattern)
2. Сохранение состояния при каждом действии
3. Горячие клавиши
4. Кнопки в UI

**Файлы для изменения**:
- `src/services/pdf-export/constructor/HistoryManager.ts` - новый сервис
- `components/export/PdfConstructor.tsx` - интеграция

### 4.6. Этап 6: Доработка рендерера (2-3 дня)

**Задачи**:
1. Проверить все типы блоков
2. Доработать недостающие
3. Тестирование на всех темах
4. Оптимизация производительности

**Файлы для изменения**:
- `src/services/pdf-export/constructor/renderers/PageImageRenderer.ts`

---

## 5. ОЦЕНКА ТРУДОЕМКОСТИ

### Фаза 1 (MVP+): 6-9 дней
- Drag & Drop: 2-3 дня
- Inline редактирование: 1-2 дня
- Изменение размеров: 1-2 дня
- Доработка рендерера: 2-3 дня

### Фаза 2 (Улучшения): 4-5 дней
- Параметры страницы: 1 день
- История изменений: 2 дня
- Копирование/вставка: 1 день
- Улучшение панели стилей: 1 день

### Фаза 3 (Дополнительно): 4-5 дней
- Шаблоны: 1-2 дня
- Сохранение макетов: 1 день
- Выравнивание: 1-2 дня
- Предпросмотр 1:1: 1 день

**Итого**: 14-19 дней разработки

---

## 6. РИСКИ И МИТИГАЦИЯ

### Риск 1: Производительность при большом количестве блоков
- **Митигация**: Виртуализация, ленивая загрузка, оптимизация рендеринга

### Риск 2: Сложность реализации Drag & Drop для свободного позиционирования
- **Митигация**: Использовать проверенную библиотеку (@dnd-kit), начать с простой реализации

### Риск 3: Качество рендеринга Canvas
- **Митигация**: Тестирование на разных браузерах, оптимизация алгоритмов рендеринга

### Риск 4: Размер PDF файлов
- **Митигация**: Оптимизация изображений, сжатие, выбор формата (WebP вместо PNG)

---

## 7. КРИТЕРИИ ПРИЕМКИ

### Общие критерии
- ✅ Все функции работают без ошибок
- ✅ Интерфейс интуитивен и понятен
- ✅ Производительность приемлема (60 FPS)
- ✅ Работает во всех современных браузерах
- ✅ Качество PDF соответствует требованиям (300 DPI)

### Специфичные критерии
- ✅ Drag & Drop работает плавно на всех типах блоков
- ✅ Inline редактирование сохраняет изменения
- ✅ Изменение размеров работает корректно
- ✅ Все блоки рендерятся правильно
- ✅ PDF соответствует визуальному макету

---

## 8. ДОКУМЕНТАЦИЯ

### Требуется создать/обновить
- ✅ Руководство пользователя (USER_GUIDE.md) - создано
- ⚠️ API документация - требуется обновление
- ⚠️ Руководство разработчика - требуется обновление
- ⚠️ Примеры использования - требуется создание

---

## 9. ЗАКЛЮЧЕНИЕ

Текущая реализация представляет собой **solid foundation** для визуального конструктора PDF. Реализованы базовые функции, архитектура продумана, система расширяема.

**Основные пробелы**:
1. Отсутствие Drag & Drop - критично для удобства использования
2. Нет inline редактирования - снижает скорость работы
3. Нет визуального изменения размеров - неудобно для точной настройки

**Рекомендации**:
1. Начать с Фазы 1 (критичные функции)
2. Протестировать на реальных пользователях после Фазы 1
3. Итеративно добавлять функции из Фазы 2 и 3

**Приоритет**: Высокий для Drag & Drop и Inline редактирования, средний для остального.

