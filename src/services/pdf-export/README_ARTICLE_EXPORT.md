# Экспорт статьи путешествия в PDF

## Обзор

Реализован функционал экспорта статей раздела «Путешествия» в дизайнерский PDF, который выглядит как небольшая книга/путеводитель и готов к печати (А4) и чтению на планшете/ноутбуке.

## Архитектура

### Компоненты

1. **ArticleParser** (`src/services/pdf-export/parsers/ArticleParser.ts`)
   - Парсит HTML контент статьи в структурированную модель `ArticlePdfModel`
   - Извлекает метаданные, изображения, карту, рекомендации

2. **ArticlePdfGenerator** (`src/services/pdf-export/generators/ArticlePdfGenerator.ts`)
   - Генерирует HTML для PDF с учетом выбранной темы
   - Создает обложку, оглавление, инфокарту, контент, карту, рекомендации

3. **ArticlePdfExportService** (`src/services/pdf-export/ArticlePdfExportService.ts`)
   - Оркестрирует весь процесс экспорта
   - Загружает изображения, рендерит PDF

4. **Темы оформления** (`src/services/pdf-export/themes/PdfThemeConfig.ts`)
   - Simple (minimal) - минималистичная
   - Light - светлая с большим количеством воздуха
   - Dark - темная для экрана
   - Magazine (travel-magazine) - журнальная вёрстка

### UI Компоненты

1. **ArticleExportModal** (`components/export/ArticleExportModal.tsx`)
   - Модальное окно настроек экспорта
   - Выбор темы, формата, опций

2. **ShareButtons** (обновлен)
   - Добавлена кнопка "Экспорт в PDF"
   - Интегрирован модальный экспорт

### Хуки

- **useArticlePdfExport** (`hooks/useArticlePdfExport.ts`)
  - React hook для экспорта статьи
  - Управление состоянием и прогрессом

## Использование

### Базовое использование

```typescript
import { useArticlePdfExport } from '@/hooks/useArticlePdfExport';
import type { ArticleExportSettings } from '@/src/services/pdf-export/generators/ArticlePdfGenerator';

function MyComponent({ travel }: { travel: Travel }) {
  const { exportArticle, isGenerating, progress } = useArticlePdfExport();

  const handleExport = () => {
    const settings: ArticleExportSettings = {
      theme: 'light',
      format: 'A4',
      includeToc: true,
      includeMap: true,
      includeRecommendations: true,
    };
    
    exportArticle(travel, settings);
  };

  return (
    <button onClick={handleExport} disabled={isGenerating}>
      {isGenerating ? `Экспорт... ${progress}%` : 'Экспорт в PDF'}
    </button>
  );
}
```

### Настройки экспорта

```typescript
interface ArticleExportSettings {
  theme: 'simple' | 'light' | 'dark' | 'magazine';
  format: 'A4' | 'Letter' | 'A5';
  includeToc: boolean;
  includeMap: boolean;
  includeRecommendations: boolean;
  language?: 'ru' | 'en';
}
```

## Структура PDF

1. **Обложка**
   - Название маршрута
   - Подзаголовок (если есть)
   - Автор
   - Обложечное фото
   - Логотип MeTravel

2. **Оглавление** (опционально)
   - Генерируется по H2 заголовкам
   - Номера страниц

3. **Инфокарта путешествия**
   - Страна, регион
   - Длина маршрута
   - Набор/сброс высоты
   - Сложность, сезон
   - Длительность, формат

4. **Основная часть**
   - Текст статьи с разделами
   - Спецблоки (Совет, Важно, Предупреждение)
   - Фотографии
   - Галереи

5. **Карта маршрута** (опционально)
   - Статичное изображение карты
   - Описание и точки маршрута
   - Координаты и расстояния

6. **Рекомендации** (опционально)
   - Что взять с собой
   - Где остановиться/поесть
   - Полезные ссылки

7. **Задняя обложка**
   - Логотип
   - Ссылка на сайт
   - Дисклеймер

## Обработка контента

### Парсинг HTML

- Удаляются React Native компоненты
- Очищаются inline-стили
- Нормализуются теги
- Извлекаются спецблоки по классам

### Маппинг тегов

- `h1` → заголовок книги
- `h2` → разделы (для оглавления)
- `h3` → подзаголовки
- `p` → абзацы
- `ul/ol/li` → списки
- `blockquote` → цитаты
- Спец-классы → инфоблоки
- `img` → изображения
- Блок карты → карта маршрута

## Темы оформления

Каждая тема определяет:
- Шрифты (основной, заголовки, подписи)
- Размеры (h1, h2, h3, body, подписи)
- Цветовую палитру
- Сетку и отступы
- Оформление спецблоков

Темы задаются через JSON/TS конфиги, что позволяет легко добавлять новые стили.

## Карты

Для генерации статичных карт используется:
- Mapbox Static API (по умолчанию)
- Можно заменить на Google Static Maps или другой сервис
- Генерируется URL с маршрутом и точками

## Обработка ошибок

- Отсутствие изображений → показывается заглушка или блок пропускается
- Ошибки загрузки → PDF не падает, ошибка логируется
- Неожиданные теги → игнорируются
- UTF-8 поддержка → русские и латинские символы

## Производительность

- Время генерации для средней статьи (15–20 тыс. знаков, 15–30 фото) — до 10 секунд
- Прогресс-бар показывает этапы:
  - Обработка данных (10%)
  - Генерация содержимого (30%)
  - Подготовка к рендерингу (50%)
  - Загрузка изображений (60-90%)
  - Создание PDF (90-100%)

## Тестирование

Рекомендуется протестировать на:
1. Короткая статья с 2–3 фото, без карты
2. Длинная статья с картой, большим числом фото
3. Статья с большим количеством инфоблоков
4. Статья без фото, только текст и списки

## TODO

- [ ] Добавить реальный API ключ для карт (или использовать другой сервис)
- [ ] Улучшить обработку карт (рендер через отдельный сервис)
- [ ] Добавить тесты для парсера и генератора
- [ ] Оптимизировать загрузку изображений
- [ ] Добавить поддержку QR-кода на задней обложке

