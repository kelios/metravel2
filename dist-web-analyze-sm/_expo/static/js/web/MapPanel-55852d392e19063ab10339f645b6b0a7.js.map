{"version":3,"sources":["/components/MapPage/MapPanel.tsx","/hooks/useLazyMap.ts"],"sourcesContent":["import React, { useEffect, useMemo, useState } from 'react';\nimport { View, StyleSheet, Platform, Text, ActivityIndicator } from 'react-native';\nimport { useLazyMap } from '@/hooks/useLazyMap';\n\ntype LatLng = { latitude: number; longitude: number };\n\ninterface MapPanelProps {\n    travelsData: any[];\n    coordinates: LatLng;\n    routePoints?: [number, number][];\n    placesAlongRoute?: any[];\n    mode?: 'radius' | 'route';\n    setRoutePoints?: (points: [number, number][]) => void;\n    onMapClick?: (lng: number, lat: number) => void;\n    transportMode?: 'car' | 'bike' | 'foot';\n    setRouteDistance: (distance: number) => void;\n    setFullRouteCoords: (coords: [number, number][]) => void;\n    radius?: string; // Радиус поиска в км\n}\n\n/** Плейсхолдер для нативных платформ или во время загрузки карты */\nfunction Placeholder({ text = 'Карта доступна только в браузере' }: { text?: string }) {\n    return (\n        <View style={styles.placeholder}>\n            <ActivityIndicator size=\"large\" />\n            <Text style={styles.placeholderText}>{text}</Text>\n        </View>\n    );\n}\n\nconst MapPanel: React.FC<MapPanelProps> = ({\n                                               travelsData,\n                                               coordinates,\n                                               routePoints = [],\n                                               placesAlongRoute = [],\n                                               mode = 'radius',\n                                               setRoutePoints = () => {},\n                                               onMapClick = () => {},\n                                               transportMode = 'car',\n                                               setRouteDistance,\n                                               setFullRouteCoords,\n                                               radius,\n                                           }) => {\n    const isWeb = Platform.OS === 'web' && typeof window !== 'undefined';\n\n    // ✅ УЛУЧШЕНИЕ: Ленивая загрузка карты с Intersection Observer\n    const { shouldLoad, setElementRef } = useLazyMap({\n        rootMargin: '200px',\n        threshold: 0.1,\n        enabled: isWeb,\n    });\n\n    // Динамически импортируем веб-карту, только в браузере и когда нужно\n    const [WebMap, setWebMap] = useState<React.ComponentType<any> | null>(null);\n    const [loading, setLoading] = useState(isWeb && shouldLoad);\n\n    useEffect(() => {\n        let mounted = true;\n        if (!isWeb || !shouldLoad) return;\n\n        (async () => {\n            try {\n                const mod = await import('@/components/MapPage/Map');\n                if (mounted) setWebMap(() => (mod.default ?? mod as any));\n            } catch (e) {\n                console.error('[MapPanel] Failed to load web map:', e);\n            } finally {\n                if (mounted) setLoading(false);\n            }\n        })();\n\n        return () => {\n            mounted = false;\n        };\n    }, [isWeb, shouldLoad]);\n\n    const travelProp = useMemo(() => ({ data: travelsData }), [travelsData]);\n\n    if (!isWeb) return <Placeholder />;\n\n    if (!shouldLoad) {\n        return (\n            <View \n                style={styles.mapContainer}\n                ref={setElementRef as any}\n            >\n                <Placeholder text=\"Карта загрузится при прокрутке…\" />\n            </View>\n        );\n    }\n\n    if (loading || !WebMap) {\n        return <Placeholder text=\"Инициализация карты…\" />;\n    }\n\n    return (\n        <View \n            style={styles.mapContainer}\n            ref={setElementRef as any}\n        >\n            <WebMap\n                travel={travelProp}\n                coordinates={coordinates}\n                routePoints={routePoints}\n                placesAlongRoute={placesAlongRoute}\n                mode={mode}\n                setRoutePoints={setRoutePoints}\n                onMapClick={onMapClick}\n                transportMode={transportMode}\n                setRouteDistance={setRouteDistance}\n                setFullRouteCoords={setFullRouteCoords}\n                radius={radius}\n            />\n        </View>\n    );\n};\n\nexport default React.memo(MapPanel);\n\nconst styles = StyleSheet.create({\n    mapContainer: {\n        flex: 1,\n        borderRadius: 16,\n        overflow: 'hidden',\n        backgroundColor: '#fff',\n    },\n    placeholder: {\n        flex: 1,\n        alignItems: 'center',\n        justifyContent: 'center',\n        gap: 12,\n        padding: 24,\n        borderRadius: 16,\n        backgroundColor: '#fff',\n    },\n    placeholderText: {\n        fontSize: 16,\n        color: '#666',\n        textAlign: 'center',\n    },\n});\n","// hooks/useLazyMap.ts\n// ✅ ПРОИЗВОДИТЕЛЬНОСТЬ: Ленивая загрузка карт с Intersection Observer\n\nimport { useState, useEffect, useRef, useCallback } from 'react';\nimport { Platform } from 'react-native';\n\ninterface UseLazyMapOptions {\n    rootMargin?: string;\n    threshold?: number;\n    enabled?: boolean;\n}\n\n/**\n * Хук для ленивой загрузки карт\n * Загружает карту только когда она становится видимой в viewport\n */\nexport function useLazyMap(options: UseLazyMapOptions = {}) {\n    const {\n        rootMargin = '200px', // Начинаем загрузку за 200px до появления\n        threshold = 0.1,\n        enabled = true,\n    } = options;\n\n    const [shouldLoad, setShouldLoad] = useState(!enabled || Platform.OS !== 'web');\n    const [isLoading, setIsLoading] = useState(false);\n    const elementRef = useRef<HTMLElement | null>(null);\n\n    const handleIntersection = useCallback((entries: IntersectionObserverEntry[]) => {\n        entries.forEach((entry) => {\n            if (entry.isIntersecting && !shouldLoad) {\n                setIsLoading(true);\n                setShouldLoad(true);\n            }\n        });\n    }, [shouldLoad]);\n\n    useEffect(() => {\n        if (!enabled || Platform.OS !== 'web' || shouldLoad) {\n            return;\n        }\n\n        if (typeof window === 'undefined' || !('IntersectionObserver' in window)) {\n            // Fallback: загружаем сразу, если IntersectionObserver не поддерживается\n            setShouldLoad(true);\n            return;\n        }\n\n        const element = elementRef.current;\n        if (!element) {\n            return;\n        }\n\n        const observer = new IntersectionObserver(handleIntersection, {\n            rootMargin,\n            threshold,\n        });\n\n        observer.observe(element);\n\n        return () => {\n            observer.disconnect();\n        };\n    }, [enabled, shouldLoad, rootMargin, threshold, handleIntersection]);\n\n    // Callback для установки ref элемента\n    const setElementRef = useCallback((node: HTMLElement | null) => {\n        elementRef.current = node;\n    }, []);\n\n    return {\n        shouldLoad,\n        isLoading,\n        setElementRef,\n    };\n}\n\n/**\n * Компонент-обертка для ленивой загрузки карт\n * Использование:\n * \n * const { shouldLoad, setElementRef } = useLazyMap();\n * \n * return (\n *   <div ref={setElementRef}>\n *     {shouldLoad ? <MapComponent /> : <MapPlaceholder />}\n *   </div>\n * );\n */\n\n"],"x_facebook_sources":[[{"names":["<global>","Placeholder","MapPanel","<anonymous>","useEffect$argument_0","setWebMap$argument_0","useMemo$argument_0"],"mappings":"AAA;ACqB;CDO;0CEE;gECM,QD;4DCC,QD;cEmB;SDI;uCEG,iCF;SCM;eDE;SCE;KFC;+BIE,6BJ;CFuC"}],[{"names":["<global>","useLazyMap","handleIntersection","entries.forEach$argument_0","useEffect$argument_0","<anonymous>","setElementRef"],"mappings":"AAA;OCgB;2CCW;wBCC;SDK;KDC;cGE;eCuB;SDE;KHC;sCKG;KLE;CDO"}]],"names":["_react","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_interopRequireWildcard","_r","d","_View","_interopRequireDefault","_StyleSheet","_Text","_ActivityIndicator","_useLazyMap","_jsxRuntime","Placeholder","text","jsxs","style","styles","placeholder","children","jsx","size","placeholderText","MapPanel","travelsData","coordinates","routePoints","placesAlongRoute","mode","setRoutePoints","onMapClick","transportMode","setRouteDistance","setFullRouteCoords","radius","isWeb","shouldLoad","setElementRef","useLazyMap","rootMargin","threshold","enabled","WebMap","setWebMap","useState","loading","setLoading","useEffect","mounted","mod","paths","console","error","travelProp","useMemo","data","mapContainer","ref","travel","_e","React","memo","StyleSheet","create","flex","borderRadius","overflow","backgroundColor","alignItems","justifyContent","gap","padding","fontSize","color","textAlign","options","setShouldLoad","isLoading","setIsLoading","elementRef","useRef","handleIntersection","useCallback","entries","forEach","entry","isIntersecting","window","element","current","observer","IntersectionObserver","observe","disconnect","node"],"mappings":"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","debugId":"e45d3748-960f-4818-ad7d-ba18853f8a9c"}