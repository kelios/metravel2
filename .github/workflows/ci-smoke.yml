name: CI Smoke

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # Gating job: static analysis must pass for merge.
  # Always publishes a JSON artifact + markdown summary for fast diagnosis.
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run lint
        id: lint_run
        # Keep job alive to publish summary/artifact even when lint fails.
        continue-on-error: true
        run: yarn lint:ci

      - name: Publish lint summary
        if: always()
        run: node scripts/summarize-eslint.js test-results/eslint-results.json

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-results
          path: test-results/eslint-results.json
          if-no-files-found: ignore

      - name: Fail on lint errors
        if: steps.lint_run.outcome != 'success'
        run: exit 1

  smoke-critical:
    # Gating job: critical user-flow regressions for profile/export/subscriptions/travels API.
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run critical smoke tests
        run: yarn test:smoke:critical:ci

      - name: Publish smoke summary
        if: always()
        run: node scripts/summarize-jest-smoke.js test-results/jest-smoke-results.json

      - name: Upload smoke test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-smoke-results
          path: test-results/jest-smoke-results.json
          if-no-files-found: ignore

  quality-summary:
    # Non-gating aggregation job: provides one combined quality snapshot.
    # Runs even when upstream jobs fail and fails fast if expected artifacts are missing.
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint
      - smoke-critical

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download lint report
        uses: actions/download-artifact@v4
        with:
          name: eslint-results
          path: test-results/lint
          if-no-artifact-found: ignore

      - name: Download smoke report
        uses: actions/download-artifact@v4
        with:
          name: jest-smoke-results
          path: test-results/smoke
          if-no-artifact-found: ignore

      - name: Publish quality summary
        env:
          LINT_JOB_RESULT: ${{ needs.lint.result }}
          SMOKE_JOB_RESULT: ${{ needs.smoke-critical.result }}
          SMOKE_DURATION_BUDGET_SECONDS: "30"
          SMOKE_DURATION_PREVIOUS_SECONDS: ${{ vars.SMOKE_DURATION_PREVIOUS_SECONDS }}
          SMOKE_DURATION_BUDGET_STRICT: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: node scripts/summarize-quality-gate.js test-results/lint/eslint-results.json test-results/smoke/jest-smoke-results.json --fail-on-missing --json-output test-results/quality-summary.json

      - name: Upload quality summary snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary
          path: test-results/quality-summary.json
          if-no-files-found: ignore

      - name: Publish incident snippet (PR, when gate failed)
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success')
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          SMOKE_RESULT: ${{ needs.smoke-critical.result }}
        run: |
          FAILURE_CLASS=$(node -e 'const fs=require("fs");const p="test-results/quality-summary.json";if(fs.existsSync(p)){const o=JSON.parse(fs.readFileSync(p,"utf8"));process.stdout.write(String(o.failureClass||""));}')
          RECOMMENDATION_ID=$(node -e 'const fs=require("fs");const p="test-results/quality-summary.json";if(fs.existsSync(p)){const o=JSON.parse(fs.readFileSync(p,"utf8"));process.stdout.write(String(o.recommendationId||""));}')

          if [ -z "$FAILURE_CLASS" ]; then
            FAILURE_CLASS="mixed"
            if [ "$LINT_RESULT" != "success" ] && [ "$SMOKE_RESULT" = "success" ]; then
              FAILURE_CLASS="lint_only"
            elif [ "$LINT_RESULT" = "success" ] && [ "$SMOKE_RESULT" != "success" ]; then
              FAILURE_CLASS="smoke_only"
            fi
          fi

          if [ -z "$RECOMMENDATION_ID" ]; then
            RECOMMENDATION_ID="<from Quality Gate Summary>"
          fi

          node scripts/generate-ci-incident.js \
            --failure-class "$FAILURE_CLASS" \
            --recommendation-id "$RECOMMENDATION_ID" \
            --workflow-run "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --branch-pr "${{ github.event.pull_request.html_url }}" \
            --impact "<fill>" \
            --owner "<fill>" \
            --eta "<fill>" \
            --immediate-action "Initial triage started" \
            --follow-up "yes" >> "$GITHUB_STEP_SUMMARY"

      - name: Validate PR CI exception block
        if: always() && github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          REQUIRE_EXCEPTION: ${{ needs.lint.result != 'success' || needs.smoke-critical.result != 'success' }}
        run: node scripts/validate-pr-ci-exception.js
