name: CI Smoke

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  schema-contract-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Collect changed files
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: node scripts/collect-changed-files.js --base-sha "$BASE_SHA" --head-sha "$HEAD_SHA" --output-file changed_files.txt

      - name: Run selective schema contract checks
        run: node scripts/run-schema-contract-tests-if-needed.js --changed-files-file changed_files.txt

      - name: Capture schema selective decision snapshot
        if: always()
        run: |
          mkdir -p test-results
          node scripts/run-schema-contract-tests-if-needed.js --changed-files-file changed_files.txt --dry-run --json > test-results/schema-selective-decision.json

      - name: Validate schema selective decision snapshot
        if: always()
        run: node scripts/validate-selective-decision.js --file test-results/schema-selective-decision.json

      - name: Upload schema selective decision snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-selective-decision
          path: test-results/schema-selective-decision.json
          if-no-files-found: ignore

  validator-contract-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Collect changed files
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: node scripts/collect-changed-files.js --base-sha "$BASE_SHA" --head-sha "$HEAD_SHA" --output-file changed_files.txt

      - name: Run selective validator contract checks
        run: node scripts/run-validator-contract-tests-if-needed.js --changed-files-file changed_files.txt

      - name: Capture validator selective decision snapshot
        if: always()
        run: |
          mkdir -p test-results
          node scripts/run-validator-contract-tests-if-needed.js --changed-files-file changed_files.txt --dry-run --json > test-results/validator-selective-decision.json

      - name: Validate validator selective decision snapshot
        if: always()
        run: node scripts/validate-selective-decision.js --file test-results/validator-selective-decision.json

      - name: Upload validator selective decision snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validator-selective-decision
          path: test-results/validator-selective-decision.json
          if-no-files-found: ignore

  # Gating job: static analysis must pass for merge.
  # Always publishes a JSON artifact + markdown summary for fast diagnosis.
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run lint
        id: lint_run
        # Keep job alive to publish summary/artifact even when lint fails.
        continue-on-error: true
        run: yarn lint:ci

      - name: Publish lint summary
        if: always()
        run: node scripts/summarize-eslint.js test-results/eslint-results.json

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-results
          path: test-results/eslint-results.json
          if-no-files-found: ignore

      - name: Fail on lint errors
        if: steps.lint_run.outcome != 'success'
        run: exit 1

  smoke-critical:
    # Gating job: critical user-flow regressions for profile/export/subscriptions/travels API.
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run critical smoke tests
        run: yarn test:smoke:critical:ci

      - name: Publish smoke summary
        if: always()
        run: node scripts/summarize-jest-smoke.js test-results/jest-smoke-results.json

      - name: Upload smoke test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-smoke-results
          path: test-results/jest-smoke-results.json
          if-no-files-found: ignore

  quality-summary:
    # Non-gating aggregation job: provides one combined quality snapshot.
    # Runs even when upstream jobs fail and fails fast if expected artifacts are missing.
    runs-on: ubuntu-latest
    if: always()
    needs:
      - schema-contract-checks
      - validator-contract-checks
      - lint
      - smoke-critical

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect changed files (PR)
        if: github.event_name == 'pull_request'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: node scripts/collect-changed-files.js --base-sha "$BASE_SHA" --head-sha "$HEAD_SHA" --output-file changed_files.txt

      - name: Guard quality schema changes (PR)
        if: github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          CHANGED_FILES_CONTENT="$(cat changed_files.txt 2>/dev/null || true)"
          export CHANGED_FILES="$CHANGED_FILES_CONTENT"
          node scripts/guard-quality-schema-change.js

      - name: Guard validator contract changes (PR)
        if: github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          CHANGED_FILES_CONTENT="$(cat changed_files.txt 2>/dev/null || true)"
          export CHANGED_FILES="$CHANGED_FILES_CONTENT"
          node scripts/guard-validator-contract-change.js

      - name: Download lint report
        uses: actions/download-artifact@v4
        with:
          name: eslint-results
          path: test-results/lint
          if-no-artifact-found: ignore

      - name: Download smoke report
        uses: actions/download-artifact@v4
        with:
          name: jest-smoke-results
          path: test-results/smoke
          if-no-artifact-found: ignore

      - name: Download schema selective decision
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: schema-selective-decision
          path: test-results/selective/schema
          if-no-artifact-found: ignore

      - name: Download validator selective decision
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: validator-selective-decision
          path: test-results/selective/validator
          if-no-artifact-found: ignore

      - name: Validate downloaded selective decisions (PR)
        if: github.event_name == 'pull_request'
        run: |
          if [ -f test-results/selective/schema/schema-selective-decision.json ]; then
            node scripts/validate-selective-decision.js --file test-results/selective/schema/schema-selective-decision.json
          else
            echo "schema selective decision artifact is missing; summary will include warning"
          fi
          if [ -f test-results/selective/validator/validator-selective-decision.json ]; then
            node scripts/validate-selective-decision.js --file test-results/selective/validator/validator-selective-decision.json
          else
            echo "validator selective decision artifact is missing; summary will include warning"
          fi

      - name: Collect selective decisions aggregate (PR)
        if: github.event_name == 'pull_request'
        run: node scripts/collect-selective-decisions.js --schema-file test-results/selective/schema/schema-selective-decision.json --validator-file test-results/selective/validator/validator-selective-decision.json --output-file test-results/selective-decisions.json

      - name: Validate selective decisions aggregate (PR)
        if: github.event_name == 'pull_request'
        run: node scripts/validate-selective-decisions.js --file test-results/selective-decisions.json

      - name: Upload selective decisions aggregate (PR)
        id: selective_decisions_upload
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: selective-decisions
          path: test-results/selective-decisions.json
          if-no-files-found: ignore

      - name: Publish quality summary
        env:
          LINT_JOB_RESULT: ${{ needs.lint.result }}
          SMOKE_JOB_RESULT: ${{ needs.smoke-critical.result }}
          SMOKE_DURATION_BUDGET_SECONDS: "30"
          SMOKE_DURATION_PREVIOUS_SECONDS: ${{ vars.SMOKE_DURATION_PREVIOUS_SECONDS }}
          SMOKE_SUITE_FILES_BASELINE: ${{ vars.SMOKE_SUITE_FILES_BASELINE }}
          SMOKE_DURATION_BUDGET_STRICT: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          EXTRA_DECISION_ARGS=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            EXTRA_DECISION_ARGS="--selective-decisions-file test-results/selective-decisions.json"
          fi
          node scripts/summarize-quality-gate.js test-results/lint/eslint-results.json test-results/smoke/jest-smoke-results.json --fail-on-missing --json-output test-results/quality-summary.json $EXTRA_DECISION_ARGS

      - name: Validate quality summary snapshot
        if: always()
        run: node scripts/validate-quality-summary.js test-results/quality-summary.json

      - name: Extract quality failure class (PR)
        if: always() && github.event_name == 'pull_request'
        id: quality_failure_class
        run: |
          VALUE="$(node -e "const fs=require('fs');const p='test-results/quality-summary.json';try{const j=JSON.parse(fs.readFileSync(p,'utf8'));process.stdout.write(String(j.failureClass||''));}catch{process.stdout.write('');}")"
          echo "failure_class=$VALUE" >> "$GITHUB_OUTPUT"

      - name: Publish suite baseline recommendation
        if: always()
        run: node scripts/publish-smoke-suite-recommendation.js --summary-file test-results/quality-summary.json --output-file test-results/smoke-suite-baseline-recommendation.json --format json

      - name: Validate suite baseline recommendation
        if: always() && hashFiles('test-results/smoke-suite-baseline-recommendation.json') != ''
        run: node scripts/validate-smoke-suite-baseline-recommendation.js --file test-results/smoke-suite-baseline-recommendation.json

      - name: Upload smoke suite baseline recommendation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-suite-baseline-recommendation
          path: test-results/smoke-suite-baseline-recommendation.json
          if-no-files-found: ignore

      - name: Upload quality summary snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary
          path: test-results/quality-summary.json
          if-no-files-found: ignore

      - name: Publish incident snippet (PR, when gate failed)
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract')
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          SMOKE_RESULT: ${{ needs.smoke-critical.result }}
        run: |
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
          node scripts/publish-ci-incident-snippet.js --summary-file test-results/quality-summary.json --output-file test-results/ci-incident-snippet.md --workflow-run "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" --branch-pr "${{ github.event.pull_request.html_url }}" --impact "<fill>" --owner "<fill>" --eta "<fill>" --immediate-action "Initial triage started" --follow-up "yes" --artifact-url "$ARTIFACT_URL" --artifact-id "${{ steps.selective_decisions_upload.outputs.artifact-id }}" --json > test-results/ci-incident-payload.json

      - name: Validate incident snippet (PR, when gate failed)
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract')
        run: node scripts/validate-ci-incident-snippet.js --file test-results/ci-incident-snippet.md

      - name: Validate and summarize incident payload (PR, when gate failed)
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract')
        run: |
          set +e
          node scripts/validate-ci-incident-payload.js --file test-results/ci-incident-payload.json --json > test-results/ci-incident-payload-validation.json
          STATUS=$?
          set -e

          node scripts/summarize-ci-incident-payload-validation.js --file test-results/ci-incident-payload-validation.json

          if [ "$STATUS" -ne 0 ]; then
            exit "$STATUS"
          fi

      - name: Upload incident snippet artifact
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract')
        uses: actions/upload-artifact@v4
        with:
          name: ci-incident-snippet
          path: test-results/ci-incident-snippet.md
          if-no-files-found: ignore

      - name: Upload incident payload artifact
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract')
        uses: actions/upload-artifact@v4
        with:
          name: ci-incident-payload
          path: test-results/ci-incident-payload.json
          if-no-files-found: ignore

      - name: Validate PR CI exception block
        if: always() && github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          REQUIRE_EXCEPTION: ${{ needs.lint.result != 'success' || needs.smoke-critical.result != 'success' }}
        run: node scripts/validate-pr-ci-exception.js
