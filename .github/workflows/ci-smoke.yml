name: CI Smoke

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  schema-contract-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Collect changed files
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: node scripts/collect-changed-files.js --base-sha "$BASE_SHA" --head-sha "$HEAD_SHA" --output-file changed_files.txt

      - name: Run selective schema contract checks
        run: node scripts/run-schema-contract-tests-if-needed.js --changed-files-file changed_files.txt

      - name: Capture schema selective decision snapshot
        if: always()
        run: |
          mkdir -p test-results
          node scripts/run-schema-contract-tests-if-needed.js --changed-files-file changed_files.txt --dry-run --json > test-results/schema-selective-decision.json

      - name: Validate schema selective decision snapshot
        if: always()
        run: node scripts/validate-selective-decision.js --file test-results/schema-selective-decision.json

      - name: Upload schema selective decision snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-selective-decision
          path: test-results/schema-selective-decision.json
          if-no-files-found: ignore

  validator-contract-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Collect changed files
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: node scripts/collect-changed-files.js --base-sha "$BASE_SHA" --head-sha "$HEAD_SHA" --output-file changed_files.txt

      - name: Run selective validator contract checks
        run: node scripts/run-validator-contract-tests-if-needed.js --changed-files-file changed_files.txt

      - name: Capture validator selective decision snapshot
        if: always()
        run: |
          mkdir -p test-results
          node scripts/run-validator-contract-tests-if-needed.js --changed-files-file changed_files.txt --dry-run --json > test-results/validator-selective-decision.json

      - name: Validate validator selective decision snapshot
        if: always()
        run: node scripts/validate-selective-decision.js --file test-results/validator-selective-decision.json

      - name: Upload validator selective decision snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validator-selective-decision
          path: test-results/validator-selective-decision.json
          if-no-files-found: ignore

  runtime-config-diagnostics:
    # Early gate: validate critical runtime env configuration contract before lint/smoke.
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Validate runtime config diagnostics
        env:
          EXPO_PUBLIC_API_URL: ${{ vars.EXPO_PUBLIC_API_URL || 'https://example.test' }}
          EXPO_PUBLIC_ORS_API_KEY: ${{ vars.EXPO_PUBLIC_ORS_API_KEY || vars.ROUTE_SERVICE_KEY || 'ci-placeholder-routing-key' }}
        run: |
          mkdir -p test-results
          node scripts/runtime-config-diagnostics.js --json > test-results/runtime-config-diagnostics.json

      - name: Upload runtime config diagnostics report
        id: runtime_config_diagnostics_upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-config-diagnostics
          path: test-results/runtime-config-diagnostics.json
          if-no-files-found: ignore

  # Gating job: static analysis must pass for merge.
  # Always publishes a JSON artifact + markdown summary for fast diagnosis.
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run lint
        id: lint_run
        # Keep job alive to publish summary/artifact even when lint fails.
        continue-on-error: true
        run: yarn lint:ci

      - name: Publish lint summary
        if: always()
        run: node scripts/summarize-eslint.js test-results/eslint-results.json

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-results
          path: test-results/eslint-results.json
          if-no-files-found: ignore

      - name: Fail on lint errors
        if: steps.lint_run.outcome != 'success'
        run: exit 1

  smoke-critical:
    # Gating job: critical user-flow regressions for profile/export/subscriptions/travels API.
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run critical smoke tests
        run: yarn test:smoke:critical:ci

      - name: Publish smoke summary
        if: always()
        run: node scripts/summarize-jest-smoke.js test-results/jest-smoke-results.json

      - name: Upload smoke test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-smoke-results
          path: test-results/jest-smoke-results.json
          if-no-files-found: ignore

  quality-summary:
    # Non-gating aggregation job: provides one combined quality snapshot.
    # Runs even when upstream jobs fail and fails fast if expected artifacts are missing.
    runs-on: ubuntu-latest
    if: always()
    needs:
      - schema-contract-checks
      - validator-contract-checks
      - runtime-config-diagnostics
      - lint
      - smoke-critical

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect changed files (PR)
        if: github.event_name == 'pull_request'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: node scripts/collect-changed-files.js --base-sha "$BASE_SHA" --head-sha "$HEAD_SHA" --output-file changed_files.txt

      - name: Guard quality schema changes (PR)
        if: github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          CHANGED_FILES_CONTENT="$(cat changed_files.txt 2>/dev/null || true)"
          export CHANGED_FILES="$CHANGED_FILES_CONTENT"
          node scripts/guard-quality-schema-change.js

      - name: Guard validator contract changes (PR)
        if: github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          mkdir -p test-results
          CHANGED_FILES_CONTENT="$(cat changed_files.txt 2>/dev/null || true)"
          export CHANGED_FILES="$CHANGED_FILES_CONTENT"
          set +e
          node scripts/guard-validator-contract-change.js --json > test-results/validator-guard.json
          STATUS=$?
          set -e
          if [ "$STATUS" -ne 0 ]; then
            cat test-results/validator-guard.json
            exit "$STATUS"
          fi

      - name: Upload validator guard snapshot (PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: validator-guard
          path: test-results/validator-guard.json
          if-no-files-found: ignore

      - name: Publish validator guard summary (PR)
        if: always() && github.event_name == 'pull_request'
        run: node scripts/summarize-validator-guard.js --file test-results/validator-guard.json

      - name: Download lint report
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: eslint-results
          path: test-results/lint

      - name: Download runtime config diagnostics report
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: runtime-config-diagnostics
          path: test-results/runtime-config

      - name: Download smoke report
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: jest-smoke-results
          path: test-results/smoke

      - name: Download schema selective decision
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: schema-selective-decision
          path: test-results/selective/schema

      - name: Download validator selective decision
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: validator-selective-decision
          path: test-results/selective/validator

      - name: Validate downloaded selective decisions (PR)
        if: github.event_name == 'pull_request'
        run: |
          if [ -f test-results/selective/schema/schema-selective-decision.json ]; then
            node scripts/validate-selective-decision.js --file test-results/selective/schema/schema-selective-decision.json
          else
            echo "schema selective decision artifact is missing; summary will include warning"
          fi
          if [ -f test-results/selective/validator/validator-selective-decision.json ]; then
            node scripts/validate-selective-decision.js --file test-results/selective/validator/validator-selective-decision.json
          else
            echo "validator selective decision artifact is missing; summary will include warning"
          fi

      - name: Collect selective decisions aggregate (PR)
        if: github.event_name == 'pull_request'
        run: node scripts/collect-selective-decisions.js --schema-file test-results/selective/schema/schema-selective-decision.json --validator-file test-results/selective/validator/validator-selective-decision.json --output-file test-results/selective-decisions.json

      - name: Validate selective decisions aggregate (PR)
        if: github.event_name == 'pull_request'
        run: node scripts/validate-selective-decisions.js --file test-results/selective-decisions.json

      - name: Upload selective decisions aggregate (PR)
        id: selective_decisions_upload
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: selective-decisions
          path: test-results/selective-decisions.json
          if-no-files-found: ignore

      - name: Publish validator contracts aggregate summary (PR)
        if: always() && github.event_name == 'pull_request'
        run: |
          node scripts/summarize-validator-contracts.js --json-output test-results/validator-contracts-summary.json

      - name: Upload validator contracts aggregate summary snapshot (PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: validator-contracts-summary
          path: test-results/validator-contracts-summary.json
          if-no-files-found: ignore

      - name: Validate validator contracts aggregate summary (PR)
        if: always() && github.event_name == 'pull_request'
        run: |
          mkdir -p test-results
          set +e
          node scripts/validate-validator-contracts-summary.js --file test-results/validator-contracts-summary.json --json > test-results/validator-contracts-summary-validation.json
          STATUS=$?
          set -e
          node scripts/summarize-validator-contracts-summary-validation.js --file test-results/validator-contracts-summary-validation.json
          if [ "$STATUS" -ne 0 ]; then
            exit "$STATUS"
          fi

      - name: Upload validator contracts aggregate summary validation snapshot (PR)
        id: validator_contracts_summary_validation_upload
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: validator-contracts-summary-validation
          path: test-results/validator-contracts-summary-validation.json
          if-no-files-found: ignore

      - name: Publish quality summary
        env:
          LINT_JOB_RESULT: ${{ needs.lint.result }}
          SMOKE_JOB_RESULT: ${{ needs.smoke-critical.result }}
          SMOKE_DURATION_BUDGET_SECONDS: "30"
          SMOKE_DURATION_PREVIOUS_SECONDS: ${{ vars.SMOKE_DURATION_PREVIOUS_SECONDS }}
          SMOKE_SUITE_FILES_BASELINE: ${{ vars.SMOKE_SUITE_FILES_BASELINE }}
          SMOKE_DURATION_BUDGET_STRICT: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          EXTRA_DECISION_ARGS=""
          EXTRA_VALIDATOR_ARGS=""
          EXTRA_RUNTIME_ARGS="--runtime-config-diagnostics-file test-results/runtime-config/runtime-config-diagnostics.json"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            EXTRA_DECISION_ARGS="--selective-decisions-file test-results/selective-decisions.json"
            EXTRA_VALIDATOR_ARGS="--validator-contracts-summary-validation-file test-results/validator-contracts-summary-validation.json"
          fi
          node scripts/summarize-quality-gate.js test-results/lint/eslint-results.json test-results/smoke/jest-smoke-results.json --fail-on-missing --json-output test-results/quality-summary.json $EXTRA_RUNTIME_ARGS $EXTRA_DECISION_ARGS $EXTRA_VALIDATOR_ARGS

      - name: Validate quality summary snapshot
        if: always()
        run: node scripts/validate-quality-summary.js test-results/quality-summary.json

      - name: Validate CI smoke workflow contract
        if: always()
        env:
          CI_WORKFLOW_CONTRACT_SUMMARY_MAX_ITEMS: "5"
        run: |
          mkdir -p test-results
          set +e
          node scripts/validate-ci-smoke-workflow-contract.js --json > test-results/ci-smoke-workflow-contract-validation.json
          STATUS=$?
          set -e
          node scripts/summarize-ci-smoke-workflow-contract-validation.js --file test-results/ci-smoke-workflow-contract-validation.json --max-items "$CI_WORKFLOW_CONTRACT_SUMMARY_MAX_ITEMS"
          if [ "$STATUS" -ne 0 ]; then
            cat test-results/ci-smoke-workflow-contract-validation.json
            exit "$STATUS"
          fi

      - name: Upload CI smoke workflow contract validation snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-smoke-workflow-contract-validation
          path: test-results/ci-smoke-workflow-contract-validation.json
          if-no-files-found: ignore

      - name: Extract quality failure class (PR)
        if: always() && github.event_name == 'pull_request'
        id: quality_failure_class
        run: |
          VALUE="$(node -e "const fs=require('fs');const p='test-results/quality-summary.json';try{const j=JSON.parse(fs.readFileSync(p,'utf8'));process.stdout.write(String(j.failureClass||''));}catch{process.stdout.write('');}")"
          echo "failure_class=$VALUE" >> "$GITHUB_OUTPUT"

      - name: Publish suite baseline recommendation
        if: always()
        run: node scripts/publish-smoke-suite-recommendation.js --summary-file test-results/quality-summary.json --output-file test-results/smoke-suite-baseline-recommendation.json --format json

      - name: Validate suite baseline recommendation
        if: always() && hashFiles('test-results/smoke-suite-baseline-recommendation.json') != ''
        run: node scripts/validate-smoke-suite-baseline-recommendation.js --file test-results/smoke-suite-baseline-recommendation.json

      - name: Upload smoke suite baseline recommendation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-suite-baseline-recommendation
          path: test-results/smoke-suite-baseline-recommendation.json
          if-no-files-found: ignore

      - name: Upload quality summary snapshot
        id: quality_summary_upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary
          path: test-results/quality-summary.json
          if-no-files-found: ignore

      - name: Render validator guard comment preview (PR)
        if: always() && github.event_name == 'pull_request'
        run: |
          QUALITY_SUMMARY_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
          if [ -n "${{ steps.quality_summary_upload.outputs.artifact-id }}" ]; then
            QUALITY_SUMMARY_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.quality_summary_upload.outputs.artifact-id }}"
          fi
          node scripts/render-validator-guard-comment.js --file test-results/validator-guard.json --output-file test-results/validator-guard-comment.md --run-url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" --artifact-url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts" --quality-summary-url "$QUALITY_SUMMARY_URL" --json

      - name: Upload validator guard comment preview (PR)
        id: validator_guard_comment_upload
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: validator-guard-comment
          path: test-results/validator-guard-comment.md
          if-no-files-found: ignore

      - name: Render validator guard comment publish body (PR)
        if: always() && github.event_name == 'pull_request'
        run: |
          QUALITY_SUMMARY_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
          if [ -n "${{ steps.quality_summary_upload.outputs.artifact-id }}" ]; then
            QUALITY_SUMMARY_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.quality_summary_upload.outputs.artifact-id }}"
          fi
          COMMENT_ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
          if [ -n "${{ steps.validator_guard_comment_upload.outputs.artifact-id }}" ]; then
            COMMENT_ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.validator_guard_comment_upload.outputs.artifact-id }}"
          fi
          node scripts/render-validator-guard-comment.js --file test-results/validator-guard.json --output-file test-results/validator-guard-comment-publish.md --run-url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" --artifact-url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts" --quality-summary-url "$QUALITY_SUMMARY_URL" --comment-artifact-url "$COMMENT_ARTIFACT_URL" --json

      - name: Validate validator guard comment contract (PR)
        if: always() && github.event_name == 'pull_request'
        run: |
          mkdir -p test-results
          set +e
          node scripts/validate-validator-guard-comment.js --file test-results/validator-guard-comment-publish.md --json > test-results/validator-guard-comment-validation.json
          STATUS=$?
          set -e
          node scripts/summarize-validator-guard-comment-validation.js --file test-results/validator-guard-comment-validation.json
          if [ "$STATUS" -ne 0 ]; then
            exit "$STATUS"
          fi

      - name: Upload validator guard comment validation snapshot (PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: validator-guard-comment-validation
          path: test-results/validator-guard-comment-validation.json
          if-no-files-found: ignore

      - name: Validate validator error-codes docs table (PR)
        if: always() && github.event_name == 'pull_request'
        run: |
          mkdir -p test-results
          set +e
          node scripts/validate-validator-error-codes-doc-table.js --file docs/TESTING.md --json > test-results/validator-error-codes-doc-table-validation.json
          STATUS=$?
          set -e
          node scripts/summarize-validator-error-codes-doc-table-validation.js --file test-results/validator-error-codes-doc-table-validation.json
          if [ "$STATUS" -ne 0 ]; then
            exit "$STATUS"
          fi

      - name: Upload validator error-codes docs table validation snapshot (PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: validator-error-codes-doc-table-validation
          path: test-results/validator-error-codes-doc-table-validation.json
          if-no-files-found: ignore

      - name: Validate validator error-codes policy (PR)
        if: always() && github.event_name == 'pull_request'
        run: |
          mkdir -p test-results
          set +e
          node scripts/validate-validator-error-codes-policy.js --json > test-results/validator-error-codes-policy-validation.json
          STATUS=$?
          set -e
          node scripts/summarize-validator-error-codes-policy-validation.js --file test-results/validator-error-codes-policy-validation.json
          if [ "$STATUS" -ne 0 ]; then
            exit "$STATUS"
          fi

      - name: Upload validator error-codes policy validation snapshot (PR)
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: validator-error-codes-policy-validation
          path: test-results/validator-error-codes-policy-validation.json
          if-no-files-found: ignore

      - name: Publish/update validator guard PR comment
        if: always() && github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { buildFallbackComment } = require('./scripts/validator-guard-comment-template');
            const guardPath = 'test-results/validator-guard.json';
            if (!fs.existsSync(guardPath)) {
              core.info('validator-guard.json is missing; skipping PR comment lifecycle');
              return;
            }
            let guardPayload = null;
            try {
              guardPayload = JSON.parse(fs.readFileSync(guardPath, 'utf8'));
            } catch (error) {
              core.warning(`Failed to parse validator-guard.json: ${String(error)}`);
              return;
            }
            const isOk = Boolean(guardPayload?.ok);
            const marker = '<!-- validator-guard-comment -->';
            const previewPath = 'test-results/validator-guard-comment-publish.md';
            const fallbackBody = buildFallbackComment({
              runUrl: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              artifactUrl: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}#artifacts`,
            });
            const previewBody = fs.existsSync(previewPath)
              ? fs.readFileSync(previewPath, 'utf8')
              : fallbackBody;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment?.user?.type === 'Bot' &&
              String(comment?.body || '').includes(marker)
            );

            if (!isOk && existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: previewBody,
              });
              core.info(`Updated validator guard comment: ${existing.id}`);
              return;
            }

            if (!isOk && !existing) {
              const created = await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: previewBody,
              });
              core.info(`Created validator guard comment: ${created.data.id}`);
              return;
            }

            if (isOk && existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: previewBody,
              });
              core.info(`Resolved validator guard comment: ${existing.id}`);
              return;
            }

            core.info('Guard is passing and no managed comment exists; nothing to update.');

      - name: Publish incident snippet (PR, when gate failed)
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract' || steps.quality_failure_class.outputs.failure_class == 'validator_contract' || steps.quality_failure_class.outputs.failure_class == 'config_contract')
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          SMOKE_RESULT: ${{ needs.smoke-critical.result }}
        run: |
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
          node scripts/publish-ci-incident-snippet.js --summary-file test-results/quality-summary.json --output-file test-results/ci-incident-snippet.md --workflow-run "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" --branch-pr "${{ github.event.pull_request.html_url }}" --impact "<fill>" --owner "<fill>" --eta "<fill>" --immediate-action "Initial triage started" --follow-up "yes" --artifact-url "$ARTIFACT_URL" --artifact-id "${{ steps.selective_decisions_upload.outputs.artifact-id }}" --validator-artifact-url "$ARTIFACT_URL" --validator-artifact-id "${{ steps.validator_contracts_summary_validation_upload.outputs.artifact-id }}" --runtime-artifact-url "$ARTIFACT_URL" --json > test-results/ci-incident-payload.json

      - name: Validate incident snippet (PR, when gate failed)
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract' || steps.quality_failure_class.outputs.failure_class == 'validator_contract' || steps.quality_failure_class.outputs.failure_class == 'config_contract')
        run: node scripts/validate-ci-incident-snippet.js --file test-results/ci-incident-snippet.md

      - name: Validate and summarize incident payload (PR, when gate failed)
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract' || steps.quality_failure_class.outputs.failure_class == 'validator_contract' || steps.quality_failure_class.outputs.failure_class == 'config_contract')
        run: |
          set +e
          node scripts/validate-ci-incident-payload.js --file test-results/ci-incident-payload.json --json > test-results/ci-incident-payload-validation.json
          STATUS=$?
          set -e

          node scripts/summarize-ci-incident-payload-validation.js --file test-results/ci-incident-payload-validation.json

          if [ "$STATUS" -ne 0 ]; then
            exit "$STATUS"
          fi

      - name: Upload incident snippet artifact
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract' || steps.quality_failure_class.outputs.failure_class == 'validator_contract' || steps.quality_failure_class.outputs.failure_class == 'config_contract')
        uses: actions/upload-artifact@v4
        with:
          name: ci-incident-snippet
          path: test-results/ci-incident-snippet.md
          if-no-files-found: ignore

      - name: Upload incident payload artifact
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract' || steps.quality_failure_class.outputs.failure_class == 'validator_contract' || steps.quality_failure_class.outputs.failure_class == 'config_contract')
        uses: actions/upload-artifact@v4
        with:
          name: ci-incident-payload
          path: test-results/ci-incident-payload.json
          if-no-files-found: ignore

      - name: Upload incident payload validation artifact
        if: always() && github.event_name == 'pull_request' && (needs.lint.result != 'success' || needs.smoke-critical.result != 'success' || steps.quality_failure_class.outputs.failure_class == 'selective_contract' || steps.quality_failure_class.outputs.failure_class == 'validator_contract' || steps.quality_failure_class.outputs.failure_class == 'config_contract')
        uses: actions/upload-artifact@v4
        with:
          name: ci-incident-payload-validation
          path: test-results/ci-incident-payload-validation.json
          if-no-files-found: ignore

      - name: Validate PR CI exception block
        if: always() && github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          REQUIRE_EXCEPTION: ${{ needs.lint.result != 'success' || needs.smoke-critical.result != 'success' }}
        run: node scripts/validate-pr-ci-exception.js
