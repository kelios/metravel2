/* Leaflet overrides (web) — loaded only on map page via ensureLeafletCss().
   Extracted from global.css to avoid parsing ~250 lines of unused CSS on non-map pages. */

/* Keep overrides minimal to avoid conflicts with leaflet.css. */
.leaflet-container {
  background-color: var(--color-backgroundTertiary) !important;
  background-image: none !important;
}

/* ✅ FIX: Global img reset in app/+html.tsx breaks Leaflet tiles (tiles become scaled "cubes"). */
.leaflet-container .leaflet-tile-pane img,
.leaflet-container img.leaflet-tile,
.leaflet-container .leaflet-tile {
  width: auto !important;
  height: auto !important;
  max-width: none !important;
  max-height: none !important;
  object-fit: none !important;
}

.leaflet-container img.leaflet-marker-icon,
.leaflet-container img.leaflet-marker-shadow {
  max-width: none !important;
  max-height: none !important;
  object-fit: none !important;
}

/* ✅ FIX: Global svg reset in app/+html.tsx can break Leaflet SVG overlay scaling (route polyline). */
.leaflet-container svg {
  max-width: none !important;
  max-height: none !important;
}

.leaflet-control-container {
  contain: none !important;
}

[data-testid="map-container"],
[data-testid="map-leaflet-wrapper"] {
  contain: none !important;
}

/* Leaflet popup styling: make it look like an in-app card */
.leaflet-popup-content-wrapper {
  border-radius: 16px !important;
  background: var(--color-surface) !important;
  border: 1px solid var(--color-border) !important;
  box-shadow: var(--shadow-modal) !important;
}

.leaflet-popup-content {
  margin: 0 !important;
  padding: 14px !important;
  color: var(--color-text) !important;
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif !important;
  font-size: 14px !important;
  line-height: 20px !important;
  max-width: min(420px, calc(100vw - 32px)) !important;
}

.leaflet-popup {
  max-width: calc(100vw - 24px) !important;
}

/* Tooltip для маркеров старта/финиша маршрута */
.leaflet-tooltip.metravel-route-marker-tooltip {
  background: var(--color-surface) !important;
  border: 1px solid var(--color-border) !important;
  border-radius: 6px !important;
  box-shadow: var(--shadow-medium) !important;
  padding: 4px 8px !important;
  font-size: 11px !important;
  line-height: 16px !important;
  font-weight: 500 !important;
  color: var(--color-text) !important;
  white-space: nowrap !important;
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif !important;
}

.leaflet-tooltip.metravel-route-marker-tooltip::before {
  border-top-color: var(--color-border) !important;
}

/* Tooltip для маркеров мест на карте (hover) */
.leaflet-tooltip.metravel-marker-tooltip {
  background: var(--color-surface) !important;
  border: 1px solid var(--color-border) !important;
  border-radius: 8px !important;
  box-shadow: var(--shadow-medium) !important;
  padding: 4px 10px !important;
  font-size: 12px !important;
  line-height: 18px !important;
  font-weight: 600 !important;
  color: var(--color-text) !important;
  white-space: nowrap !important;
  max-width: 220px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif !important;
}

.leaflet-tooltip.metravel-marker-tooltip::before {
  border-top-color: var(--color-border) !important;
}

/* Старые стили попапа - оставляем для обратной совместимости */
.leaflet-popup.metravel-route-marker-popup {
  max-width: min(100px, calc(100vw - 48px)) !important;
}

.leaflet-popup.metravel-route-marker-popup .leaflet-popup-content-wrapper {
  border-radius: 999px !important;
  padding: 0 !important;
}

.leaflet-popup.metravel-route-marker-popup .leaflet-popup-content {
  max-width: min(80px, calc(100vw - 80px)) !important;
  padding: 4px 8px !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 11px !important;
  line-height: 16px !important;
  font-weight: 500 !important;
  text-align: center !important;
  margin: 0 !important;
}

.leaflet-popup.metravel-route-marker-popup .leaflet-popup-close-button {
  display: none !important;
}

.leaflet-popup-tip-container {
  /* Popup opens below-side of marker — hide the default top-pointing tip */
  display: none !important;
}

.leaflet-popup-tip {
  background: var(--color-surface) !important;
  border: 1px solid var(--color-border) !important;
  box-shadow: var(--shadow-medium) !important;
}

.leaflet-popup-close-button {
  width: 32px !important;
  height: 32px !important;
  border-radius: 999px !important;
  margin: 6px !important;
  color: var(--color-textMuted) !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.leaflet-popup-close-button:hover {
  background: var(--color-backgroundTertiary) !important;
  color: var(--color-text) !important;
}

/* Контролы карты (зум и т.д.) */
.leaflet-control {
  z-index: 800 !important;
}

.leaflet-control-attribution {
  z-index: 900 !important;
  margin-bottom: 4px !important;
  padding: 2px 6px !important;
  border-radius: 10px !important;
  font-size: 11px !important;
  line-height: 1.35 !important;
  color: var(--color-textMuted) !important;
  background: rgba(255, 255, 255, 0.88) !important;
}

html[data-theme="dark"] .leaflet-control-attribution {
  background: rgba(42, 42, 42, 0.88) !important;
}

.leaflet-control-attribution a {
  color: var(--color-textMuted) !important;
}

@media (min-width: 900px) {
  .leaflet-bottom.leaflet-right {
    right: 0 !important;
  }
}

/* Тултипы */
.leaflet-tooltip {
  z-index: 650 !important;
}

/* Mobile touch support for Leaflet */
@media (pointer: coarse) {
  /* Ensure markers have adequate touch targets (44px minimum) */
  .leaflet-marker-icon {
    min-width: 44px !important;
    min-height: 44px !important;
  }

  /* Larger close button on touch devices */
  .leaflet-popup-close-button {
    width: 44px !important;
    height: 44px !important;
    font-size: 24px !important;
  }

  /* Ensure popup content is scrollable on mobile */
  .leaflet-popup-content {
    max-height: 60vh !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    touch-action: pan-y !important;
  }

  /* Prevent tooltips from blocking marker taps on touch devices */
  .leaflet-tooltip {
    pointer-events: none !important;
  }
}

/* Ensure Leaflet interactive layers receive touch events */
.leaflet-marker-icon,
.leaflet-marker-shadow {
  touch-action: manipulation !important;
}

.leaflet-popup-pane {
  touch-action: auto !important;
}
