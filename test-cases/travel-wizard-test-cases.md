# Тест-кейсы: Создание и редактирование путешествия (Travel Wizard)

## Общая информация
- **Страница**: Визард создания/редактирования путешествия
- **URL**: `/travel/new` (создание), `/travel/[id]` (редактирование)
- **Компонент**: `app/(tabs)/travel/new.tsx`, `components/travel/UpsertTravel.tsx`
- **Приоритет**: P1 (Critical)
- **Требует авторизации**: Да

---

## TC-WIZARD-001: Доступ к визарду создания путешествия
**Приоритет**: P1  
**Предусловия**: Пользователь авторизован

### Шаги:
1. Авторизоваться
2. Перейти на `/travel/new` или кликнуть "Рассказать о путешествии"
3. Дождаться загрузки визарда

### Ожидаемый результат:
- Визард загружается без ошибок
- Отображается шаг 1 (основная информация)
- Skeleton/Loading показывается во время загрузки
- URL: `/travel/new`

### Проверки:
- [ ] Визард открывается
- [ ] Первый шаг отображается
- [ ] Нет ошибок в консоли

---

## TC-WIZARD-002: Попытка доступа без авторизации
**Приоритет**: P1  
**Предусловия**: Пользователь НЕ авторизован

### Шаги:
1. Открыть `/travel/new` без авторизации

### Ожидаемый результат:
- Редирект на `/login?redirect=/travel/new`
- Или сообщение: "Войдите, чтобы создать путешествие"
- Кнопка "Войти"

### Проверки:
- [ ] Защита работает
- [ ] Редирект корректен
- [ ] Сообщение понятное

---

## TC-WIZARD-003: Шаг 1 - Основная информация
**Приоритет**: P1  
**Предусловия**: Визард открыт

### Шаги:
1. Заполнить поля шага 1:
   - Название путешествия
   - Описание
   - Плюсы (опционально)
   - Минусы (опционально)
   - Рекомендации (опционально)
2. Кликнуть "Далее"

### Ожидаемый результат:
- Все поля доступны для ввода
- Название обязательно (валидация)
- Переход на шаг 2 после заполнения
- Данные сохраняются (черновик)

### Проверки:
- [ ] Поля рендерятся
- [ ] Валидация работает
- [ ] Переход на шаг 2
- [ ] Данные сохранены

---

## TC-WIZARD-004: Валидация названия путешествия
**Приоритет**: P1  
**Предусловия**: Шаг 1 визарда

### Шаги:
1. Попытаться перейти на следующий шаг с пустым названием
2. Ввести название < 3 символов
3. Ввести название > 200 символов

### Ожидаемый результат:
- Ошибка: "Название обязательно"
- Ошибка: "Минимум 3 символа"
- Ошибка: "Максимум 200 символов"
- Переход заблокирован до валидного ввода

### Проверки:
- [ ] Валидация срабатывает
- [ ] Сообщения понятны
- [ ] Переход блокируется

---

## TC-WIZARD-005: Шаг 2 - Загрузка изображений
**Приоритет**: P1  
**Предусловия**: Шаг 1 завершен

### Шаги:
1. Перейти на шаг 2
2. Загрузить главное изображение (обязательно)
3. Загрузить дополнительные изображения (галерея)
4. Кликнуть "Далее"

### Ожидаемый результат:
- Drag & drop или кнопка загрузки доступны
- Главное изображение обязательно
- Можно загрузить несколько изображений в галерею
- Preview загруженных изображений
- Можно удалить загруженные изображения

### Проверки:
- [ ] Загрузка работает
- [ ] Preview отображается
- [ ] Валидация главного изображения
- [ ] Переход на шаг 3

---

## TC-WIZARD-006: Валидация загрузки изображений
**Приоритет**: P1  
**Предусловия**: Шаг 2 визарда

### Шаги:
1. Попытаться загрузить файл > 10MB
2. Попытаться загрузить не изображение (PDF, TXT)
3. Попытаться загрузить неподдерживаемый формат (BMP)

### Ожидаемый результат:
- Ошибки валидации:
  - "Файл слишком большой (макс. 10MB)"
  - "Разрешены только изображения"
  - "Поддерживаются JPG, PNG, WebP"
- Загрузка блокируется

### Проверки:
- [ ] Валидация размера работает
- [ ] Валидация типа работает
- [ ] Сообщения понятны

---

## TC-WIZARD-007: Шаг 3 - Добавление точек маршрута
**Приоритет**: P1  
**Предусловия**: Шаг 2 завершен

### Шаги:
1. Перейти на шаг 3
2. Добавить точки маршрута:
   - Через поиск по адресу
   - Через клик на карте
   - Ручной ввод координат
3. Для каждой точки указать:
   - Название
   - Описание (опционально)
   - Координаты
4. Кликнуть "Далее"

### Ожидаемый результат:
- Карта отображается
- Можно добавлять точки разными способами
- Точки отображаются на карте маркерами
- Маршрут соединяет точки линией
- Можно изменить порядок точек (drag & drop)
- Можно удалить точку

### Проверки:
- [ ] Карта работает
- [ ] Добавление точек функционирует
- [ ] Маркеры отображаются
- [ ] Порядок можно изменить
- [ ] Переход на шаг 4

---

## TC-WIZARD-008: Поиск адреса для точки маршрута
**Приоритет**: P2  
**Предусловия**: Шаг 3, добавление точки

### Шаги:
1. Начать вводить адрес в поле поиска
2. Выбрать адрес из выпадающего списка (autocomplete)
3. Проверить автозаполнение координат

### Ожидаемый результат:
- Появляется список подсказок (Nominatim/Google Places)
- При выборе координаты заполняются автоматически
- Точка добавляется на карту

### Проверки:
- [ ] Autocomplete работает
- [ ] Координаты заполняются
- [ ] Точка на карте

---

## TC-WIZARD-009: Шаг 4 - Категории путешествия
**Приоритет**: P1  
**Предусловия**: Шаг 3 завершен

### Шаги:
1. Перейти на шаг 4
2. Выбрать категории путешествия (множественный выбор):
   - Природа
   - Замки и крепости
   - Музеи
   - и т.д.
3. Кликнуть "Далее"

### Ожидаемый результат:
- Отображается список доступных категорий
- Можно выбрать несколько категорий
- Минимум 1 категория обязательна
- Выбранные категории визуально выделены

### Проверки:
- [ ] Категории загружаются (API: `/api/getFiltersTravel/`)
- [ ] Множественный выбор работает
- [ ] Валидация минимум 1 категории
- [ ] Переход на шаг 5

---

## TC-WIZARD-010: Шаг 5 - Дополнительные параметры
**Приоритет**: P1  
**Предусловия**: Шаг 4 завершен

### Шаги:
1. Перейти на шаг 5
2. Заполнить параметры:
   - Страна (обязательно)
   - Месяц поездки
   - Год
   - Количество дней
   - Количество ночевок
   - Транспорт
   - Компания (один/с семьей/с друзьями)
   - Сложность (легкий/средний/сложный)
   - YouTube ссылка (опционально)
3. Кликнуть "Далее" или "Опубликовать"

### Ожидаемый результат:
- Все фильтры доступны для выбора
- Данные загружаются из API `/api/getFiltersTravel/`
- Страна обязательна
- Остальные поля опциональны
- Можно сохранить как черновик или опубликовать

### Проверки:
- [ ] Фильтры загружаются
- [ ] Выбор работает
- [ ] Валидация страны
- [ ] Сохранение работает

---

## TC-WIZARD-011: Сохранение черновика
**Приоритет**: P1  
**Предусловия**: Любой шаг визарда

### Шаги:
1. Заполнить часть полей
2. Найти кнопку "Сохранить черновик"
3. Кликнуть
4. Закрыть визард
5. Вернуться позже

### Ожидаемый результат:
- Кнопка "Сохранить черновик" доступна на каждом шаге
- API запрос: `PUT /api/travels/upsert/` с `publish: false`
- Toast: "Черновик сохранен"
- При возврате данные восстанавливаются
- Черновик виден в профиле

### Проверки:
- [ ] Черновик сохраняется
- [ ] API запрос успешен
- [ ] Данные восстанавливаются
- [ ] Виден в профиле

---

## TC-WIZARD-012: Автосохранение черновика
**Приоритет**: P2  
**Предусловия**: Визард открыт, есть несохраненные изменения

### Шаги:
1. Заполнить поля
2. Подождать 30 секунд (или другой интервал автосохранения)
3. Проверить индикатор автосохранения

### Ожидаемый результат:
- Автосохранение срабатывает через интервал
- Показывается индикатор "Сохранение..." → "Сохранено"
- Данные сохраняются в localStorage или на сервере

### Проверки:
- [ ] Автосохранение работает
- [ ] Индикатор отображается
- [ ] Данные сохранены

---

## TC-WIZARD-013: Публикация путешествия
**Приоритет**: P1  
**Предусловия**: Все обязательные поля заполнены

### Шаги:
1. Завершить все шаги
2. Кликнуть "Опубликовать"
3. Подтвердить публикацию (если требуется)

### Ожидаемый результат:
- API запрос: `PUT /api/travels/upsert/` с `publish: true, moderation: 0`
- Toast: "Путешествие опубликовано"
- Переход на детальную страницу путешествия
- Путешествие видно в профиле с статусом "На модерации"

### Проверки:
- [ ] Публикация работает
- [ ] Редирект на детальную страницу
- [ ] Статус корректен
- [ ] Путешествие видно

---

## TC-WIZARD-014: Валидация перед публикацией
**Приоритет**: P1  
**Предусловия**: Не все обязательные поля заполнены

### Шаги:
1. Попытаться опубликовать с пропущенными полями:
   - Без названия
   - Без главного изображения
   - Без категории
   - Без страны

### Ожидаемый результат:
- Появляются ошибки валидации
- Список пропущенных обязательных полей
- Возможность перейти к проблемным шагам
- Публикация заблокирована

### Проверки:
- [ ] Валидация срабатывает
- [ ] Ошибки понятны
- [ ] Навигация к ошибкам работает

---

## TC-WIZARD-015: Редактирование опубликованного путешествия
**Приоритет**: P1  
**Предусловия**: Пользователь - автор путешествия

### Шаги:
1. Открыть свое опубликованное путешествие
2. Кликнуть "Редактировать"
3. Перейти в визард редактирования

### Ожидаемый результат:
- URL: `/travel/[id]`
- Визард открывается с загруженными данными
- Все поля заполнены текущими значениями
- Можно редактировать любые поля
- Кнопка "Сохранить изменения"

### Проверки:
- [ ] Визард открывается
- [ ] Данные загружены
- [ ] Редактирование работает
- [ ] Сохранение работает

---

## TC-WIZARD-016: Загрузка данных для редактирования
**Приоритет**: P1  
**Предусловия**: Открыт визард редактирования

### Шаги:
1. Открыть `/travel/[id]` для редактирования
2. Проверить загрузку данных

### Ожидаемый результат:
- API запрос: `GET /api/travels/{id}/`
- Все данные заполняются в форму:
  - Текстовые поля
  - Изображения (галерея)
  - Точки маршрута на карте
  - Выбранные категории
  - Фильтры
- Skeleton показывается во время загрузки

### Проверки:
- [ ] Данные загружаются
- [ ] Все поля заполнены
- [ ] Изображения отображаются
- [ ] Точки на карте

---

## TC-WIZARD-017: Удаление изображений при редактировании
**Приоритет**: P2  
**Предусловия**: Редактирование путешествия с изображениями

### Шаги:
1. Открыть визард редактирования
2. Перейти на шаг с изображениями
3. Удалить изображение из галереи
4. Сохранить

### Ожидаемый результат:
- Изображение удаляется из preview
- При сохранении изображение удаляется с сервера
- Остальные изображения остаются

### Проверки:
- [ ] Удаление работает
- [ ] UI обновляется
- [ ] Изменения сохраняются

---

## TC-WIZARD-018: Изменение порядка изображений
**Приоритет**: P3  
**Предусловия**: Несколько изображений в галерее

### Шаги:
1. Перетащить изображение (drag & drop)
2. Изменить порядок
3. Сохранить

### Ожидаемый результат:
- Порядок изменяется в UI
- Порядок сохраняется в базе
- Первое изображение - главное

### Проверки:
- [ ] Drag & drop работает
- [ ] Порядок сохраняется

---

## TC-WIZARD-019: Навигация между шагами визарда
**Приоритет**: P2  
**Предусловия**: Визард открыт

### Шаги:
1. Заполнить шаг 1 и перейти на шаг 2
2. Вернуться на шаг 1 кнопкой "Назад"
3. Использовать индикатор шагов (stepper) для перехода

### Ожидаемый результат:
- Кнопка "Назад" возвращает на предыдущий шаг
- Кнопка "Далее" переводит на следующий шаг
- Индикатор шагов показывает текущий шаг
- Можно переходить к пройденным шагам через индикатор
- Нельзя перейти к непройденным шагам

### Проверки:
- [ ] Навигация работает
- [ ] Данные сохраняются при переходах
- [ ] Индикатор корректен

---

## TC-WIZARD-020: Выход из визарда без сохранения
**Приоритет**: P2  
**Предусловия**: Визард открыт, есть несохраненные изменения

### Шаги:
1. Заполнить поля
2. Попытаться закрыть визард (крестик или Browser Back)

### Ожидаемый результат:
- Появляется модальное окно предупреждения
- Сообщение: "У вас есть несохраненные изменения. Сохранить черновик?"
- Варианты: "Сохранить черновик" / "Выйти без сохранения" / "Отмена"

### Проверки:
- [ ] Предупреждение показывается
- [ ] "Сохранить" работает
- [ ] "Выйти" закрывает визард
- [ ] "Отмена" возвращает в визард

---

## TC-WIZARD-021: Восстановление черновика после выхода
**Приоритет**: P2  
**Предусловия**: Сохранен черновик

### Шаги:
1. Сохранить черновик
2. Закрыть визард
3. Вернуться на страницу создания путешествия

### Ожидаемый результат:
- Появляется баннер: "У вас есть несохраненный черновик. Продолжить?"
- Кнопки: "Продолжить" / "Начать заново"
- При выборе "Продолжить" данные восстанавливаются

### Проверки:
- [ ] Баннер отображается
- [ ] Восстановление работает
- [ ] "Начать заново" очищает данные

---

## TC-WIZARD-022: Валидация координат точек маршрута
**Приоритет**: P2  
**Предусловия**: Шаг 3, ручной ввод координат

### Шаги:
1. Ввести невалидные координаты
2. Попытаться добавить точку

### Ожидаемый результат:
- Валидация координат:
  - Широта: -90 до 90
  - Долгота: -180 до 180
- Ошибки отображаются
- Добавление блокируется

### Проверки:
- [ ] Валидация работает
- [ ] Сообщения понятны

---

## TC-WIZARD-023: Валидация YouTube ссылки
**Приоритет**: P3  
**Предусловия**: Шаг 5, поле YouTube ссылки

### Шаги:
1. Ввести невалидную YouTube ссылку
2. Ввести валидную ссылку
3. Проверить preview

### Ожидаемый результат:
- Валидация формата YouTube URL
- Поддержка форматов:
  - `https://www.youtube.com/watch?v=ID`
  - `https://youtu.be/ID`
- Preview видео показывается (опционально)

### Проверки:
- [ ] Валидация работает
- [ ] Оба формата поддерживаются
- [ ] Preview отображается

---

## TC-WIZARD-024: Мобильная версия визарда
**Приоритет**: P1  
**Предусловия**: Мобильный viewport

### Шаги:
1. Открыть визард на мобильном устройстве
2. Пройти все шаги

### Ожидаемый результат:
- Все шаги адаптированы под мобильный экран
- Карта работает с touch gestures
- Загрузка изображений доступна (камера/галерея)
- Навигация удобна
- Клавиатура не перекрывает поля

### Проверки:
- [ ] Layout адаптирован
- [ ] Функционал работает
- [ ] Touch interactions корректны

---

## TC-WIZARD-025: Обработка ошибки API при сохранении
**Приоритет**: P1  
**Предусловия**: API недоступен или возвращает ошибку

### Шаги:
1. Заполнить визард
2. Попытаться сохранить при недоступном API

### Ожидаемый результат:
- Отображается сообщение об ошибке
- Данные сохраняются локально (localStorage)
- Кнопка "Повторить"
- Можно продолжить редактирование

### Проверки:
- [ ] Error handling работает
- [ ] Данные не теряются
- [ ] Retry доступен

---

## TC-WIZARD-026: Множественные категории для точек маршрута
**Приоритет**: P3  
**Предусловия**: Шаг 3, добавление точки

### Шаги:
1. Добавить точку маршрута
2. Указать категорию точки (музей, замок, природа)

### Ожидаемый результат:
- Можно выбрать категорию для каждой точки
- Категории: `categoryTravelAddress` из API
- Категория отображается на маркере (иконка)

### Проверки:
- [ ] Выбор категории доступен
- [ ] Иконки соответствуют категориям

---

## TC-WIZARD-027: Удаление путешествия из визарда
**Приоритет**: P2  
**Предусловия**: Редактирование существующего путешествия

### Шаги:
1. Открыть визард редактирования
2. Найти кнопку "Удалить путешествие"
3. Кликнуть
4. Подтвердить удаление

### Ожидаемый результат:
- Модальное окно подтверждения
- Предупреждение о безвозвратном удалении
- API запрос на удаление
- Редирект на профиль или главную
- Toast: "Путешествие удалено"

### Проверки:
- [ ] Подтверждение запрашивается
- [ ] Удаление работает
- [ ] Редирект корректен

---

## TC-WIZARD-028: Импорт маршрута из GPX
**Приоритет**: P3  
**Предусловия**: Шаг 3, есть функция импорта

### Шаги:
1. Найти кнопку "Импортировать маршрут"
2. Выбрать GPX файл
3. Подтвердить импорт

### Ожидаемый результат:
- GPX парсится
- Точки маршрута добавляются автоматически
- Маршрут отображается на карте
- Можно редактировать импортированные точки

### Проверки:
- [ ] Импорт работает
- [ ] Точки добавлены
- [ ] Редактирование доступно

---

## TC-WIZARD-029: Предпросмотр путешествия
**Приоритет**: P3  
**Предусловия**: Визард заполнен

### Шаги:
1. Найти кнопку "Предпросмотр"
2. Кликнуть

### Ожидаемый результат:
- Открывается модальное окно или новая вкладка
- Показывается превью как будет выглядеть опубликованное путешествие
- Можно вернуться к редактированию

### Проверки:
- [ ] Предпросмотр работает
- [ ] Отображение корректно
- [ ] Возврат работает

---

## TC-WIZARD-030: Accessibility (a11y) визарда
**Приоритет**: P2  
**Предусловия**: Keyboard navigation

### Шаги:
1. Использовать Tab для навигации по визарду
2. Заполнить форму с клавиатуры
3. Переключаться между шагами с клавиатуры

### Ожидаемый результат:
- Все поля доступны через Tab
- Кнопки активируются Enter/Space
- Focus visible
- Screen reader озвучивает шаги и поля
- ARIA labels присутствуют

### Проверки:
- [ ] Keyboard navigation работает
- [ ] Focus management корректен
- [ ] ARIA attributes присутствуют

---

## Покрытие автоматизацией

### Jest unit tests:
- Логика визарда (шаги, валидация)
- Нормализация категорий
- Обработка фильтров
- Создание и редактирование flow

Файлы:
- `__tests__/components/travel/UpsertTravel.createEditFlow.test.tsx`
- `__tests__/components/travel/UpsertTravel.categories.test.tsx`
- `__tests__/components/travel/UpsertTravel.filtersCategories.test.tsx`
- `__tests__/components/travel/UpsertTravel.step5FiltersRace.test.tsx`
- `__tests__/components/travel/UpsertTravel.authReady.test.tsx`

### Playwright E2E:
- Полный flow создания путешествия
- Сохранение черновика
- Редактирование
- Валидация

Существующий:
- `e2e/travel-wizard.spec.ts`
- `e2e/travel-wizard-features.spec.ts`

### Связанные файлы:
- `app/(tabs)/travel/new.tsx`
- `app/(tabs)/travel/[id].tsx`
- `components/travel/UpsertTravel.tsx`
- `api/travelsApi.ts` (upsert endpoint)
