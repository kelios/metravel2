# Тест-кейсы: Экспорт путешествий в PDF (/export)

## Общая информация
- **Страница**: Экспорт в PDF
- **URL**: `/export`
- **Компонент**: `app/(tabs)/export.tsx`
- **Приоритет**: P2 (High)
- **Требует авторизации**: Да

---

## TC-EXPORT-001: Загрузка страницы экспорта
**Приоритет**: P2  
**Предусловия**: Пользователь авторизован, есть опубликованные путешествия

### Шаги:
1. Авторизоваться
2. Открыть URL `/export`
3. Дождаться загрузки страницы

### Ожидаемый результат:
- Страница загружается без ошибок
- Отображается список своих путешествий (опубликованные + черновики)
- API запрос: `GET /api/user/{id}/travels/` с `includeDrafts: true`
- Checkbox для выбора путешествий
- Кнопка "Экспортировать в PDF"

### Проверки:
- [ ] Страница отображается
- [ ] Список загружен
- [ ] Checkbox видны
- [ ] Кнопка экспорта доступна

---

## TC-EXPORT-002: Попытка доступа без авторизации
**Приоритет**: P1  
**Предусловия**: Пользователь НЕ авторизован

### Шаги:
1. Открыть `/export` без авторизации

### Ожидаемый результат:
- Отображается empty state:
  - Иконка замка
  - Сообщение: "Войдите, чтобы собрать PDF‑книгу"
  - Описание: "Экспорт в PDF доступен после авторизации"
  - Кнопка "Войти" → редирект на `/login?redirect=/export`

### Проверки:
- [ ] Empty state отображается
- [ ] Сообщение понятное
- [ ] Кнопка "Войти" работает

---

## TC-EXPORT-003: Пустой список путешествий
**Приоритет**: P2  
**Предусловия**: Пользователь авторизован, но нет путешествий

### Шаги:
1. Открыть `/export` с пустым списком путешествий

### Ожидаемый результат:
- Отображается empty state:
  - Иконка или иллюстрация
  - Сообщение: "У вас пока нет путешествий"
  - Описание: "Создайте путешествие, чтобы экспортировать его в PDF"
  - Кнопка "Создать путешествие" → `/travel/new`

### Проверки:
- [ ] Empty state отображается
- [ ] Сообщение понятное
- [ ] Кнопка работает

---

## TC-EXPORT-004: Выбор путешествий для экспорта
**Приоритет**: P1  
**Предусловия**: Есть путешествия в списке

### Шаги:
1. Отметить checkbox для одного или нескольких путешествий
2. Проверить счетчик выбранных путешествий

### Ожидаемый результат:
- Checkbox работают
- Выбранные путешествия визуально выделены
- Счетчик показывает количество: "Выбрано: X из Y"
- Кнопка "Экспортировать" активна только при выборе

### Проверки:
- [ ] Checkbox работают
- [ ] Счетчик обновляется
- [ ] Визуальное выделение
- [ ] Кнопка активна/неактивна

---

## TC-EXPORT-005: "Выбрать все" путешествия
**Приоритет**: P2  
**Предусловия**: Несколько путешествий в списке

### Шаги:
1. Найти checkbox "Выбрать все"
2. Кликнуть
3. Проверить состояние всех checkbox

### Ожидаемый результат:
- Все путешествия выбираются
- Все checkbox отмечены
- Счетчик показывает: "Выбрано: Y из Y"
- Повторный клик снимает выбор со всех

### Проверки:
- [ ] "Выбрать все" работает
- [ ] Все checkbox отмечены
- [ ] Снятие выбора работает

---

## TC-EXPORT-006: Выбор настроек PDF экспорта
**Приоритет**: P2  
**Предусловия**: Путешествия выбраны

### Шаги:
1. Кликнуть "Настройки экспорта" (если доступны)
2. Выбрать параметры:
   - Формат страницы (A4 / Letter)
   - Ориентация (Портрет / Альбом)
   - Тема оформления (Classic / Modern / Minimal)
   - Включить карты (да/нет)
   - Включить галерею (да/нет)

### Ожидаемый результат:
- Настройки отображаются в модальном окне
- Можно выбрать параметры
- Сохранение настроек

### Проверки:
- [ ] Настройки доступны
- [ ] Выбор работает
- [ ] Настройки сохраняются

---

## TC-EXPORT-007: Запуск экспорта в PDF
**Приоритет**: P1  
**Предусловия**: Путешествия выбраны

### Шаги:
1. Выбрать одно или несколько путешествий
2. Кликнуть "Экспортировать в PDF"
3. Дождаться генерации

### Ожидаемый результат:
- Показывается индикатор прогресса
- Сообщение: "Генерация PDF..." с процентами (если доступно)
- После завершения скачивание начинается автоматически
- Имя файла: `metravel-export-{date}.pdf`
- Toast: "PDF готов к скачиванию"

### Проверки:
- [ ] Генерация запускается
- [ ] Индикатор прогресса виден
- [ ] Скачивание начинается
- [ ] Имя файла корректно

---

## TC-EXPORT-008: Содержимое экспортированного PDF
**Приоритет**: P1  
**Предусловия**: PDF сгенерирован и скачан

### Шаги:
1. Открыть скачанный PDF
2. Проверить содержимое

### Ожидаемый результат:
PDF содержит:
- Обложка с названием "Мои путешествия | Metravel"
- Оглавление (Table of Contents) с ссылками на путешествия
- Для каждого путешествия:
  - Название
  - Главное изображение
  - Описание
  - Плюсы, минусы, рекомендации
  - Галерея изображений
  - Карта маршрута (скриншот)
  - Список точек маршрута с координатами
  - Метаданные (страна, месяц, транспорт, сложность)
- Футер с номерами страниц

### Проверки:
- [ ] Все разделы присутствуют
- [ ] Изображения качественные
- [ ] Карты отображаются
- [ ] Форматирование корректно
- [ ] Ссылки в оглавлении работают

---

## TC-EXPORT-009: Экспорт одного путешествия
**Приоритет**: P2  
**Предусловия**: Выбрано 1 путешествие

### Шаги:
1. Выбрать одно путешествие
2. Экспортировать в PDF

### Ожидаемый результат:
- PDF содержит только выбранное путешествие
- Обложка и оглавление присутствуют
- Имя файла: `metravel-{travel-name}-{date}.pdf`

### Проверки:
- [ ] PDF содержит 1 путешествие
- [ ] Имя файла корректно

---

## TC-EXPORT-010: Экспорт множества путешествий
**Приоритет**: P2  
**Предусловия**: Выбрано 5+ путешествий

### Шаги:
1. Выбрать несколько путешествий
2. Экспортировать в PDF

### Ожидаемый результат:
- PDF содержит все выбранные путешествия
- Оглавление с полным списком
- Каждое путешествие на отдельных страницах
- Разделители между путешествиями

### Проверки:
- [ ] Все путешествия в PDF
- [ ] Оглавление полное
- [ ] Структура логична

---

## TC-EXPORT-011: Обработка путешествий без изображений
**Приоритет**: P2  
**Предусловия**: Путешествие без галереи

### Шаги:
1. Выбрать путешествие без изображений
2. Экспортировать

### Ожидаемый результат:
- PDF генерируется без ошибок
- Вместо изображений показывается placeholder или раздел пропускается
- Остальные разделы присутствуют

### Проверки:
- [ ] Экспорт работает
- [ ] Placeholder корректен
- [ ] Структура не нарушена

---

## TC-EXPORT-012: Обработка путешествий без карты
**Приоритет**: P2  
**Предусловия**: Путешествие без точек маршрута

### Шаги:
1. Выбрать путешествие без координат
2. Экспортировать

### Ожидаемый результат:
- PDF генерируется
- Раздел карты пропускается или показывается сообщение
- Остальные разделы присутствуют

### Проверки:
- [ ] Экспорт работает
- [ ] Нет ошибок генерации карты

---

## TC-EXPORT-013: Прогресс-бар при генерации PDF
**Приоритет**: P2  
**Предусловия**: Экспорт множества путешествий

### Шаги:
1. Выбрать 5+ путешествий с изображениями
2. Запустить экспорт
3. Наблюдать прогресс-бар

### Ожидаемый результат:
- Прогресс-бар отображается: 0% → 100%
- Показывается текущий этап:
  - "Подготовка данных..."
  - "Генерация страниц..."
  - "Обработка изображений..."
  - "Создание PDF..."
- Можно отменить процесс

### Проверки:
- [ ] Прогресс-бар виден
- [ ] Этапы понятны
- [ ] Отмена работает

---

## TC-EXPORT-014: Отмена генерации PDF
**Приоритет**: P3  
**Предусловия**: Генерация в процессе

### Шаги:
1. Запустить экспорт
2. Кликнуть "Отмена" во время генерации

### Ожидаемый результат:
- Процесс останавливается
- Частичный PDF не скачивается
- Toast: "Экспорт отменен"
- Можно запустить снова

### Проверки:
- [ ] Отмена работает
- [ ] Процесс останавливается

---

## TC-EXPORT-015: Обработка ошибки генерации PDF
**Приоритет**: P1  
**Предусловия**: Ошибка при генерации (недоступные изображения, большой размер)

### Шаги:
1. Попытаться экспортировать с проблемными данными

### Ожидаемый результат:
- Отображается сообщение об ошибке
- Описание проблемы: "Не удалось загрузить изображения" или "Превышен размер"
- Кнопка "Повторить"
- Предложение экспортировать без проблемных элементов

### Проверки:
- [ ] Error handling работает
- [ ] Сообщение понятное
- [ ] Retry доступен

---

## TC-EXPORT-016: Фильтрация списка путешествий
**Приоритет**: P3  
**Предусловия**: Много путешествий в списке

### Шаги:
1. Использовать фильтры для сужения списка:
   - По статусу (Опубликовано / Черновик / На модерации)
   - По стране
   - По дате создания

### Ожидаемый результат:
- Фильтры применяются
- Список обновляется
- Счетчик путешествий обновляется

### Проверки:
- [ ] Фильтры работают
- [ ] Список обновляется

---

## TC-EXPORT-017: Поиск по названию в списке экспорта
**Приоритет**: P3  
**Предусловия**: Несколько путешествий

### Шаги:
1. Ввести название путешествия в поле поиска
2. Проверить фильтрацию

### Ожидаемый результат:
- Список фильтруется по запросу
- Отображаются только соответствующие путешествия

### Проверки:
- [ ] Поиск работает
- [ ] Результаты релевантны

---

## TC-EXPORT-018: Предпросмотр PDF перед скачиванием
**Приоритет**: P3  
**Предусловия**: PDF сгенерирован

### Шаги:
1. После генерации найти кнопку "Предпросмотр"
2. Кликнуть

### Ожидаемый результат:
- PDF открывается в новой вкладке или iframe
- Можно пролистать страницы
- Кнопка "Скачать" доступна

### Проверки:
- [ ] Предпросмотр работает
- [ ] PDF отображается корректно
- [ ] Скачивание работает

---

## TC-EXPORT-019: Настройка темы оформления PDF
**Приоритет**: P3  
**Предусловия**: Доступны несколько тем

### Шаги:
1. Открыть настройки экспорта
2. Выбрать тему: Classic / Modern / Minimal
3. Экспортировать

### Ожидаемый результат:
- PDF генерируется с выбранной темой
- Стиль оформления соответствует теме:
  - **Classic**: традиционное оформление, серифы
  - **Modern**: современное, sans-serif, яркие акценты
  - **Minimal**: минималистичное, много белого пространства

### Проверки:
- [ ] Темы доступны
- [ ] Оформление соответствует
- [ ] Все темы работают

---

## TC-EXPORT-020: Включение/исключение разделов в PDF
**Приоритет**: P3  
**Предусловия**: Настройки экспорта

### Шаги:
1. В настройках выключить:
   - Галерею изображений
   - Карты
   - Метаданные
2. Экспортировать

### Ожидаемый результат:
- PDF генерируется без выключенных разделов
- Остальные разделы присутствуют
- Структура остается логичной

### Проверки:
- [ ] Исключение работает
- [ ] Структура корректна

---

## TC-EXPORT-021: Мобильная версия страницы экспорта
**Приоритет**: P2  
**Предусловия**: Мобильный viewport

### Шаги:
1. Открыть `/export` на мобильном
2. Выбрать путешествия
3. Экспортировать

### Ожидаемый результат:
- Список адаптирован
- Checkbox доступны
- Кнопки удобны для клика
- Процесс генерации работает

### Проверки:
- [ ] Layout адаптирован
- [ ] Функционал работает
- [ ] Скачивание на мобильном работает

---

## TC-EXPORT-022: SEO метатеги страницы экспорта
**Приоритет**: P3  
**Предусловия**: Доступ к исходному коду

### Шаги:
1. Открыть /export
2. Проверить метатеги

### Ожидаемый результат:
```html
<title>Экспорт в pdf | Metravel</title>
<meta name="description" content="Экспорт ваших путешествий..." />
<link rel="canonical" href="https://metravel.by/export" />
<meta name="robots" content="noindex, nofollow" />
```

### Проверки:
- [ ] Title корректен
- [ ] noindex установлен (приватная страница)

---

## TC-EXPORT-023: Сохранение настроек экспорта
**Приоритет**: P3  
**Предусловия**: Настройки изменены

### Шаги:
1. Изменить настройки экспорта (тема, формат)
2. Экспортировать
3. Закрыть страницу и вернуться

### Ожидаемый результат:
- Настройки сохраняются в localStorage
- При возврате настройки восстанавливаются

### Проверки:
- [ ] Настройки сохраняются
- [ ] Восстановление работает

---

## TC-EXPORT-024: Экспорт с большим количеством изображений
**Приоритет**: P2  
**Предусловия**: Путешествия с 20+ изображениями каждое

### Шаги:
1. Выбрать путешествия с большими галереями
2. Экспортировать

### Ожидаемый результат:
- Генерация может занять больше времени
- Прогресс-бар отображается
- PDF генерируется без ошибок
- Изображения оптимизированы (сжаты для PDF)
- Размер файла разумный (< 50MB)

### Проверки:
- [ ] Экспорт завершается успешно
- [ ] Производительность приемлема
- [ ] Качество изображений достаточное

---

## TC-EXPORT-025: Лимит размера PDF
**Приоритет**: P3  
**Предусловия**: Попытка экспортировать слишком много данных

### Шаги:
1. Выбрать 20+ путешествий с изображениями
2. Попытаться экспортировать

### Ожидаемый результат:
- Предупреждение: "Слишком много данных. Выберите меньше путешествий"
- Рекомендация разбить на несколько PDF
- Максимум, например, 10 путешествий или 100MB

### Проверки:
- [ ] Лимит работает
- [ ] Предупреждение понятное

---

## TC-EXPORT-026: Печать PDF после экспорта
**Приоритет**: P4  
**Предусловия**: PDF скачан

### Шаги:
1. Открыть скачанный PDF
2. Попытаться распечатать

### Ожидаемый результат:
- PDF оптимизирован для печати
- Поля страниц корректные
- Нет обрезки контента
- Цвета пригодны для печати

### Проверки:
- [ ] Печать корректна
- [ ] Поля достаточные
- [ ] Контент не обрезается

---

## TC-EXPORT-027: Accessibility (a11y) страницы
**Приоритет**: P3  
**Предусловия**: Keyboard navigation

### Шаги:
1. Использовать Tab для навигации
2. Выбрать путешествия с клавиатуры (Space)
3. Запустить экспорт с Enter

### Ожидаемый результат:
- Все элементы доступны через Tab
- Checkbox активируются Space
- Кнопка экспорта активируется Enter
- Screen reader озвучивает элементы

### Проверки:
- [ ] Keyboard navigation работает
- [ ] ARIA labels присутствуют

---

## TC-EXPORT-028: Аналитика экспорта
**Приоритет**: P4  
**Предусловия**: Аналитика настроена

### Шаги:
1. Выполнить экспорт
2. Проверить отправку событий

### Ожидаемый результат:
События отправляются:
- `ExportViewed` - просмотр страницы
- `ExportStarted` - начало экспорта
- `ExportCompleted` - завершение
- `ExportFailed` - ошибка
- С параметрами: количество путешествий, тема, формат

### Проверки:
- [ ] События отправляются
- [ ] Параметры корректны

---

## TC-EXPORT-029: Очередь экспорта при множественных запросах
**Приоритет**: P4  
**Предусловия**: Запущено несколько экспортов подряд

### Шаги:
1. Запустить первый экспорт
2. Быстро запустить второй

### Ожидаемый результат:
- Второй экспорт добавляется в очередь
- Или блокируется до завершения первого
- Сообщение: "Дождитесь завершения текущего экспорта"

### Проверки:
- [ ] Очередь/блокировка работает
- [ ] Нет конфликтов

---

## TC-EXPORT-030: История экспортов
**Приоритет**: P4  
**Предусловия**: Выполнено несколько экспортов

### Шаги:
1. Найти раздел "История экспортов" (если есть)
2. Проверить список

### Ожидаемый результат:
- Отображается список ранее созданных PDF
- Для каждого: дата, количество путешествий, размер
- Можно скачать повторно (если хранятся)

### Проверки:
- [ ] История отображается
- [ ] Повторное скачивание работает

---

## Покрытие автоматизацией

### Jest unit tests:
- PDF генерация (TravelDataTransformer)
- Темы оформления
- Парсеры и рендереры
- Обработка данных

Файлы:
- `__tests__/services/pdf-export/TravelDataTransformer.test.ts`
- `__tests__/services/pdf-v2/*.test.ts`
- `__tests__/services/EnhancedPdfGenerator.test.ts`
- `__tests__/components/listTravel/ListTravelExport.integration.test.tsx`

### Playwright E2E:
- Полный flow экспорта
- Выбор путешествий
- Генерация и скачивание

Планируется:
- `e2e/export-page.spec.ts`

### Связанные файлы:
- `app/(tabs)/export.tsx`
- `components/listTravel/ListTravel.tsx`
- `src/services/pdf-export/` (вся папка)
- `src/services/pdf-export/TravelDataTransformer.ts`
- `src/services/pdf-export/themes/`
- `src/services/pdf-export/generators/`
