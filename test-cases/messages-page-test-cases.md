# Тест-кейсы: Страница сообщений (/messages)

## Общая информация
- **Страница**: Личные сообщения
- **URL**: `/messages`
- **Компонент**: `app/(tabs)/messages.tsx`
- **Приоритет**: P1 (Critical)
- **Требует авторизации**: Да

---

## TC-MSG-001: Попытка доступа без авторизации
**Приоритет**: P1  
**Предусловия**: Пользователь НЕ авторизован

### Шаги:
1. Открыть `/messages` без авторизации

### Ожидаемый результат:
- Отображается auth gate: «Войдите в аккаунт» / кнопка «Войти»
- Список диалогов не загружается

### Проверки:
- [ ] Auth gate отображается
- [ ] Кнопка «Войти» ведёт на `/login`
- [ ] API запросы к `/message-threads/` не выполняются

### Автоматизация:
- ✅ E2E: `e2e/messages.spec.ts` — `unauthenticated user sees login prompt`

---

## TC-MSG-002: Загрузка списка диалогов (авторизован)
**Приоритет**: P1  
**Предусловия**: Пользователь авторизован, есть диалоги

### Шаги:
1. Авторизоваться
2. Открыть `/messages`
3. Дождаться загрузки

### Ожидаемый результат:
- Список диалогов загружается
- Каждый диалог содержит: аватар, имя собеседника, дату, превью последнего сообщения
- API запрос: `GET /message-threads/`
- Кнопка «Новый диалог» видна

### Проверки:
- [ ] Список отображается
- [ ] Аватары и имена корректны
- [ ] Дата форматирована (сегодня — время, иначе — дата)
- [ ] Превью последнего сообщения (1 строка, обрезка)
- [ ] Кнопка «Новый диалог» видна

### Автоматизация:
- ✅ E2E: `e2e/messages.spec.ts` — `authenticated user sees messages page`
- ✅ Unit: `__tests__/components/messages/ThreadList.test.tsx`

---

## TC-MSG-003: Пустой список диалогов
**Приоритет**: P2  
**Предусловия**: Пользователь авторизован, диалогов нет

### Шаги:
1. Открыть `/messages` с пустым списком

### Ожидаемый результат:
- Empty state: иконка, текст «Нет сообщений», подсказка «Напишите автору путешествия...»
- Кнопка «Новый диалог»

### Проверки:
- [ ] Empty state отображается
- [ ] Кнопка «Новый диалог» работает

### Автоматизация:
- ✅ Unit: `__tests__/components/messages/ThreadList.test.tsx` — `renders empty state`

---

## TC-MSG-004: Поиск по диалогам
**Приоритет**: P2  
**Предусловия**: Есть несколько диалогов

### Шаги:
1. Открыть `/messages`
2. Ввести имя собеседника в поле поиска
3. Проверить фильтрацию

### Ожидаемый результат:
- Список фильтруется по имени собеседника
- Фильтрация клиентская (без API запроса)
- Кнопка очистки поиска (×) видна при вводе

### Проверки:
- [ ] Поиск фильтрует список
- [ ] Кнопка очистки работает
- [ ] Поиск доступен на desktop и mobile

### Автоматизация:
- ✅ E2E: `e2e/messages.spec.ts` — `messages page has search input`
- ✅ Unit: `__tests__/components/messages/ThreadList.test.tsx` — `filters threads by search`

---

## TC-MSG-005: Открытие чата
**Приоритет**: P1  
**Предусловия**: Есть диалоги

### Шаги:
1. Кликнуть на диалог в списке
2. Дождаться загрузки сообщений

### Ожидаемый результат:
- Открывается чат с собеседником
- Header: аватар, имя, кнопка «Назад» (mobile)
- Сообщения загружаются: `GET /messages/?thread_id={id}`
- Сообщения сгруппированы по датам (разделители «Сегодня», «Вчера», дата)
- Собственные сообщения справа (primary цвет), чужие — слева

### Проверки:
- [ ] Чат открывается
- [ ] Сообщения загружены
- [ ] Группировка по датам работает
- [ ] Цвета bubble корректны (own vs other)
- [ ] Кнопка «Назад» работает (mobile)

### Автоматизация:
- ✅ Unit: `__tests__/components/messages/ChatView.test.tsx`
- ✅ Unit: `__tests__/components/messages/MessageBubble.test.tsx`

---

## TC-MSG-006: Отправка сообщения
**Приоритет**: P1  
**Предусловия**: Открыт чат

### Шаги:
1. Ввести текст в поле ввода
2. Нажать кнопку «Отправить» или Enter (web)
3. Проверить отправку

### Ожидаемый результат:
- API запрос: `POST /messages/` с payload `{participants, text}`
- Поле ввода очищается после отправки
- Кнопка «Отправить» disabled при пустом тексте или во время отправки
- Debounce: повторная отправка невозможна в течение 300ms

### Проверки:
- [ ] Сообщение отправляется
- [ ] Поле очищается
- [ ] Кнопка disabled при пустом тексте
- [ ] Debounce 300ms работает
- [ ] Enter отправляет (web), Shift+Enter — перенос строки

### Автоматизация:
- ✅ Unit: `__tests__/components/messages/ChatView.test.tsx` — `sends message`, `Enter submits`

---

## TC-MSG-007: Удаление сообщения (собственного)
**Приоритет**: P2  
**Предусловия**: Открыт чат, есть собственные сообщения

### Шаги:
1. Long-press (mobile) или toggle menu (web) на собственном сообщении
2. Выбрать «Удалить»
3. Проверить удаление

### Ожидаемый результат:
- Mobile: Alert с кнопками «Копировать», «Удалить», «Отмена»
- Web: контекстное меню с кнопками «Копировать» и «Удалить»
- Оптимистичное удаление: сообщение исчезает сразу
- API запрос: `DELETE /messages/{id}/`
- При ошибке API: rollback (сообщение возвращается)

### Проверки:
- [ ] Контекстное меню появляется
- [ ] Сообщение удаляется оптимистично
- [ ] API запрос выполняется
- [ ] Rollback при ошибке

### Автоматизация:
- ✅ Unit: `__tests__/components/messages/MessageBubble.test.tsx` — `long press with onDelete`
- ✅ Unit: `__tests__/hooks/useMessages.test.ts` — `optimisticRemove`, `rollback`

---

## TC-MSG-008: Копирование текста сообщения
**Приоритет**: P3  
**Предусловия**: Открыт чат

### Шаги:
1. Long-press (mobile) или toggle menu (web) на любом сообщении
2. Выбрать «Копировать»

### Ожидаемый результат:
- Mobile: Alert с кнопкой «Копировать»
- Web: контекстное меню с кнопкой «Копировать»
- Текст копируется в буфер обмена (`expo-clipboard` / `navigator.clipboard`)
- Доступно на любом сообщении (не только собственном)

### Проверки:
- [ ] Кнопка «Копировать» доступна на own и other сообщениях
- [ ] Текст копируется в буфер

### Автоматизация:
- ✅ Unit: `__tests__/components/messages/MessageBubble.test.tsx` — `long press without onDelete shows Копировать only`

---

## TC-MSG-009: Новый диалог
**Приоритет**: P1  
**Предусловия**: Авторизован

### Шаги:
1. Нажать «Новый диалог»
2. Выбрать пользователя из списка
3. Ввести и отправить сообщение

### Ожидаемый результат:
- Открывается `NewConversationPicker` со списком пользователей
- API запрос: `GET /message-threads/available-users/`
- Поиск по имени работает
- При выборе пользователя: проверка существующего треда (`thread-by-user`)
- Если тред есть — открывается; если нет — создаётся виртуальный (id=-1)
- Первое сообщение создаёт тред

### Проверки:
- [ ] Список пользователей загружается
- [ ] Поиск фильтрует список
- [ ] Выбор пользователя открывает чат
- [ ] Виртуальный тред работает

### Автоматизация:
- ✅ Unit: `__tests__/components/messages/NewConversationPicker.test.tsx`

---

## TC-MSG-010: Deep-link по userId
**Приоритет**: P2  
**Предусловия**: Авторизован

### Шаги:
1. Открыть `/messages?userId=X`

### Ожидаемый результат:
- Автоматически открывается чат с пользователем X
- Если тред существует — загружаются сообщения
- Если тред не существует — виртуальный тред

### Проверки:
- [ ] Deep-link открывает чат
- [ ] Работает для существующих и новых тредов

### Автоматизация:
- ✅ E2E: `e2e/messages.spec.ts` — `deep-link with userId`

---

## TC-MSG-011: Deep-link по threadId
**Приоритет**: P2  
**Предусловия**: Авторизован, тред существует

### Шаги:
1. Открыть `/messages?threadId=Y`

### Ожидаемый результат:
- Автоматически выбирается тред Y в списке
- Загружаются сообщения треда

### Проверки:
- [ ] Deep-link выбирает тред
- [ ] Сообщения загружаются

---

## TC-MSG-012: Непрочитанные сообщения (badge)
**Приоритет**: P2  
**Предусловия**: Есть непрочитанные сообщения

### Шаги:
1. Открыть `/messages`
2. Проверить badge на диалогах с непрочитанными
3. Открыть диалог с непрочитанными
4. Проверить сброс badge

### Ожидаемый результат:
- Badge с числом непрочитанных на каждом треде (>99 → «99+»)
- При открытии чата: `POST /message-threads/{id}/mark-read/`
- Badge сбрасывается
- Общий badge в `AccountMenu`

### Проверки:
- [ ] Badge отображается
- [ ] Mark-read при открытии чата
- [ ] Badge в AccountMenu обновляется

### Автоматизация:
- ✅ Unit: `__tests__/components/messages/ThreadList.test.tsx` — `renders unread badge`
- ✅ Unit: `__tests__/hooks/useMessages.test.ts` — `useUnreadCount`, `useMarkThreadRead`

---

## TC-MSG-013: Polling (автообновление)
**Приоритет**: P2  
**Предусловия**: Открыт чат

### Шаги:
1. Открыть чат
2. Подождать 10 секунд
3. Проверить обновление сообщений

### Ожидаемый результат:
- Сообщения обновляются каждые 10с (silent refresh)
- Треды обновляются каждые 30с
- Polling активен только при фокусе экрана
- Ошибки polling не показываются в UI

### Проверки:
- [ ] Новые сообщения появляются автоматически
- [ ] Polling останавливается при потере фокуса
- [ ] Ошибки polling не ломают UI

### Автоматизация:
- ✅ Unit: `__tests__/hooks/useMessages.test.ts` — `useThreadMessages polling`, `useThreads polling`

---

## TC-MSG-014: Пагинация сообщений
**Приоритет**: P3  
**Предусловия**: Чат с >50 сообщениями

### Шаги:
1. Открыть чат
2. Прокрутить вверх до конца
3. Проверить загрузку следующей страницы

### Ожидаемый результат:
- При прокрутке загружается следующая страница: `GET /messages/?thread_id={id}&page=2`
- Дубликаты не появляются
- Индикатор загрузки при подгрузке

### Проверки:
- [ ] Пагинация работает
- [ ] Нет дубликатов
- [ ] hasMore корректно отключает подгрузку

### Автоматизация:
- ✅ Unit: `__tests__/hooks/useMessages.test.ts` — `useThreadMessages pagination`

---

## TC-MSG-015: Адаптивный layout
**Приоритет**: P2  
**Предусловия**: Нет

### Шаги:
1. Открыть `/messages` на desktop (>768px)
2. Открыть `/messages` на mobile (<768px)

### Ожидаемый результат:
- Desktop: two-panel layout (sidebar + chat)
- Mobile: stacked (список → чат, кнопка «Назад»)
- Кнопка «Назад» скрыта на desktop

### Проверки:
- [ ] Desktop: sidebar + chat одновременно
- [ ] Mobile: stacked навигация
- [ ] Кнопка «Назад» видна только на mobile

---

## TC-MSG-016: SEO — noindex
**Приоритет**: P3  
**Предусловия**: Нет

### Шаги:
1. Открыть `/messages`
2. Проверить meta robots

### Ожидаемый результат:
- `<meta name="robots" content="noindex,nofollow">`

### Проверки:
- [ ] noindex присутствует

### Автоматизация:
- ✅ E2E: `e2e/messages.spec.ts` — `messages page has noindex meta`

---

## TC-MSG-017: Ошибка загрузки (сеть)
**Приоритет**: P2  
**Предусловия**: Нет сети или API недоступен

### Шаги:
1. Открыть `/messages` при недоступном API

### Ожидаемый результат:
- Отображается ошибка с текстом и кнопкой «Повторить»
- 401/404 обрабатываются gracefully (пустой список, без ошибки)

### Проверки:
- [ ] Ошибка отображается
- [ ] Кнопка «Повторить» работает
- [ ] 401/404 → пустой список

### Автоматизация:
- ✅ Unit: `__tests__/api/messages.test.ts` — graceful 401/404
- ✅ Unit: `__tests__/components/messages/ThreadList.test.tsx` — `renders error state`

---

## TC-MSG-018: Ограничение длины сообщения
**Приоритет**: P3  
**Предусловия**: Открыт чат

### Шаги:
1. Ввести текст длиннее 2000 символов

### Ожидаемый результат:
- `maxLength={2000}` на TextInput
- Текст обрезается на 2000 символов

### Проверки:
- [ ] maxLength работает

---

## Матрица покрытия

| Тест-кейс | Unit | E2E | Ручной |
|-----------|------|-----|--------|
| TC-MSG-001 Auth gate | — | ✅ | — |
| TC-MSG-002 Список диалогов | ✅ | ✅ | — |
| TC-MSG-003 Пустой список | ✅ | — | — |
| TC-MSG-004 Поиск | ✅ | ✅ | — |
| TC-MSG-005 Открытие чата | ✅ | — | Ручной |
| TC-MSG-006 Отправка | ✅ | — | Ручной |
| TC-MSG-007 Удаление | ✅ | — | Ручной |
| TC-MSG-008 Копирование | ✅ | — | Ручной |
| TC-MSG-009 Новый диалог | ✅ | — | Ручной |
| TC-MSG-010 Deep-link userId | — | ✅ | — |
| TC-MSG-011 Deep-link threadId | — | — | Ручной |
| TC-MSG-012 Непрочитанные | ✅ | — | Ручной |
| TC-MSG-013 Polling | ✅ | — | Ручной |
| TC-MSG-014 Пагинация | ✅ | — | Ручной |
| TC-MSG-015 Адаптивный layout | — | — | Ручной |
| TC-MSG-016 SEO noindex | — | ✅ | — |
| TC-MSG-017 Ошибка сети | ✅ | — | Ручной |
| TC-MSG-018 maxLength | — | — | Ручной |

---

## Статистика

- **Всего тест-кейсов**: 18
- **Покрыто unit-тестами**: 12
- **Покрыто E2E**: 5
- **Только ручные**: 3 (TC-MSG-011, TC-MSG-015, TC-MSG-018)
- **Unit-тестов**: 92 (API: 25, хуки: 32, MessageBubble: 8, ThreadList: 9, ChatView: 10, NewConversationPicker: 8)
- **E2E-сценариев**: 5
