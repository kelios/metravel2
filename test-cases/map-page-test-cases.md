# Тест-кейсы: Страница карты (/map)

## Общая информация
- **Страница**: Карта путешествий
- **URL**: `/map`
- **Компонент**: `app/(tabs)/map.tsx`, `src/screens/tabs/MapScreen.tsx`
- **Приоритет**: P1 (Critical)

---

## TC-MAP-001: Загрузка страницы с картой
**Приоритет**: P1  
**Предусловия**: API доступен, есть путешествия с координатами

### Шаги:
1. Открыть URL `/map`
2. Дождаться загрузки карты

### Ожидаемый результат:
- Карта отображается без ошибок
- На карте видны маркеры путешествий
- API запрос к `/api/travels/search_travels_for_map/` выполнен
- Скелетон/загрузчик отображается во время загрузки

### Проверки:
- [ ] Карта загружается
- [ ] Маркеры отображаются
- [ ] Skeleton корректный
- [ ] Нет ошибок в консоли

---

## TC-MAP-002: Начальное позиционирование карты
**Приоритет**: P1  
**Предусловия**: Первая загрузка карты

### Шаги:
1. Открыть /map
2. Проверить начальную позицию и zoom

### Ожидаемый результат:
- Карта центрирована на Беларуси (по умолчанию)
- Zoom level адекватный (показывает всю страну)
- Координаты примерно: lat 53.9, lng 27.5

### Проверки:
- [ ] Начальная позиция корректна
- [ ] Zoom подходящий
- [ ] Видны маркеры Беларуси

---

## TC-MAP-003: Клик по маркеру на карте
**Приоритет**: P1  
**Предусловия**: Карта загружена, маркеры видны

### Шаги:
1. Найти маркер путешествия на карте
2. Кликнуть на маркер

### Ожидаемый результат:
- Открывается popup с информацией о путешествии:
  - Изображение (thumbnail)
  - Название
  - Категория
  - Ссылка на детальную страницу

### Проверки:
- [ ] Popup открывается
- [ ] Данные корректны
- [ ] Изображение загружается
- [ ] Ссылка работает

---

## TC-MAP-004: Переход на детальную страницу из popup
**Приоритет**: P1  
**Предусловия**: Popup маркера открыт

### Шаги:
1. Кликнуть на маркер
2. В popup кликнуть на название или кнопку "Подробнее"

### Ожидаемый результат:
- Переход на детальную страницу путешествия
- URL: `/travel/[slug]`

### Проверки:
- [ ] Переход выполнен
- [ ] Детальная страница загружена
- [ ] Нет ошибок

---

## TC-MAP-005: Открытие панели фильтров на карте
**Приоритет**: P1  
**Предусловия**: Карта загружена

### Шаги:
1. Найти кнопку "Фильтры" на карте
2. Кликнуть на кнопку

### Ожидаемый результат:
- Открывается панель/модальное окно с фильтрами
- Доступны фильтры:
  - Страны
  - Категории
  - Транспорт
  - Сложность

### Проверки:
- [ ] Панель открывается
- [ ] Фильтры отображаются
- [ ] UI не блокирует карту полностью

---

## TC-MAP-006: Применение фильтров на карте
**Приоритет**: P1  
**Предусловия**: Панель фильтров открыта

### Шаги:
1. Выбрать категорию (например, "Природа")
2. Применить фильтр
3. Проверить обновление маркеров

### Ожидаемый результат:
- Маркеры на карте обновляются
- Отображаются только путешествия выбранной категории
- API запрос с параметром `?where={categories:[id]}`

### Проверки:
- [ ] Фильтр применен
- [ ] Маркеры обновлены
- [ ] API запрос корректен

---

## TC-MAP-007: Очистка фильтров на карте
**Приоритет**: P2  
**Предусловия**: Фильтры применены

### Шаги:
1. Применить фильтры
2. Нажать "Очистить все"

### Ожидаемый результат:
- Фильтры сброшены
- Маркеры показывают все путешествия (или только Беларусь)

### Проверки:
- [ ] Фильтры сброшены
- [ ] Маркеры восстановлены

---

## TC-MAP-008: Масштабирование карты (Zoom In/Out)
**Приоритет**: P1  
**Предусловия**: Карта загружена

### Шаги:
1. Использовать кнопки +/- для масштабирования
2. Использовать колесо мыши (на desktop)
3. Использовать pinch gesture (на mobile)

### Ожидаемый результат:
- Карта масштабируется плавно
- Маркеры остаются кликабельными
- При увеличении могут подгружаться дополнительные маркеры

### Проверки:
- [ ] Zoom работает
- [ ] Маркеры корректны
- [ ] Нет лагов

---

## TC-MAP-009: Перемещение карты (Pan)
**Приоритет**: P1  
**Предусловия**: Карта загружена

### Шаги:
1. Перетащить карту мышью (drag)
2. На mobile: swipe gesture

### Ожидаемый результат:
- Карта перемещается плавно
- При перемещении в новую область могут подгружаться новые маркеры
- Видимая область обновляется

### Проверки:
- [ ] Pan работает
- [ ] Загрузка маркеров по области (если реализовано)
- [ ] Плавная анимация

---

## TC-MAP-010: Открытие списка путешествий на карте
**Приоритет**: P2  
**Предусловия**: Карта загружена

### Шаги:
1. Найти кнопку "Список" или аналогичную
2. Кликнуть на кнопку

### Ожидаемый результат:
- Открывается боковая панель со списком путешествий
- Список соответствует маркерам на карте
- Можно переключаться между картой и списком

### Проверки:
- [ ] Панель списка открывается
- [ ] Список соответствует фильтрам
- [ ] Клик по элементу списка центрирует карту

---

## TC-MAP-011: Синхронизация списка и карты
**Приоритет**: P2  
**Предусловия**: Панель списка открыта

### Шаги:
1. Кликнуть на элемент в списке
2. Проверить карту

### Ожидаемый результат:
- Карта центрируется на выбранном маркере
- Popup маркера открывается автоматически

### Проверки:
- [ ] Синхронизация работает
- [ ] Карта центрируется
- [ ] Popup открывается

---

## TC-MAP-012: Кластеризация маркеров
**Приоритет**: P2  
**Предусловия**: Много маркеров в одной области

### Шаги:
1. Уменьшить zoom карты
2. Проверить группировку маркеров

### Ожидаемый результат:
- Близкие маркеры группируются в кластеры
- На кластере отображается количество маркеров
- При клике на кластер карта увеличивается

### Проверки:
- [ ] Кластеризация работает
- [ ] Счетчик корректен
- [ ] Zoom in при клике

---

## TC-MAP-013: Геолокация пользователя
**Приоритет**: P3  
**Предусловия**: Браузер поддерживает геолокацию

### Шаги:
1. Найти кнопку "Моё местоположение" (GPS icon)
2. Кликнуть на кнопку
3. Разрешить доступ к геолокации

### Ожидаемый результат:
- Карта центрируется на текущем местоположении
- Отображается маркер текущей позиции
- Рядом показываются ближайшие путешествия

### Проверки:
- [ ] Геолокация работает
- [ ] Карта центрируется
- [ ] Маркер позиции отображается

---

## TC-MAP-014: Построение маршрута на карте
**Приоритет**: P2  
**Предусловия**: Функция построения маршрутов доступна

### Шаги:
1. Выбрать "Построить маршрут"
2. Указать начальную и конечную точки
3. Построить маршрут

### Ожидаемый результат:
- Маршрут отображается на карте
- Показывается расстояние и время
- API запрос: `POST /api/travels/near-route/`

### Проверки:
- [ ] Маршрут строится
- [ ] Данные корректны
- [ ] Путешествия вдоль маршрута показываются

---

## TC-MAP-015: Переключение стиля карты (слоев)
**Приоритет**: P3  
**Предусловия**: Доступны разные слои карты

### Шаги:
1. Найти переключатель слоев
2. Переключить между слоями:
   - Стандартная карта
   - Спутник
   - Рельеф
   - OpenStreetMap

### Ожидаемый результат:
- Слой карты меняется
- Маркеры остаются видимыми
- Настройка сохраняется

### Проверки:
- [ ] Слои переключаются
- [ ] Маркеры видны
- [ ] Выбор сохраняется

---

## TC-MAP-016: Полноэкранный режим карты
**Приоритет**: P3  
**Предусловия**: Кнопка fullscreen доступна

### Шаги:
1. Найти кнопку "Полный экран"
2. Кликнуть на кнопку

### Ожидаемый результат:
- Карта разворачивается на весь экран
- Элементы управления остаются доступны
- Выход из fullscreen работает

### Проверки:
- [ ] Fullscreen активируется
- [ ] Управление работает
- [ ] Выход работает

---

## TC-MAP-017: Мобильная версия карты
**Приоритет**: P1  
**Предусловия**: Мобильный viewport

### Шаги:
1. Открыть /map на мобильном устройстве
2. Проверить touch gestures

### Ожидаемый результат:
- Карта адаптирована под мобильный экран
- Touch gestures работают (pan, zoom, pinch)
- Фильтры доступны через модальное окно
- Нижнее меню не перекрывает карту

### Проверки:
- [ ] Карта адаптирована
- [ ] Gestures работают
- [ ] UI не перекрывает контент

---

## TC-MAP-018: Сохранение позиции карты при навигации
**Приоритет**: P2  
**Предусловия**: Карта перемещена, zoom изменен

### Шаги:
1. Переместить карту и изменить zoom
2. Перейти на другую страницу
3. Вернуться на /map

### Ожидаемый результат:
- Позиция и zoom восстанавливаются (опционально)
- Или карта возвращается к начальному состоянию

### Проверки:
- [ ] Поведение предсказуемо
- [ ] Нет ошибок

---

## TC-MAP-019: SEO метатеги страницы карты
**Приоритет**: P2  
**Предусловия**: Доступ к исходному коду

### Шаги:
1. Открыть /map
2. Проверить исходный код

### Ожидаемый результат:
```html
<title>Карта путешествий | Metravel</title>
<meta name="description" content="Интерактивная карта путешествий..." />
<link rel="canonical" href="https://metravel.by/map" />
```

### Проверки:
- [ ] Title корректен
- [ ] Description заполнен
- [ ] Canonical правильный

---

## TC-MAP-020: Обработка ошибки загрузки карты
**Приоритет**: P1  
**Предусловия**: API недоступен или ошибка карты

### Шаги:
1. Имитировать ошибку загрузки
2. Открыть /map

### Ожидаемый результат:
- Отображается сообщение об ошибке
- Есть кнопка "Повторить попытку"
- Приложение не падает

### Проверки:
- [ ] Error state отображается
- [ ] Retry работает
- [ ] Graceful degradation

---

## TC-MAP-021: Производительность карты с большим количеством маркеров
**Приоритет**: P2  
**Предусловия**: На карте 100+ маркеров

### Шаги:
1. Загрузить карту с большим количеством маркеров
2. Проверить производительность (FPS, lag)

### Ожидаемый результат:
- Карта остается отзывчивой
- FPS > 30
- Кластеризация помогает оптимизации
- Виртуализация работает

### Проверки:
- [ ] Нет лагов
- [ ] Smooth scrolling/panning
- [ ] Кластеризация активна

---

## TC-MAP-022: Доступность (a11y) карты
**Приоритет**: P3  
**Предусловия**: Keyboard navigation

### Шаги:
1. Открыть /map
2. Использовать Tab для навигации
3. Проверить доступность элементов управления

### Ожидаемый результат:
- Кнопки управления доступны через Tab
- Focus visible
- Screen reader может озвучить элементы

### Проверки:
- [ ] Keyboard navigation работает
- [ ] ARIA labels присутствуют
- [ ] Альтернативный доступ к данным (список)

---

## TC-MAP-023: Deep link с координатами
**Приоритет**: P3  
**Предусловия**: URL с параметрами координат

### Шаги:
1. Открыть URL: `/map?lat=53.9&lng=27.5&zoom=10`
2. Проверить позиционирование

### Ожидаемый результат:
- Карта центрируется на указанных координатах
- Zoom соответствует параметру

### Проверки:
- [ ] Координаты из URL применены
- [ ] Карта корректна

---

## TC-MAP-024: Экспорт/печать карты
**Приоритет**: P4  
**Предусловия**: Функция экспорта доступна

### Шаги:
1. Найти кнопку "Экспорт" или "Печать"
2. Кликнуть на кнопку

### Ожидаемый результат:
- Генерируется изображение карты
- Можно скачать или распечатать

### Проверки:
- [ ] Экспорт работает
- [ ] Качество изображения достаточное

---

## Покрытие автоматизацией

### Jest unit tests:
- Логика фильтрации маркеров
- Кластеризация
- Обработка координат

### Playwright E2E:
- `e2e/map-page.spec.ts`
- Взаимодействие с картой
- Фильтры и список

### Связанные файлы:
- `app/(tabs)/map.tsx`
- `src/screens/tabs/MapScreen.tsx`
- `components/MapPage/`
- `config/mapConfig.ts`
- `__tests__/components/MapPage/`
