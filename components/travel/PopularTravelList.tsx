// components/travel/PopularTravelList.tsx
import React, {
  memo,
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import {
  ActivityIndicator,
  Animated,
  Platform,
  StyleSheet,
  Text,
  useWindowDimensions,
  View,
} from "react-native";
import { Title } from "react-native-paper";
import TravelTmlRound from "@/components/travel/TravelTmlRound";
import { fetchTravelsPopular } from "@/src/api/travels";
import type { Travel, TravelsMap } from "@/src/types/types";

type PopularTravelListProps = {
  onLayout?: (event: any) => void;
  scrollToAnchor?: () => void;
  title?: string | null;
  maxColumns?: number;
};

const ITEM_HEIGHT = 250;
const SEPARATOR_HEIGHT = 20;

// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
const WEB_LIST_WINDOW_SIZE = 3; // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è web
const INITIAL_NUM_TO_RENDER = 4; // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

const PopularTravelList: React.FC<PopularTravelListProps> = memo(
  ({ onLayout, scrollToAnchor, title = "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã", maxColumns = 3 }) => {
    const [travelsPopular, setTravelsPopular] = useState<TravelsMap>({});
    const [isLoading, setIsLoading] = useState(true);
    const [hasError, setHasError] = useState(false);
    const { width } = useWindowDimensions();
    const fadeAnim = useRef(new Animated.Value(0)).current;
    const mountedRef = useRef(true);

    const numColumns = useMemo(() => {
      if (width <= 600) return 1;
      if (width <= 1024) return Math.min(maxColumns, 2);
      return Math.min(maxColumns, 3);
    }, [width, maxColumns]);

    const fetchPopularTravels = useCallback(async () => {
      if (!mountedRef.current) return;

      try {
        setIsLoading(true);
        setHasError(false);
        const data = await fetchTravelsPopular();
        if (mountedRef.current) {
          setTravelsPopular(data);
        }
      } catch (error) {
        if (mountedRef.current) {
          setHasError(true);
          console.error('Error fetching popular travels:', error);
        }
      } finally {
        if (mountedRef.current) {
          setIsLoading(false);
        }
      }
    }, []);

    useEffect(() => {
      mountedRef.current = true;
      fetchPopularTravels();

      return () => {
        mountedRef.current = false;
      };
    }, [fetchPopularTravels]);

    const popularList = useMemo(() => {
      const list = Object.values(travelsPopular);
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
      return list.slice(0, Platform.OS === 'web' ? 8 : list.length);
    }, [travelsPopular]);

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ–º –ª–∏—à–Ω–∏—Ö —Ä–µ—Ä–µ–Ω–¥–µ—Ä–æ–≤
    const renderItem = useCallback(
      ({ item, index }: { item: Travel; index: number }) => (
        <TravelTmlRound
          travel={item}
          priority={index < 4 ? 'high' : 'low'} // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        />
      ),
      []
    );

    const keyExtractor = useCallback((item: Travel) => `${item.id}-${item.updated_at || ''}`, []);

    const handleContentChange = useCallback(() => {
      scrollToAnchor?.();
    }, [scrollToAnchor]);

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è - –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤
    useEffect(() => {
      if (!isLoading && popularList.length > 0 && mountedRef.current) {
        const timer = setTimeout(() => {
          if (mountedRef.current) {
            Animated.timing(fadeAnim, {
              toValue: 1,
              duration: 250, // –£–∫–æ—Ä–æ—á–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
              useNativeDriver: true,
            }).start();
          }
        }, 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏

        return () => clearTimeout(timer);
      }
    }, [isLoading, popularList.length, fadeAnim]);

    const getItemLayout = useCallback(
      (_: unknown, index: number) => ({
        length: ITEM_HEIGHT + SEPARATOR_HEIGHT,
        offset: (ITEM_HEIGHT + SEPARATOR_HEIGHT) * index,
        index,
      }),
      []
    );

    // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ - —É–±—Ä–∞–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
    const columnWrapperStyle = useMemo(
      () =>
        numColumns > 1
          ? {
            justifyContent: "space-between",
            gap: 16,
          }
          : undefined,
      [numColumns]
    );

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    const ItemSeparatorComponent = useCallback(() =>
        <View style={styles.separator} />,
      []);

    if (isLoading) {
      return (
        <View style={styles.loadingContainer} onLayout={onLayout}>
          <ActivityIndicator size="large" color="#6B4F4F" />
          <Text style={styles.loadingText}>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤‚Ä¶</Text>
        </View>
      );
    }

    if (hasError || popularList.length === 0) {
      return (
        <View style={styles.loadingContainer} onLayout={onLayout}>
          <Text style={styles.errorText}>
            {hasError ? '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤' : '–ù–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ üòî'}
          </Text>
        </View>
      );
    }

    return (
      <View style={styles.section} onLayout={onLayout}>
        {title !== null && (
          <Title style={styles.title} accessibilityRole="header">
            {title}
          </Title>
        )}

        <Animated.View style={{ opacity: fadeAnim }}>
          <Animated.FlatList
            key={`cols-${numColumns}`}
            data={popularList}
            renderItem={renderItem}
            keyExtractor={keyExtractor}
            numColumns={numColumns}
            contentContainerStyle={styles.flatListContent}
            columnWrapperStyle={numColumns > 1 ? columnWrapperStyle : undefined}
            ItemSeparatorComponent={ItemSeparatorComponent}
            showsVerticalScrollIndicator={false}
            initialNumToRender={INITIAL_NUM_TO_RENDER}
            maxToRenderPerBatch={4} // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            windowSize={Platform.OS === "web" ? WEB_LIST_WINDOW_SIZE : 5}
            removeClippedSubviews={Platform.OS !== "web"}
            getItemLayout={getItemLayout}
            onContentSizeChange={handleContentChange}
            updateCellsBatchingPeriod={50} // –ë–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            disableVirtualization={false} // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é
            accessibilityRole="list"
          />
        </Animated.View>
      </View>
    );
  }
);

// –î–æ–±–∞–≤–ª—è–µ–º —è–≤–Ω–æ–µ –∏–º—è –¥–ª—è memo –¥–ª—è –ª—É—á—à–µ–π –æ—Ç–ª–∞–¥–∫–∏
PopularTravelList.displayName = 'PopularTravelList';

export default PopularTravelList;

const styles = StyleSheet.create({
  section: {
    marginTop: 24,
    marginBottom: 40,
    paddingHorizontal: 16,
    paddingVertical: 28,
    backgroundColor: "#fff",
    borderRadius: 16,
    width: "100%",
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.05,
    shadowRadius: 4,
    elevation: 2,
    minHeight: 200, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è layout shift
  },
  loadingContainer: {
    justifyContent: "center",
    alignItems: "center",
    padding: 20,
    minHeight: 200,
  },
  loadingText: {
    marginTop: 10,
    fontSize: 16,
    color: "#333",
    textAlign: "center",
  },
  errorText: {
    marginTop: 10,
    fontSize: 16,
    color: "#d32f2f",
    textAlign: "center",
  },
  title: {
    fontSize: 22,
    fontWeight: "700",
    color: "#3B2C24",
    marginBottom: 20,
    textAlign: "center",
    fontFamily: "Georgia",
  },
  flatListContent: {
    paddingBottom: 20,
  },
  separator: {
    height: SEPARATOR_HEIGHT,
  },
});