import React, { memo, useEffect, useMemo, useState } from "react";
import {
    ScrollView,
    StyleSheet,
    Text,
    useWindowDimensions,
    View,
    Platform,
    InteractionManager,
} from "react-native";
import { Image as ExpoImage } from "expo-image";
import StableContent from "@/components/travel/StableContent";

interface TravelDescriptionProps {
    htmlContent: string;
    title?: string;
    noBox?: boolean;
}

/**
 * –û–ø–∏—Å–∞–Ω–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è:
 * - –ù–∞ web —Å—Ä–∞–∑—É –º–æ–Ω—Ç–∏—Ä—É–µ–º HTML (–∏–Ω–∞—á–µ –º–æ–≥—É—Ç ¬´–ø—Ä–æ–ø–∞—Å—Ç—å¬ª –∫–∞—Ä—Ç–∏–Ω–∫–∏, –µ—Å–ª–∏ idle –Ω–µ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç).
 * - –ù–∞ native –ø–∞—Ä—Å–∏–Ω–≥ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–æ –∫–æ–Ω—Ü–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π (—ç–∫–æ–Ω–æ–º–∏–º –∫–∞–¥—Ä—ã).
 * - –ï—Å—Ç—å —Ñ–æ—Ä—Å–∞–∂–Ω—ã–π —Ç–∞–π–º–µ—Ä ‚Äî —á–µ—Ä–µ–∑ 2s –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –º–æ–Ω—Ç–∏—Ä—É–µ–º.
 */
const TravelDescription: React.FC<TravelDescriptionProps> = ({
                                                                 htmlContent,
                                                                 title,
                                                                 noBox = false,
                                                             }) => {
    const { width, height } = useWindowDimensions();

    // ---- —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ----
    const pageHeight = useMemo(() => Math.round(height * 0.7), [height]);
    const contentWidth = useMemo(() => {
        const maxContent = Math.min(width, 900);
        return Math.max(maxContent - 60, 220);
    }, [width]);

    // ---- —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ ----
    const isEmptyHtml = useMemo(() => {
        if (!htmlContent) return true;
        const txt = String(htmlContent).trim().replace(/<[^>]+>/g, "");
        return txt.length === 0;
    }, [htmlContent]);

    // –ù–∞ web ‚Äî —Å—Ä–∞–∑—É true, –Ω–∞ native ‚Äî –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º
    const [canParseHtml, setCanParseHtml] = useState(Platform.OS === "web");

    useEffect(() => {
        let cancelled = false;
        let timeoutId: any = null;

        if (Platform.OS !== "web") {
            const task = InteractionManager.runAfterInteractions(() => {
                if (!cancelled) setCanParseHtml(true);
            });

            // –§–æ—Ä—Å–∞–∂: –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫ ‚Äî —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ 2s
            timeoutId = setTimeout(() => {
                if (!cancelled) setCanParseHtml(true);
            }, 2000);

            return () => {
                cancelled = true;
                task.cancel();
                if (timeoutId) clearTimeout(timeoutId);
            };
        } else {
            // –ù–∞ web –≤—Å—ë —É–∂–µ true; –Ω–æ –æ—Å—Ç–∞–≤–∏–º —Ñ–æ—Ä—Å–∞–∂ –Ω–∞ –≤—Å—è–∫–∏–π
            timeoutId = setTimeout(() => {
                if (!cancelled) setCanParseHtml(true);
            }, 2000);
            return () => {
                cancelled = true;
                if (timeoutId) clearTimeout(timeoutId);
            };
        }
    }, [htmlContent]);

    const inner = (
      <View style={styles.inner} pointerEvents="box-none">
          {/* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —à—Ç–∞–º–ø –≤ —É–≥–ª—É ‚Äî –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ */}
          <ExpoImage
            source={require("@/assets/travel-stamp.webp")}
            style={styles.stamp}
            accessibilityIgnoresInvertColors
            accessible={false}
            pointerEvents="none"
            cachePolicy="memory-disk"
            priority="low"
          />

          {/* –ö–æ–Ω—Ç–µ–Ω—Ç */}
          {isEmptyHtml ? (
            <Text style={styles.placeholder}>–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è üôÇ</Text>
          ) : canParseHtml ? (
            <StableContent html={htmlContent} contentWidth={contentWidth} />
          ) : (
            <Text style={styles.placeholder}>–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ‚Ä¶</Text>
          )}
      </View>
    );

    return (
      <View style={styles.wrapper} testID="travel-description">
          {noBox ? (
            <ScrollView
              style={styles.scrollArea}
              contentContainerStyle={styles.scrollContent}
              scrollEventThrottle={16}
              showsVerticalScrollIndicator
              keyboardShouldPersistTaps="handled"
              {...(Platform.OS === "web" ? ({ overScrollMode: "never" } as any) : {})}
            >
                {inner}
            </ScrollView>
          ) : (
            <View style={[styles.fixedHeightBlock, { height: pageHeight }]}>
                <ScrollView
                  style={styles.scrollArea}
                  contentContainerStyle={styles.scrollContent}
                  scrollEventThrottle={16}
                  showsVerticalScrollIndicator
                  keyboardShouldPersistTaps="handled"
                  {...(Platform.OS === "web" ? ({ overScrollMode: "never" } as any) : {})}
                >
                    {inner}
                </ScrollView>
            </View>
          )}
      </View>
    );
};

export default memo(TravelDescription);

const styles = StyleSheet.create({
    wrapper: {
        alignSelf: "center",
        width: "100%",
        maxWidth: 900,
        paddingHorizontal: 20,
        paddingTop: 20,
        paddingBottom: 40,
        backgroundColor: "transparent",
    },

    inner: {
        position: "relative",
        paddingTop: 6,
    },

    placeholder: {
        textAlign: "center",
        color: "#6b7280",
        fontSize: 15,
        paddingVertical: 8,
    },

    fixedHeightBlock: {
        borderWidth: 1,
        borderColor: "#DDD",
        borderRadius: 10,
        backgroundColor: "#FFF",
        overflow: "hidden",
        shadowColor: "#000",
        shadowOpacity: 0.05,
        shadowRadius: 5,
        shadowOffset: { width: 0, height: 2 },
        elevation: 2,
    },

    scrollArea: {},

    scrollContent: {
        paddingBottom: 8,
    },

    stamp: {
        position: "absolute",
        top: 4,
        right: 4,
        width: 60,
        height: 60,
        opacity: 0.25,
        zIndex: 1,
    },
});
