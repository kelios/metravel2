// components/MapPage/AddressListItem.tsx
import React, { useMemo, useCallback, useState } from 'react';
import {
    View,
    StyleSheet,
    Pressable,
    ImageBackground,
    Linking,
    useWindowDimensions,
    ActivityIndicator,
    Platform,
} from 'react-native';
import { Text, IconButton } from 'react-native-paper';
import * as Clipboard from 'expo-clipboard';
import Toast from 'react-native-toast-message';
import { TravelCoords } from '@/src/types/types';

type Props = {
    travel: TravelCoords;
    isMobile?: boolean;
    onPress?: () => void;
};

const addVersion = (url?: string, updated?: string) =>
  url && updated ? `${url}?v=${new Date(updated).getTime()}` : url;

/* helpers */
const parseCoord = (coord?: string) => {
    if (!coord) return null;
    const cleaned = coord.replace(/;/g, ',').replace(/\s+/g, '');
    const [latStr, lonStr] = cleaned.split(',').map(s => s.trim());
    const lat = Number(latStr), lon = Number(lonStr);
    return Number.isFinite(lat) && Number.isFinite(lon) ? { lat, lon } : null;
};

const buildMapUrl = (coord?: string) => {
    const p = parseCoord(coord);
    return p ? `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}` : '';
};

const openExternal = async (url?: string) => {
    if (!url) return;
    try {
        const can = await Linking.canOpenURL(url);
        if (can) await Linking.openURL(url);
        else Toast.show({ type: 'info', text1: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É', position: 'bottom' });
    } catch {
        Toast.show({ type: 'info', text1: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É', position: 'bottom' });
    }
};

const AddressListItem: React.FC<Props> = ({
                                              travel,
                                              isMobile: isMobileProp,
                                              onPress,
                                          }) => {
    const {
        address,
        categoryName,
        coord,
        travelImageThumbUrl,
        articleUrl,
        urlTravel,
        updated_at,
    } = travel;

    const [imgLoaded, setImgLoaded] = useState(false);
    const [hovered, setHovered] = useState(false);

    const { width } = useWindowDimensions();
    const isMobile = isMobileProp ?? width <= 768;

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–∏ –≤—Å–µ–≥–¥–∞ –Ω–∞ –º–æ–±–∏–ª–µ –∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ hover –Ω–∞ web
    const showOverlays = isMobile || hovered;

    const categories = useMemo(
      () => categoryName?.split(',').map((c) => c.trim()).filter(Boolean) ?? [],
      [categoryName]
    );

    const showToast = useCallback((msg: string) => {
        Toast.show({ type: 'info', text1: msg, position: 'bottom' });
    }, []);

    const copyCoords = useCallback(async () => {
        if (!coord) return;
        try {
            if (Platform.OS === 'web' && navigator.clipboard) {
                await navigator.clipboard.writeText(coord);
            } else {
                await Clipboard.setStringAsync(coord);
            }
            showToast('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã');
        } catch {
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        }
    }, [coord, showToast]);

    const openTelegram = useCallback(async () => {
        if (!coord) return;
        const mapUrl = buildMapUrl(coord);
        const text = `üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coord}`;

        // 1) –ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram
        const deeplinks = [
            `tg://msg_url?url=${encodeURIComponent(mapUrl)}&text=${encodeURIComponent(text)}`,
            `tg://share?text=${encodeURIComponent(`${text}\n${mapUrl}`)}`,
        ];

        for (const dl of deeplinks) {
            try {
                const can = await Linking.canOpenURL(dl);
                if (can) {
                    await Linking.openURL(dl);
                    return;
                }
            } catch {
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Å—Å—ã–ª–∫—É
                continue;
            }
        }

        // 2) –≤–µ–±-—à–µ—Ä–∏–Ω–≥
        await openExternal(`https://t.me/share/url?url=${encodeURIComponent(mapUrl)}&text=${encodeURIComponent(text)}`);
    }, [coord]);

    const openMap = useCallback((e: any) => {
        e?.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        openExternal(buildMapUrl(coord));
    }, [coord]);

    const openArticle = useCallback((e?: any) => {
        e?.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        openExternal(articleUrl || urlTravel);
    }, [articleUrl, urlTravel]);

    const handleMainPress = useCallback(() => {
        if (onPress) {
            onPress();
        } else {
            openArticle();
        }
    }, [onPress, openArticle]);

    const handleIconPress = useCallback((handler: () => void) => {
        return (e: any) => {
            e?.stopPropagation(); // –í–∞–∂–Ω–æ: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Pressable
            handler();
        };
    }, []);

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    const height = isMobile ? 280 : 400; // –ë—ã–ª–æ 200, —Å—Ç–∞–ª–æ 280

    return (
      <View
        style={[styles.card, { height }]}
        onMouseEnter={() => !isMobile && setHovered(true)}
        onMouseLeave={() => !isMobile && setHovered(false)}
      >
          <ImageBackground
            source={
                travelImageThumbUrl
                  ? { uri: addVersion(travelImageThumbUrl, updated_at) }
                  : require('@/assets/no-data.webp')
            }
            style={styles.image}
            imageStyle={{ borderRadius: 12 }}
            onLoadEnd={() => setImgLoaded(true)}
            resizeMode="cover"
          >
              {!imgLoaded && (
                <View style={styles.loader}>
                    <ActivityIndicator size="small" color="#fff" />
                </View>
              )}

              {/* –û—Å–Ω–æ–≤–Ω–æ–π Pressable –¥–ª—è –≤—Å–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */}
              <Pressable
                style={styles.mainPressable}
                onPress={handleMainPress}
                accessibilityRole="button"
                accessibilityLabel={`–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—å—é: ${address || '–ú–µ—Å—Ç–æ'}`}
                android_ripple={{ color: '#00000020' }}
                onLongPress={copyCoords}
              >
                  <View style={styles.mainPressArea} />
              </Pressable>

              {/* –≤–µ—Ä—Ö–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ ‚Äî –ø–æ hover –Ω–∞ web, –≤—Å–µ–≥–¥–∞ –Ω–∞ –º–æ–±–∏–ª–µ */}
              {showOverlays && (
                <View style={styles.iconCol}>
                    <IconButton
                      icon="link"
                      size={20}
                      onPress={handleIconPress(openArticle)}
                      iconColor="#fff"
                      style={styles.iconBtn}
                      accessibilityLabel="–û—Ç–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—å—é"
                    />
                    <IconButton
                      icon="content-copy"
                      size={20}
                      onPress={handleIconPress(copyCoords)}
                      iconColor="#fff"
                      style={styles.iconBtn}
                      accessibilityLabel="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"
                    />
                    <IconButton
                      icon="send"
                      size={20}
                      onPress={handleIconPress(openTelegram)}
                      iconColor="#fff"
                      style={styles.iconBtn}
                      accessibilityLabel="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram"
                    />
                </View>
              )}

              {/* –Ω–∏–∂–Ω—è—è –ø–ª–∞—à–∫–∞ ‚Äî –ø–æ hover –Ω–∞ web, –≤—Å–µ–≥–¥–∞ –Ω–∞ –º–æ–±–∏–ª–µ */}
              {showOverlays && (
                <View style={styles.overlay}>
                    {!!address && (
                      <Text style={styles.title} numberOfLines={2}>
                          {address}
                      </Text>
                    )}

                    {!!coord && (
                      <Pressable
                        onPress={openMap}
                        style={styles.coordPressable}
                        accessibilityRole="button"
                        accessibilityLabel="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É"
                      >
                          <Text style={styles.coord}>{coord}</Text>
                      </Pressable>
                    )}

                    {!!categories.length && (
                      <View style={styles.catWrap}>
                          {categories.slice(0, 3).map((cat, i) => ( // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                            <View key={`${cat}-${i}`} style={styles.catChip}>
                                <Text style={styles.catText}>{cat}</Text>
                            </View>
                          ))}
                          {categories.length > 3 && (
                            <View style={styles.catChip}>
                                <Text style={styles.catText}>+{categories.length - 3}</Text>
                            </View>
                          )}
                      </View>
                    )}
                </View>
              )}
          </ImageBackground>
      </View>
    );
};

const styles = StyleSheet.create({
    card: {
        marginVertical: 8,
        marginHorizontal: 4,
        borderRadius: 12,
        backgroundColor: '#f3f3f3',
        elevation: 2,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        overflow: 'hidden',
        position: 'relative',
    },
    image: {
        flex: 1,
        justifyContent: 'flex-end',
    },
    loader: {
        ...StyleSheet.absoluteFillObject,
        backgroundColor: '#00000030',
        justifyContent: 'center',
        alignItems: 'center',
        borderRadius: 12,
    },
    mainPressable: {
        ...StyleSheet.absoluteFillObject,
        zIndex: 1,
    },
    mainPressArea: {
        flex: 1,
    },

    // –∏–∫–æ–Ω–∫–∏ ‚Äî —Å—Ç–æ–ª–±–∏–∫–æ–º, –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Ç—ë–º–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    iconCol: {
        position: 'absolute',
        top: 12,
        right: 12,
        zIndex: 3,
        gap: 8,
    },
    iconBtn: {
        backgroundColor: 'rgba(0,0,0,0.7)',
        margin: 0,
        borderRadius: 12,
        width: 44,
        height: 44,
        justifyContent: 'center',
        alignItems: 'center',
    },

    overlay: {
        padding: 16,
        backgroundColor: 'rgba(0,0,0,0.7)',
        borderBottomLeftRadius: 12,
        borderBottomRightRadius: 12,
        zIndex: 2,
        position: 'relative',
    },
    title: {
        color: '#fff',
        fontWeight: '800',
        fontSize: 16,
        marginBottom: 8,
        lineHeight: 20,
    },
    coordPressable: {
        alignSelf: 'flex-start',
        marginBottom: 8,
    },
    coord: {
        color: '#fff',
        textDecorationLine: 'underline',
        fontSize: 14,
        fontWeight: '600',
    },
    catWrap: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 6,
    },
    catChip: {
        backgroundColor: 'rgba(255,255,255,0.25)',
        borderRadius: 12,
        paddingHorizontal: 10,
        paddingVertical: 4,
    },
    catText: {
        color: '#fff',
        fontSize: 12,
        fontWeight: '600',
    },
});

export default React.memo(AddressListItem);