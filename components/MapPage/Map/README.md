# Map Module - –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫–∞—Ä—Ç—ã

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
Map/
‚îú‚îÄ‚îÄ üìÑ ClusterLayer.tsx          # –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ üìÑ MapControls.tsx           # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ)
‚îú‚îÄ‚îÄ üìÑ MapLogicComponent.tsx     # –õ–æ–≥–∏–∫–∞ –∫–∞—Ä—Ç—ã (—Å–æ–±—ã—Ç–∏—è, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
‚îú‚îÄ‚îÄ üìÑ MapMarkers.tsx            # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –±–µ–∑ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ üìÑ constants.ts              # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (zoom, grid, breakpoints)
‚îú‚îÄ‚îÄ üìÑ types.ts                  # TypeScript —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ üìÑ utils.ts                  # –£—Ç–∏–ª–∏—Ç—ã (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∫–ª–∞—Å—Ç–µ—Ä—ã)
‚îú‚îÄ‚îÄ üìÑ useClustering.ts          # –•—É–∫ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ üìÑ useLeafletIcons.ts        # –•—É–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–∫–æ–Ω–æ–∫
‚îú‚îÄ‚îÄ üìÑ useMapApi.ts              # –•—É–∫ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API –∫–∞—Ä—Ç—ã
‚îú‚îÄ‚îÄ üìÑ useMapCleanup.ts          # –•—É–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
‚îî‚îÄ‚îÄ üìÑ useMapInstance.ts         # –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º –∫–∞—Ä—Ç—ã
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:** 14
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:** 4
- **–•—É–∫–æ–≤:** 5
- **–£—Ç–∏–ª–∏—Ç:** 3
- **–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä:** ~1200 —Å—Ç—Ä–æ–∫ (–±—ã–ª–æ 1786 –≤ –º–æ–Ω–æ–ª–∏—Ç–µ)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### ClusterLayer.tsx
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤  
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** `utils.ts`, `types.ts`  
**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä—ã
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–∫–æ–Ω–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- Zoom –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä
- –†–∞—Å–∫—Ä—ã—Ç–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞

#### MapControls.tsx
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π  
**–§—É–Ω–∫—Ü–∏–∏:**
- –ö–Ω–æ–ø–∫–∞ "–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
- –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

#### MapLogicComponent.tsx
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ –∫–∞—Ä—Ç—ã  
**–§—É–Ω–∫—Ü–∏–∏:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞—Ä—Ç—ã
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ zoom
- Auto-fit bounds

#### MapMarkers.tsx
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤  
**–§—É–Ω–∫—Ü–∏–∏:**
- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–∞—Ä–∫–µ—Ä–æ–≤ –±–µ–∑ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- Popup –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞

### –•—É–∫–∏

#### useClustering.ts
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏  
**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `shouldRenderClusters` - –Ω—É–∂–Ω–∞ –ª–∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è
- `clusters` - –º–∞—Å—Å–∏–≤ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- `visiblePoints` - –≤–∏–¥–∏–º—ã–µ —Ç–æ—á–∫–∏

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `points` - –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫
- `mapZoom` - —Ç–µ–∫—É—â–∏–π zoom
- `expandedClusterKey` - –∫–ª—é—á —Ä–∞—Å–∫—Ä—ã—Ç–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞

#### useLeafletIcons.ts
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ –¥–ª—è Leaflet  
**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```typescript
{
  meTravel: Icon,      // –ò–∫–æ–Ω–∫–∞ —Ç–æ—á–∫–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
  start: Icon,         // –ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
  end: Icon,           // –ò–∫–æ–Ω–∫–∞ –∫–æ–Ω—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–∞
  userLocation: Icon   // –ò–∫–æ–Ω–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
}
```

#### useMapApi.ts
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—É–±–ª–∏—á–Ω—ã–π API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π  
**–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç:**
```typescript
interface MapUiApi {
  fitBounds: () => void;
  setView: (lat, lng, zoom) => void;
  getZoom: () => number;
  // ... –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
}
```

#### useMapCleanup.ts
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∫–∞ Leaflet –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤  
**–§—É–Ω–∫—Ü–∏–∏:**
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø—Ä–∏ unmount
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ "Map container is being reused"

#### useMapInstance.ts
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏ –∫–∞—Ä—Ç—ã  
**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `leafletBaseLayerRef` - –±–∞–∑–æ–≤—ã–π —Å–ª–æ–π
- `leafletOverlayLayersRef` - –æ–≤–µ—Ä–ª–µ–∏
- `leafletControlRef` - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–ª–æ–µ–≤

### –£—Ç–∏–ª–∏—Ç—ã

#### constants.ts
**–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:**
```typescript
DEFAULT_ROUTE_ZOOM = 13
DEFAULT_ZOOM = 11
CLUSTER_EXPAND_ZOOM = 15
CLUSTER_GRID = 0.045
CLUSTER_THRESHOLD = 25
MOBILE_BREAKPOINT = 768
LEAFLET_MAP_CONTAINER_ID_PREFIX = 'metravel-leaflet-map'
```

#### types.ts
**–¢–∏–ø—ã:**
- `Point` - —Ç–æ—á–∫–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
- `Coordinates` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
- `TransportMode` - —Ä–µ–∂–∏–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
- `MapMode` - —Ä–µ–∂–∏–º –∫–∞—Ä—Ç—ã
- `MapProps` - –ø—Ä–æ–ø—Å—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- `ClusterData` - –¥–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä–∞

#### utils.ts
**–§—É–Ω–∫—Ü–∏–∏:**
```typescript
strToLatLng(s: string): [number, number] | null
buildClusterKey(center, count): string
getClusterGridForZoom(zoom): number
generateUniqueId(): string
```

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –í–Ω–µ—à–Ω–∏–µ
- `react` - React –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
- `react-native` - React Native –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `leaflet` - –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–∞—Ä—Ç (web)
- `react-leaflet` - React –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è Leaflet

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ
- `@/utils/coordinateConverter` - –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- `@/hooks/useTheme` - –•—É–∫ —Ç–µ–º—ã
- `@/constants/layout` - –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã layout

## üìñ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ò–º–ø–æ—Ä—Ç –≤ Map.web.tsx
```typescript
import { useMapCleanup } from './Map/useMapCleanup';
import { useLeafletIcons } from './Map/useLeafletIcons';
import { useMapInstance } from './Map/useMapInstance';
import { useMapApi } from './Map/useMapApi';
import { useClustering } from './Map/useClustering';
import { MapLogicComponent } from './Map/MapLogicComponent';
import MapMarkers from './Map/MapMarkers';
import ClusterLayer from './Map/ClusterLayer';
import MapControls from './Map/MapControls';
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
```typescript
const { shouldRenderClusters } = useClustering(
  travelData, 
  mapZoom, 
  expandedCluster?.key || null
);

// –£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
{shouldRenderClusters ? (
  <ClusterLayer points={travelData} ... />
) : (
  <MapMarkers points={travelData} ... />
)}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API
```typescript
useMapApi({
  map: mapInstance,
  L,
  onMapUiApiReady: (api) => {
    // api.fitBounds()
    // api.setView(lat, lng, zoom)
  },
  travelData,
  userLocation,
  routePoints,
  // ...
});
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º–æ–¥—É–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### –ë—ã–ª–æ (–º–æ–Ω–æ–ª–∏—Ç)
- ‚ùå 1786 —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- ‚ùå –°–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- ‚ùå –¢—Ä—É–¥–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚ùå –ü–ª–æ—Ö–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å

### –°—Ç–∞–ª–æ (–º–æ–¥—É–ª–∏)
- ‚úÖ 518 —Å—Ç—Ä–æ–∫ –≤ –≥–ª–∞–≤–Ω–æ–º —Ñ–∞–π–ª–µ (-71%)
- ‚úÖ 14+ –º–æ–¥—É–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- ‚úÖ –ü—Ä–æ—Å—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã
```bash
npm test -- Map/
```

### Lint –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
npx eslint components/MapPage/Map/*.ts*
```

### TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
npx tsc --noEmit
```

## üìù –°–æ–≥–ª–∞—à–µ–Ω–∏—è

### –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** PascalCase (MapControls.tsx)
- **–•—É–∫–∏:** camelCase —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `use` (useMapApi.ts)
- **–£—Ç–∏–ª–∏—Ç—ã:** camelCase (utils.ts)
- **–¢–∏–ø—ã:** PascalCase (types.ts)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
```typescript
// 1. –ò–º–ø–æ—Ä—Ç—ã
import React from 'react';
import { ... } from '...';

// 2. –¢–∏–ø—ã
interface Props { ... }

// 3. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
const CONSTANT = 'value';

// 4. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç/—Ö—É–∫/—É—Ç–∏–ª–∏—Ç–∞
export const Component = () => { ... };

// 5. –≠–∫—Å–ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
export default Component;
```

## üîÑ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### v1.0.0 (3 —è–Ω–≤–∞—Ä—è 2026)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω –º–æ–Ω–æ–ª–∏—Ç –Ω–∞ 14 —Ñ–∞–π–ª–æ–≤
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ 71%
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üöÄ –ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ

- [ ] –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Ö—É–∫–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å Storybook –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É React.lazy –¥–ª—è code splitting

---

*–°–æ–∑–¥–∞–Ω–æ: 3 —è–Ω–≤–∞—Ä—è 2026*  
*–í–µ—Ä—Å–∏—è: 1.0.0*  
*–°—Ç–∞—Ç—É—Å: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é*

