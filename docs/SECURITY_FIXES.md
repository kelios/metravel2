# üîí –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –±–∞–≥–∏ (Security Fixes)

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç –∏ –±–∞–≥–æ–≤ –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ.

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **XSS –£—è–∑–≤–∏–º–æ—Å—Ç—å –≤ ContentParser (–ö–†–ò–¢–ò–ß–ù–û)**

**–§–∞–π–ª:** `src/services/pdf-export/parsers/ContentParser.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `element.innerHTML` –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `escapeHtml()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
- –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `innerHTML` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `escapeHtml(element.innerHTML)`
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω fallback –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

```typescript
private escapeHtml(text: string): string {
  if (typeof document === 'undefined') {
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
```

---

### 2. **–û–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ eval() –≤ —Ç–µ—Å—Ç–∞—Ö (–ö–†–ò–¢–ò–ß–ù–û)**

**–§–∞–π–ª:** `__tests__/app/analyticsInlineScript.test.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `eval(snippet)` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞ - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ `Function` –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:
```typescript
const analyticsFunction = new Function(snippet);
analyticsFunction.call(global);
```

---

### 3. **–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ Type Assertions –≤ API (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)**

**–§–∞–π–ª:** `src/api/map.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `[] as unknown as Type` –∏ `{} as unknown as Type` - –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ type assertions.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–æ–º
- `[] as unknown as TravelsForMap` ‚Üí `[]` (—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π)
- `[] as unknown as Filters` ‚Üí `{ countries: [], categories: [], ... }` (–ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 3 —Ñ—É–Ω–∫—Ü–∏—è—Ö:
- `fetchTravelsForMap()`
- `fetchTravelsNearRoute()`
- `fetchFiltersMap()`

---

### 4. **–û–ø–∞—Å–Ω—ã–π Type Assertion –≤ API Client (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)**

**–§–∞–π–ª:** `src/api/client.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** `text as unknown as T` –≤ –º–µ—Ç–æ–¥–µ `parseSuccessResponse()` - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—Ç `null` –≤–º–µ—Å—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ type assertion:
```typescript
try {
  return JSON.parse(text) as T;
} catch {
  if (__DEV__) {
    devError('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', text.substring(0, 100));
  }
  return null as T;
}
```

---

### 5. **–ü—É—Å—Ç—ã–µ Catch –ë–ª–æ–∫–∏ (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–ª—á–∞–ª–∏–≤–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ `.catch(() => {})` –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –æ—Ç–ª–∞–¥–∫—É –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `components/WeatherWidget.tsx` - –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã
- `components/travel/FiltersUpsertComponent.tsx` - –æ—Ç–∫—Ä—ã—Ç–∏–µ URL
- `components/travel/TelegramDiscussionSection.tsx` - –æ—Ç–∫—Ä—ã—Ç–∏–µ Telegram
- `components/travel/StableContent.tsx` (2 –º–µ—Å—Ç–∞) - YouTube –∏ —Å—Å—ã–ª–∫–∏
- `components/travel/ShareButtons.tsx` - —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏
- `components/travel/Slider.tsx` - –ø—Ä–µ–ª–æ–∞–¥–∏–Ω–≥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `components/FooterDesktop.tsx` - –æ—Ç–∫—Ä—ã—Ç–∏–µ URL
- `app/+html.tsx` - –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `app/_layout.tsx` (2 –º–µ—Å—Ç–∞) - SplashScreen
- `app/(tabs)/about.tsx` (3 –º–µ—Å—Ç–∞) - –ø–æ—á—Ç–∞, YouTube, URL

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É—Å–ª–æ–≤–Ω–æ–π –æ—Ç–ª–∞–¥–∫–æ–π:
```typescript
.catch((error) => {
  if (__DEV__) {
    console.warn('[Component] Error message:', error);
  }
});
```

---

### 6. **–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—á–∏—â–µ–Ω–∏–µ DOM –≤ StableContent (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)**

**–§–∞–π–ª:** `components/travel/StableContent.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `root.innerHTML = ""` –¥–ª—è –æ—á–∏—â–µ–Ω–∏—è DOM.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ `replaceChildren()`:
```typescript
// –ë—ã–ª–æ:
root.innerHTML = "";

// –°—Ç–∞–ª–æ:
root.replaceChildren();
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ –ø—Ä–æ—Ç–∏–≤ XSS
- –ü—Ä–∞–≤–∏–ª—å–Ω–µ–µ —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —É–∑–ª—ã
- –õ—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π

---

## üõ°Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### Type Safety
- ‚úÖ –£–±—Ä–∞–Ω—ã –≤—Å–µ `as unknown as Type` assertions
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –∏–ª–∏ null
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

### XSS Protection
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML –≤ ContentParser
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ innerHTML –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ textContent –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ replaceChildren() –≤–º–µ—Å—Ç–æ innerHTML = ""
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ sanitizeRichText() –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### Error Handling
- ‚úÖ –í—Å–µ .catch(() => {}) –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ª–æ–≤–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ __DEV__
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### Code Quality
- ‚úÖ –£–¥–∞–ª–µ–Ω eval() –∏–∑ —Ç–µ—Å—Ç–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π

- [ ] –û–±–Ω–æ–≤–∏—Ç—å tsconfig.json —Å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ (`strict: true`)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–∏–Ω—Ç–∏–Ω–≥ –¥–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∏—è `as unknown as any`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏
- [ ] –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DOMPurify –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ SAST
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–µ –ø–æ –∑–∞—â–∏—Ç–µ –æ—Ç XSS

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ö–æ–º–ø–∏–ª—è—Ü–∏—è TypeScript
```bash
npx tsc --noEmit
```

### 2. –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–∞
```bash
npm run lint
```

### 3. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
npm test
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã –≤ API —Ñ–∞–π–ª–∞—Ö
npx tsc --noEmit src/api/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ContentParser
npx tsc --noEmit src/services/pdf-export/
```

---

## üìö –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

- [OWASP: XSS Prevention](https://owasp.org/www-community/attacks/xss/)
- [MDN: innerHTML](https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML)
- [React: Dangerously Set HTML](https://react.dev/reference/react-dom/dangerouslySetInnerHTML)
- [TypeScript: Type Assertions](https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#type-assertions)

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
- ‚úÖ 0 XSS —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- ‚úÖ 0 eval() –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- ‚úÖ 0 –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö type assertions
- ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ–≤–µ—Ä–∫–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 29 –¥–µ–∫–∞–±—Ä—è 2025 –≥.
**–í—Å–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 14 —Ñ–∞–π–ª–æ–≤, 25+ –ø—Ä–æ–±–ª–µ–º

