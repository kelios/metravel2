# План улучшений UI/UX для /travel/new

## 1. Контекст
- **Продукт**: мастер добавления/редактирования путешествия (UpsertTravel + шаги 1–6).
- **Ограничения**: изменения только на фронтенде, без бэкенд-правок.
- **Цели**: повысить понятность процесса, видимость прогресса и статуса автосохранения, снизить количество ошибок при заполнении.

## 2. Приоритеты (по очереди внедрения)
1. **Онбординг и прогресс** (выполнено)
   - [x] Шаговые карточки с подсказками + визуальный прогресс-бар. (`UpsertTravel`, `TravelWizardStepBasic`, `TravelWizardStepRoute`, `TravelWizardStepPublish`)
   - [x] Сохранить “Step n of 5”, но сделать его вторичным. (subtitle в хедере шагов)
2. **Валидация и обратная связь** (частично)
   - [x] Sticky-summary для ошибок (на шаге 1). (`TravelWizardStepBasic`)
   - [x] Авто-скролл к первому полю (на шаге 1 для `name`). (`ContentUpsertSection` + `UpsertTravel`)
   - [x] Переходы между шагами свободные; единственная блокировка навигации — `name` на шаге 1. (`utils/formValidation.ts` + `UpsertTravel`)
   - [x] Полная проверка обязательных полей выполняется только при “Отправить на модерацию” (включая `categories`). (`utils/formValidation.ts` + `TravelWizardStepPublish`)
   - [ ] Подсветка/переход к полям по клику “Отправить на модерацию” (включая категорию на шаге публикации).
3. **Прозрачность автосохранения** (выполнено)
   - [x] Чип статуса («Черновик сохранён 10:35», «Сохраняем…», «Ошибка»). (`UpsertTravel` → `autosaveBadge`, вывод в шагах)
   - [x] Подтверждение ручного сохранения баннером/toast. (`UpsertTravel` → `handleManualSave`)
4. **Маршрут (шаг 2)** (выполнено)
   - [x] Tooltip/coachmark «Добавьте первую точку кликом по карте». (`TravelWizardStepRoute`)
   - [x] Кнопка/форма ручного ввода точки. (`TravelWizardStepRoute`)
   - [x] Вставка координат одной строкой (`lat, lng`), например `49.609645, 18.845693`. (`TravelWizardStepRoute`)
   - [x] Бейдж «Страны синхронизированы» после автообновления. (`TravelWizardStepRoute`)
5. **Макет панелей** (не выполнено)
   - [x] Панель убрана: шаг 1 упрощён, фильтры вынесены по шагам. (`TravelWizardStepBasic`, `UpsertTravel`)
6. **Состояния доступа** (частично)
   - [ ] Экран для гостей (CTA «Войдите, чтобы создавать маршруты»).
   - [x] Предупреждение/блокировка при попытке редактировать чужой маршрут. (`UpsertTravel` проверка owner/super-admin)
7. **Loading/Skeleton** (частично)
   - [x] Начальный skeleton экрана на время загрузки. (`UpsertTravel`)
   - [x] Skeleton загрузки фильтров на шаге 2. (`TravelWizardStepRoute`)
   - [ ] Шаговые skeleton’ы (по каждому шагу мастера).
   - [ ] Ленивый импорт карты и медиа.

## 3. Подробности по этапам
| Этап | Ключевые задачи | Компоненты |
|------|-----------------|------------|
| 1. Онбординг + прогресс | ✅ StepMeta конфиг, прогресс-бар, подсказки, автосейв-бейдж | `UpsertTravel`, `TravelWizardStepBasic`, `TravelWizardStepRoute`, `TravelWizardFooter` |
| 2. Валидация | ◑ Sticky summary + scrollToInvalidField (шаг 1), свободная навигация между шагами, обязательные поля проверяются при модерации (включая `categories`), осталось: подсветка/переход к проблемным шагам по клику “Отправить на модерацию” | `TravelWizardStepBasic`, `TravelWizardStepPublish`, `ContentUpsertSection`, `formValidation` |
| 3. Автосохранение | ✅ Чип статуса + toast после ручного save | `UpsertTravel`, `TravelWizardStep*`, `useImprovedAutoSave` |
| 4. Маршрут | ✅ Tooltip/coachmark, ручной ввод точки (включая формат `lat, lng`), бейдж синхронизации стран; переход дальше не блокируется (требование — только для модерации) | `TravelWizardStepRoute`, `WebMapComponent` |
| 5. Реструктуризация шагов | ✅ Шаг 1 упрощён; добавлен шаг 5 “Доп. параметры”; публикация перенесена на шаг 6; категории обязательны при модерации | `UpsertTravel`, `TravelWizardStepBasic`, `TravelWizardStepExtras`, `TravelWizardStepPublish`, `FiltersUpsertComponent` |
| 6. Доступ | ◑ Блокировка чужого маршрута сделана, осталось: гостевой экран | `UpsertTravel`, `AuthContext` (только UI), отдельный компонент Notice |
| 7. Skeleton + lazy | ◑ Есть базовые skeleton'ы, осталось: шаговые skeleton’ы и lazy для карты/медиа | `TravelWizardStep*`, `WebMapComponent`, `ImageUploadComponent` |

## 4. Инварианты и гейты (текущее правило)
- **Навигация между шагами**
  - Разрешена свободно.
  - Единственный гейт на переход: **`name` на шаге 1** (если пусто — не даём уйти дальше).
- **Гейт на “Отправить на модерацию”**
  - Выполняется **полная валидация всех обязательных полей**, включая `categories`.
  - Если валидация не проходит — публикация не выполняется.
- **Сохранение**
  - Автосохранение может происходить на любом шаге.
  - Ошибка автосохранения не должна блокировать навигацию, но должна быть видимой (badge/notice).

## 5. Поведение при ошибках на “Отправить на модерацию” (что нужно дописать/сделать)
Цель: при клике “Отправить на модерацию”, если не хватает данных, пользователь должен:
- Быстро понять, **что именно не заполнено**
- Понять, **на каком шаге** это исправляется
- Попасть **в нужный шаг/место** с минимальным количеством действий

### 5.1. Требуемое UX-поведение
- При ошибке модерации показываем summary с группировкой по шагам.
- Клик по пункту summary:
  - Переводит на нужный шаг.
  - Подсвечивает соответствующий блок/поле (если применимо).
  - Скроллит к нужному полю/секции на шаге.

### 5.2. Acceptance criteria
- [ ] Если отсутствуют `categories`, клик по ошибке переводит на шаг 6 и фокусирует/подсвечивает блок категорий.
- [ ] Если отсутствуют фото/медиа, клик переводит на шаг с медиа и фокусирует uploader.
- [ ] Если не хватает точек маршрута, клик переводит на шаг 2 и фокусирует карту/лист точек.
- [ ] Поведение одинаково на web и native (без “скачков” layout).

## 6. Guest screen (что нужно дописать/сделать)
- Сценарий: неавторизованный пользователь открывает `/travel/new`.
- Ожидаемое поведение:
  - Показать экран/вставку с CTA “Войдите, чтобы создавать маршруты”.
  - Не показывать форму мастера (или показывать read-only демо — только если это отдельно решим).
- Acceptance criteria:
  - [ ] CTA ведёт в актуальный auth flow.
  - [ ] Возврат после логина возвращает пользователя в мастер (желательно на шаг 1).

## 7. Skeleton и lazy import (что нужно дописать/сделать)
- Зачем: ускорить первый рендер и уменьшить “тяжёлые” зависимости (карта/медиа).
- Стратегия:
  - Step-specific skeleton: при заходе на шаг показывать “локальный” skeleton только контента шага.
  - Lazy-load:
    - Карта подгружается только на шаге 2.
    - Медиа/uploader подгружается только на соответствующем шаге.
- Acceptance criteria:
  - [ ] Первый рендер мастера без карты/медиа происходит быстрее (визуально и по профайлу).
  - [ ] На слабых устройствах нет зависаний при первом открытии `/travel/new`.

## 8. UX-polish / Copy
- [ ] Привести все тексты “Step n of …” к **“из 6”** (сейчас местами встречается “из 5”).
- [ ] Единообразие терминов: “Отправить на модерацию” / “Опубликовать” / “Публикация”.

## 9. Риски и открытые вопросы
- **Сложность jump-to-field**: поля живут на разных шагах, часть из них не input’ы (карта/категории).
- **Единый формат ошибок**: нужно договориться о структуре ошибок (id поля, шаг, label, optional scroll anchor).
- **Перфоманс**: lazy import карты/медиа может потребовать аккуратного suspense/placeholder, чтобы не было дерганий.

## 10. Следующие шаги (рабочий план)
1. Реализовать mapping ошибок модерации → шаг/anchor + кликабельный summary.
2. Добавить guest screen.
3. Ввести step-specific skeleton’ы + lazy import карты/медиа.
4. Пройтись по UI и заменить “из 5” → “из 6”, обновить тесты.
