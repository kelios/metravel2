# ТЗ: Рефакторинг страницы карты MeTravel

> **Дата:** 6 февраля 2026  
> **Область:** UI/UX страницы карты `/map`  
> **Подход:** Анализ текущей реализации + лучшие практики картографических интерфейсов  
> **Основа:** DESIGN_SYSTEM_CONSOLIDATION.md, UI_UX_IMPROVEMENT_SPEC.md, текущий код

---

## Содержание

1. [Executive Summary](#1-executive-summary)
2. [Текущее состояние](#2-текущее-состояние)
3. [Проблемы UX](#3-проблемы-ux)
4. [Что добавить](#4-что-добавить)
5. [Что изменить](#5-что-изменить)
6. [Что удалить](#6-что-удалить)
7. [Приоритизация](#7-приоритизация)
8. [Технические требования](#8-технические-требования)
9. [Метрики успеха](#9-метрики-успеха)

---

## 1. Executive Summary

Страница карты — ключевой элемент платформы MeTravel, но текущая реализация имеет проблемы с:
- **Когнитивной нагрузкой**: слишком много контролов, неочевидная навигация
- **Мобильным UX**: Bottom Sheet конфликтует с контролами карты
- **Визуальной иерархией**: нет фокуса на главном действии
- **Обратной связью**: нет подтверждений действий пользователя

**Цель рефакторинга:** Сделать карту интуитивной, быстрой и приятной в использовании на всех устройствах.

---

## 2. Текущее состояние

### 2.1. Архитектура

**Основные компоненты:**
- `MapScreen.tsx` (333 строки) — контроллер с логикой
- `MapMobileLayout.tsx` (392 строки) — мобильная версия с Bottom Sheet
- `Map.web.tsx` (1220 строк) — Leaflet-карта
- `MapPanel.tsx` (166 строк) — обёртка для карты
- `FiltersPanel.tsx` (176 строк) — фильтры
- `TravelListPanel.tsx` (164 строки) — список мест
- `AddressListItem.tsx` (856 строк) — карточка места в списке
- `MapPeekPreview.tsx` (260 строк) — превью топ-3 мест

**Состояния интерфейса:**

| Платформа | Режим | Панели | Особенности |
|-----------|-------|--------|-------------|
| Desktop | `radius` | Фильтры (слева) + Карта (справа) | Панель всегда видна |
| Desktop | `route` | Фильтры (слева) + Карта (справа) | Строитель маршрута |
| Mobile Web | `radius` | Bottom Sheet (снизу) + Карта (фон) | Peek Preview топ-3 |
| Mobile Web | `route` | Bottom Sheet (снизу) + Карта (фон) | CTA "Построить маршрут" |
| Native | `radius` | Modal-панель | Карта доступна только на web |

### 2.2. Визуальная структура

**Desktop (≥768px):**
```
┌────────────────────────────────────────────┐
│ Header (CustomHeader)                      │
├─────────────────┬──────────────────────────┤
│ LEFT PANEL      │ MAP AREA                 │
│ ┌─────────────┐ │ ┌──────────────────────┐ │
│ │ Tabs:       │ │ │ Leaflet Map          │ │
│ │ [Фильтры]   │ │ │                      │ │
│ │ [Список]    │ │ │ Controls (R):        │ │
│ ├─────────────┤ │ │ - Zoom +/-           │ │
│ │ Content:    │ │ │ - Layers             │ │
│ │ - FiltersP. │ │ │ - Center on User     │ │
│ │ - TravelL.  │ │ │                      │ │
│ │             │ │ │ Markers:             │ │
│ │             │ │ │ - Clusters           │ │
│ │             │ │ │ - Individual pins    │ │
│ │             │ │ │                      │ │
│ │ Footer CTA  │ │ │                      │ │
│ └─────────────┘ │ └──────────────────────┘ │
└─────────────────┴──────────────────────────┘
```

**Mobile (<768px):**
```
┌────────────────────────────┐
│ Header (CustomHeader)      │
├────────────────────────────┤
│ MAP (full screen)          │
│ ┌────────────────────────┐ │
│ │ Leaflet Map            │ │
│ │                        │ │
│ │ Controls (R):          │ │
│ │ - Zoom +/-             │ │
│ │ - Center on User       │ │
│ │                        │ │
│ └────────────────────────┘ │
├────────────────────────────┤
│ BOTTOM SHEET               │
│ ┌─ (drag handle) ─────┐   │
│ │ States:              │   │
│ │ - Collapsed (peek)   │   │
│ │ - Half               │   │
│ │ - Full               │   │
│ │                      │   │
│ │ Tabs: [Список][Фильтры]│
│ └──────────────────────┘   │
└────────────────────────────┘
```

### 2.3. Текущие режимы

1. **Radius mode** — поиск мест в радиусе от точки
2. **Route mode** — построение маршрута с точками A→B (+ промежуточные)

---

## 3. Проблемы UX

### 3.1. Когнитивная нагрузка (P1)

**Проблема:** Пользователь видит одновременно:
- Карту с кластерами/маркерами
- Панель фильтров с 10+ опциями
- Переключатель `radius`/`route`
- Переключатель транспорта (`car`/`bike`/`foot`)
- Список мест (может быть 50+)
- Контролы карты (zoom, layers, center)

**Результат:** Пользователь не понимает, с чего начать. Особенно новые пользователи.

**Решение:** 
- **Progressive disclosure** — показывать опции постепенно
- **Умолчания**: radius mode, car transport, автоматический радиус
- **Guided flow**: "Найти рядом" → "Настроить" → "Построить маршрут"

---

### 3.2. Мобильный Bottom Sheet (P1)

**Проблема:** Bottom Sheet перекрывает нижнюю часть карты в состоянии `half` и `full`. Контролы zoom находятся справа внизу — частично скрыты.

**Визуально:**
```
┌──────────────────┐
│ Map              │
│   ┌─zoom─┐       │ ← Контролы справа
│   │  +   │       │
│   │  -   │       │
│   └──────┘       │
├─BOTTOM SHEET─────┤ ← Перекрывает zoom
│ [List][Filters]  │
│ Content...       │
└──────────────────┘
```

**Решение:**
- Сдвинуть контролы карты вверх динамически в зависимости от состояния sheet
- Добавить `padding-bottom` для map controls при `sheetState === 'half' | 'full'`
- Альтернатива: переместить контролы в левый верхний угол (как в Google Maps)

---

### 3.3. Peek Preview — низкая информативность (P2)

**Проблема:** В collapsed состоянии показывается топ-3 места в горизонтальном скролле. Карточки мелкие, информации мало (только название + расстояние). Нет изображений.

**Текущий вид:**
```
┌─────────────────────────────────┐
│ [Место 1] [Место 2] [Место 3]   │
│ 2.3 км     5.1 км    12 км       │
└─────────────────────────────────┘
```

**Решение:**
- Добавить **thumbnail изображения** (40x40px) для каждого места
- Показать **категорию** (музей, парк, кафе)
- Убрать расстояние из peek (оставить в полном списке)
- Сделать карточки кликабельными — открывает детальную страницу

---

### 3.4. Фильтры — избыточность на мобильном (P2)

**Проблема:** На мобильном панель фильтров занимает 70% экрана в состоянии `full`. Пользователь теряет визуальный контекст карты.

**Решение:**
- На мобильном: показывать **только активные фильтры** в collapsed/half
- Кнопка "Больше фильтров" открывает `full` состояние
- В `full` — группировка: "Основные" (категория, радиус) и "Дополнительные" (теги, автор)

---

### 3.5. Обратная связь — отсутствие подтверждений (P1)

**Проблема:** При изменении фильтров, построении маршрута, центрировании карты — нет визуального feedback. Пользователь не уверен, что действие выполнено.

**Примеры:**
- Построен маршрут → нет toast "Маршрут построен (12.5 км)"
- Сброс фильтров → карта обновилась, но нет подтверждения
- Центрирование на пользователе → карта сдвинулась, но неясно почему

**Решение:**
- Добавить **toast-уведомления** для ключевых действий
- Анимировать изменения на карте (smooth pan/zoom)
- Показать индикатор загрузки при построении маршрута

---

### 3.6. Список мест — однообразие (P2)

**Проблема:** `TravelListPanel` показывает список карточек `AddressListItem` (856 строк!). Карточки большие, похожи друг на друга. При длинном списке сложно ориентироваться.

**Решение:**
- Добавить **group by distance**: "Рядом (0-2 км)", "Близко (2-10 км)", "Далеко (10+ км)"
- Альтернатива: **group by category**: "Музеи", "Парки", "Рестораны"
- Добавить **sticky headers** для групп

---

### 3.7. Route mode — неочевидность (P2)

**Проблема:** При переключении в `route` mode непонятно, как добавить точки маршрута. Нет инструкций.

**Текущий UX:**
1. Пользователь нажимает "Маршрут"
2. Видит карту и поля "Старт" / "Финиш"
3. Не понимает, как добавить точки — клик по карте? поиск?

**Решение:**
- **Route hint** (уже есть `RouteHint.tsx`, но скрыт): показать подсказку "Нажмите на карте, чтобы добавить точки маршрута"
- Добавить **кнопку "Добавить точку"** на карте (floating action button)
- При первом клике — toast "Точка добавлена. Добавьте ещё одну для построения маршрута"

---

### 3.8. Loading states — непоследовательность (P2)

**Проблема:** При загрузке карты показывается `MapPageSkeleton`, но при загрузке маршрута — только `ActivityIndicator` в правой панели. Визуально разные лоадеры.

**Решение:**
- Унифицировать: использовать `SkeletonLoader` везде
- При построении маршрута: показать skeleton линии маршрута на карте
- При загрузке списка: skeleton карточек в `TravelListPanel`

---

### 3.9. Desktop — фиксированная ширина панели (P3)

**Проблема:** Левая панель на desktop имеет фиксированную ширину 384px (`PANEL_WIDTH_DESKTOP`). На больших экранах (>1920px) панель выглядит узкой.

**Решение:**
- Сделать ширину адаптивной: `min(384px, 25vw)`
- Добавить **resize handle** (вертикальная полоска) для ручного изменения ширины (как в VS Code)

---

### 3.10. Accessibility — отсутствие клавиатурной навигации (P3)

**Проблема:** На desktop невозможно управлять картой с клавиатуры. Нет focus states для контролов.

**Решение:**
- Добавить `tabIndex` для всех интерактивных элементов
- Shortcuts: `+`/`-` — zoom, стрелки — pan, `F` — центрирование
- Focus ring для контролов (использовать `:focus-visible`)

---

## 4. Что добавить

### 4.1. Onboarding для карты (P1)

**Проблема:** Новые пользователи не понимают, как пользоваться картой.

**Решение:**
- При первом визите на `/map` — показать **интерактивный тур**:
  1. "Здесь отображаются места для путешествий"
  2. "Используйте фильтры, чтобы найти подходящее"
  3. "Или постройте маршрут между точками"
- Использовать `react-joyride` или собственный компонент с tooltips
- Показать 1 раз (флаг в `localStorage`)

**Файлы:**
- `components/MapPage/MapOnboarding.tsx` (новый)
- `screens/tabs/MapScreen.tsx` (добавить)

---

### 4.2. Quick Actions — избранные места (P2)

**Проблема:** Нет быстрого доступа к избранным местам на карте.

**Решение:**
- Добавить кнопку **"Мои места"** в Desktop панели или Mobile sheet
- При клике — фильтровать карту: показать только избранные
- Индикация: badge с количеством избранных мест

**Файлы:**
- `components/MapPage/QuickActions.tsx` (расширить)
- `components/MapPage/FiltersPanel.tsx` (добавить фильтр)

---

### 4.3. Share маршрута (P2)

**Проблема:** Пользователь построил маршрут, но не может поделиться им.

**Решение:**
- После построения маршрута — показать кнопку **"Поделиться"**
- Генерировать URL: `/map?route=lat1,lng1;lat2,lng2;...&transport=car`
- Кнопка копирует ссылку + toast "Ссылка скопирована"
- Поддержка социальных сетей: Telegram, VK, FB

**Файлы:**
- `components/MapPage/RouteShareButton.tsx` (новый)
- `components/MapPage/FiltersPanelFooter.tsx` (добавить)

---

### 4.4. Save маршрута (P3)

**Проблема:** Нет возможности сохранить построенный маршрут для повторного использования.

**Решение:**
- Кнопка **"Сохранить маршрут"** после построения
- Modal: "Название маршрута" + "Описание" + "Сохранить"
- Сохранённые маршруты в профиле: раздел "Мои маршруты"

**Файлы:**
- `components/MapPage/SaveRouteModal.tsx` (новый)
- `api/routes.ts` (backend endpoint)
- `app/(tabs)/profile.tsx` (добавить раздел)

---

### 4.5. Heatmap mode (P3)

**Проблема:** На карте много мест — сложно увидеть "горячие" зоны.

**Решение:**
- Добавить переключатель view: **Markers** / **Heatmap**
- Heatmap показывает плотность мест (используя `Leaflet.heat`)
- Полезно для обзора больших территорий

**Файлы:**
- `components/MapPage/Map/MapHeatmapLayer.tsx` (новый)
- `components/MapPage/MapPanel.tsx` (добавить prop `viewMode`)

---

### 4.6. Street View integration (P3)

**Проблема:** Пользователь хочет увидеть место "изнутри" перед посещением.

**Решение:**
- При клике на маркер — показать кнопку **"Street View"**
- Открывает Google Street View или Yandex Panorama в модальном окне
- Fallback: если панорамы нет — скрыть кнопку

**Файлы:**
- `components/MapPage/StreetViewModal.tsx` (новый)
- `components/MapPage/Map/MapPopup.tsx` (добавить кнопку)

---

### 4.7. Offline mode (P3)

**Проблема:** При потере сети карта перестаёт работать.

**Решение:**
- Кешировать тайлы карты (Service Worker + IndexedDB)
- Показать **offline banner** при потере сети
- В offline: доступны только закешированные области
- Использовать `workbox` для SW

**Файлы:**
- `public/sw.js` (service worker)
- `components/MapPage/OfflineBanner.tsx` (новый)

---

### 4.8. Dark mode для карты (P2)

**Проблема:** Карта Leaflet всегда светлая, даже в тёмной теме приложения.

**Решение:**
- Добавить тёмные тайлы для Leaflet: `CartoDB.DarkMatter` или `Thunderforest.Transport-Dark`
- Переключать tile layer в зависимости от `useTheme().isDark`
- Обновить цвета маркеров и popup для тёмной темы

**Файлы:**
- `components/MapPage/Map/MapLayers.tsx` (добавить тёмный слой)
- `components/MapPage/Map/MapMarkers.tsx` (адаптивные цвета)

---

### 4.9. Геокодер (поиск по адресу) (P2)

**Проблема:** Пользователь хочет найти место по названию, но нет поиска на карте.

**Решение:**
- Добавить **search bar** в шапку карты (desktop) или в Bottom Sheet (mobile)
- Использовать Nominatim API или Mapbox Geocoding
- Результаты: dropdown с саджестами, при клике — центрирование на месте

**Файлы:**
- `components/MapPage/MapGeocoder.tsx` (новый)
- `components/MapPage/MapMobileLayout.tsx` (добавить search bar)

---

### 4.10. Legend (легенда карты) (P2)

**Проблема:** На карте используются разные цвета маркеров, но нет легенды.

**Решение:**
- Добавить **компактную легенду** в правый нижний угол карты
- Цвета: "Музеи" (синий), "Парки" (зелёный), "Рестораны" (оранжевый), etc.
- Клик по цвету — фильтр по категории
- Compactible: можно свернуть (только иконка)

**Файлы:**
- `components/MapPage/MapLegend.tsx` (уже существует, но не используется!)
- `components/MapPage/Map.web.tsx` (добавить)

---

## 5. Что изменить

### 5.1. Bottom Sheet — состояния и анимация (P1)

**Текущее:** Bottom Sheet имеет 3 состояния (`collapsed`, `half`, `full`), но анимация резкая на iOS.

**Изменения:**
- Использовать `react-native-reanimated` вместо `Animated` для более плавных анимаций
- Добавить **spring animation** при переходах между состояниями
- Collapsed snap point: 15% высоты экрана (сейчас hardcoded)
- Half: 50%, Full: 90% (оставить запас для статус-бара)

**Файлы:**
- `components/MapPage/MapBottomSheet.tsx`
- `components/MapPage/MapMobileLayout.tsx`

---

### 5.2. Tabs — визуальное улучшение (P1)

**Текущее:** Переключатель `[Список] [Фильтры]` в панели — простые кнопки с иконками. На desktop есть подписи "12 мест", но на mobile нет.

**Изменения:**
- На mobile: добавить **badge с количеством** рядом с иконкой "Список"
- Active state: подчёркивание снизу (не fill background)
- Анимация перехода: slide indicator
- Использовать `SegmentedControl` (уже есть!) вместо кастомных кнопок

**Файлы:**
- `screens/tabs/MapScreen.tsx` (панель tabs)
- `components/MapPage/SegmentedControl.tsx` (расширить)

---

### 5.3. Карточки мест в списке — компактность (P2)

**Текущее:** `AddressListItem` — 856 строк, карточка высотой ~120px с большим изображением, названием, адресом, кнопками действий, статусом точки.

**Проблемы:**
- Слишком высокие карточки — в списке помещается 3-4 места
- Дублирование информации: адрес и категория часто совпадают
- Кнопки действий (Google Maps, Apple Maps, Yandex, OSM, копировать) — слишком много

**Изменения:**
- Сделать **2 варианта карточки**: `compact` (70px) и `detailed` (120px)
- `compact`: изображение 48x48px (thumbnail), название, расстояние, 1 кнопка "Маршрут"
- `detailed`: текущий вид, но с collapsible секцией для доп. кнопок
- По умолчанию в списке — `compact`, при клике — expand до `detailed`

**Файлы:**
- `components/MapPage/AddressListItem.tsx` (рефакторинг)
- `components/MapPage/TravelListPanel.tsx` (добавить prop `cardVariant`)

---

### 5.4. Фильтры — progressive disclosure (P1)

**Текущее:** Все фильтры показываются сразу: радиус, категории, теги, сложность, автор, даты. На мобильном это 70% экрана.

**Изменения:**
- **Primary filters** (всегда видны): Радиус, Категория, Транспорт
- **Secondary filters** (collapsed): Теги, Автор, Даты, Сложность
- Кнопка "Больше фильтров" (с badge количества активных вторичных)
- При открытии вторичных — smooth scroll

**Файлы:**
- `components/MapPage/FiltersPanel.tsx`
- `components/MapPage/FiltersPanelBody.tsx`
- `components/MapPage/CollapsibleSection.tsx` (уже есть!)

---

### 5.5. Route mode — UI улучшения (P2)

**Текущее:** При переключении в route mode появляются поля "Старт" и "Финиш" для ввода адреса. Нет визуализации точек на карте до построения маршрута.

**Изменения:**
- При добавлении точки через клик на карте — сразу показать **temporary marker** с номером (1, 2, 3...)
- Линия между точками — **dashed** до построения, **solid** после
- Кнопка "Отменить последнюю точку" (undo)
- При построении — показать **route stats** в панели: расстояние, время, перепад высот

**Файлы:**
- `components/MapPage/RouteBuilder.tsx` (уже есть, доработать)
- `components/MapPage/RouteStats.tsx` (уже есть, интегрировать)
- `components/MapPage/Map/RouteMarkersLayer.tsx` (уже есть, доработать)

---

### 5.6. MapPageSkeleton — реалистичность (P2)

**Текущее:** Skeleton показывает серый прямоугольник с текстом "Загружаем карту…". Выглядит как заглушка.

**Изменения:**
- Показать **скелет интерфейса карты**:
  - Skeleton панели слева (desktop) или снизу (mobile)
  - Skeleton контролов zoom/layers
  - Skeleton 3-5 маркеров на "карте"
- Pulse animation для скелетов
- Убрать текст "Загружаем карту" — визуал говорит сам за себя

**Файлы:**
- `components/MapPage/MapPageSkeleton.tsx`

---

### 5.7. Map controls — position и стиль (P2)

**Текущее:** Контролы (zoom, layers, center) находятся в правом верхнем углу карты. На мобильном частично перекрываются Bottom Sheet.

**Изменения:**
- **Desktop:** оставить справа, но добавить отступ от панели
- **Mobile:** переместить в **левый верхний угол** (как Google Maps)
- Стиль: круглые кнопки с shadow, белый фон (светлая тема) / тёмный (тёмная тема)
- Группировать: zoom +/- в одну группу, остальные отдельно

**Файлы:**
- `components/MapPage/Map/MapControls.tsx`
- `screens/tabs/map.styles.ts`

---

### 5.8. Clustering — визуальное улучшение (P2)

**Текущее:** Кластеры показываются как круги с числом. Цвет не зависит от количества мест.

**Изменения:**
- **Gradient color**: 2-10 мест (зелёный), 11-50 (оранжевый), 50+ (красный)
- **Animated expansion**: при клике на кластер — анимация "разлёта" маркеров
- **Spiderfied layout**: если в кластере 2-8 мест — показать их веером

**Файлы:**
- `components/MapPage/Map/ClusterLayer.tsx`
- `utils/mapClustering.ts`

---

### 5.9. Error states — дружелюбность (P1)

**Текущее:** При ошибке загрузки карты показывается `ErrorDisplay` с техническим сообщением.

**Изменения:**
- Дружелюбные сообщения:
  - "Не удалось загрузить карту. Проверьте соединение"
  - "Карта временно недоступна. Попробуйте позже"
- Иллюстрация (не просто текст)
- Кнопка "Обновить" крупная, primary стиль

**Файлы:**
- `screens/tabs/MapScreen.tsx`
- `components/ui/ErrorDisplay.tsx` (расширить)

---

### 5.10. Performance — lazy loading (P2)

**Текущее:** Все компоненты карты загружаются сразу, даже если пользователь на вкладке "Список".

**Изменения:**
- Lazy load `LazyMapPanel` только при активной вкладке "Карта"
- `TravelListPanel` — eager load
- Prefetch map tiles при hover над вкладкой "Карта"
- Use `React.memo` для всех карточек в списке

**Файлы:**
- `screens/tabs/MapScreen.tsx`
- `components/MapPage/TravelListPanel.tsx`

---

## 6. Что удалить

### 6.1. Дублирующий функционал (P2)

**Удалить:**
- ❌ `MapFAB.tsx` — Floating Action Button для открытия панели на мобильном. Заменён на Bottom Sheet.
- ❌ `diagnose-route-line.js` — debug-скрипт, не нужен в prod

**Результат:** -200 строк кода

---

### 6.2. Неиспользуемые компоненты (P3)

**Проверить и удалить, если не используются:**
- `QuickRecommendations.tsx` — быстрые рекомендации (не найдено импортов)
- `RouteDebugPanel.tsx` — debug-панель для маршрутов (только для dev?)
- `MapOptimizations.tsx` — непонятное назначение

**Действие:** Поиск импортов → если 0 → удалить

---

### 6.3. Избыточные props (P2)

**Проблема:** `AddressListItem` принимает 7+ props, многие опциональные и не используются.

**Изменения:**
- Убрать `onHidePress` — функционал "скрыть место" не реализован
- Убрать дублирование `isMobile` — брать из контекста `useResponsive()`

**Файлы:**
- `components/MapPage/AddressListItem.tsx`
- `components/MapPage/TravelListPanel.tsx`

---

### 6.4. Legacy стили (P3)

**Проблема:** В `map.styles.ts` есть закомментированные стили и дублирование.

**Удалить:**
- Закомментированные блоки
- `effectiveHeaderOffset` — больше не используется (в коде есть комментарий)
- Дублирующие transition values

**Файлы:**
- `screens/tabs/map.styles.ts`

---

## 7. Приоритизация

### P1 — Критично (блокирует UX)

| # | Задача | Сложность | Влияние | Оценка |
|---|--------|-----------|---------|--------|
| 3.1 | Когнитивная нагрузка — progressive disclosure | Средняя | Высокое | 3d |
| 3.2 | Bottom Sheet — collision с контролами | Низкая | Высокое | 1d |
| 3.5 | Обратная связь — toast-уведомления | Низкая | Высокое | 1d |
| 4.1 | Onboarding для карты | Средняя | Высокое | 2d |
| 5.1 | Bottom Sheet — плавная анимация | Средняя | Среднее | 2d |
| 5.2 | Tabs — визуальное улучшение | Низкая | Среднее | 0.5d |
| 5.4 | Фильтры — progressive disclosure | Средняя | Высокое | 2d |
| 5.9 | Error states — дружелюбность | Низкая | Среднее | 0.5d |

**Итого P1:** ~12 дней

---

### P2 — Важно (улучшает UX)

| # | Задача | Сложность | Влияние | Оценка |
|---|--------|-----------|---------|--------|
| 3.3 | Peek Preview — информативность | Средняя | Среднее | 2d |
| 3.4 | Фильтры — мобильная оптимизация | Низкая | Среднее | 1d |
| 3.6 | Список — группировка по расстоянию | Средняя | Среднее | 2d |
| 3.7 | Route mode — инструкции | Низкая | Среднее | 1d |
| 3.8 | Loading states — унификация | Низкая | Низкое | 1d |
| 4.2 | Quick Actions — избранные места | Низкая | Среднее | 1d |
| 4.3 | Share маршрута | Средняя | Среднее | 2d |
| 4.8 | Dark mode для карты | Низкая | Среднее | 1d |
| 4.9 | Геокодер (поиск по адресу) | Средняя | Высокое | 3d |
| 4.10 | Legend (легенда) | Низкая | Низкое | 0.5d |
| 5.3 | Карточки — компактность | Высокая | Среднее | 4d |
| 5.5 | Route mode — UI улучшения | Средняя | Среднее | 2d |
| 5.6 | MapPageSkeleton — реалистичность | Низкая | Низкое | 0.5d |
| 5.7 | Map controls — position | Низкая | Среднее | 1d |
| 5.8 | Clustering — визуализация | Средняя | Низкое | 2d |
| 5.10 | Performance — lazy loading | Средняя | Среднее | 2d |

**Итого P2:** ~26 дней

---

### P3 — Желательно (полировка)

| # | Задача | Сложность | Влияние | Оценка |
|---|--------|-----------|---------|--------|
| 3.9 | Desktop — адаптивная ширина панели | Средняя | Низкое | 2d |
| 3.10 | Accessibility — клавиатурная навигация | Высокая | Низкое | 4d |
| 4.4 | Save маршрута | Высокая | Среднее | 5d |
| 4.5 | Heatmap mode | Средняя | Низкое | 3d |
| 4.6 | Street View integration | Высокая | Низкое | 5d |
| 4.7 | Offline mode | Очень высокая | Низкое | 10d |
| 6.1-6.4 | Удаление legacy кода | Низкая | Низкое | 1d |

**Итого P3:** ~30 дней

---

## 8. Технические требования

### 8.1. Design System

**Использовать:**
- `DESIGN_TOKENS` для всех цветов, spacing, typography
- `useThemedColors()` для адаптации к светлой/тёмной теме
- `METRICS` для breakpoints, размеров

**Не использовать:**
- Hardcoded цвета (`#3498db`, `rgba(0,0,0,0.5)`)
- Inline стили для повторяющихся элементов
- Magic numbers для spacing/sizes

---

### 8.2. Performance

**Требования:**
- Initial load карты: < 2s (web, 3G)
- Time to interactive: < 3s
- Smooth 60fps анимации
- Lazy load компонентов >100KB

**Инструменты:**
- `React.memo` для карточек списка
- `useMemo`/`useCallback` для дорогих вычислений
- `FlashList` вместо `FlatList`
- `requestIdleCallback` для неприоритетных задач

---

### 8.3. Accessibility

**Требования:**
- WCAG 2.1 Level AA
- Keyboard navigation для всех интерактивных элементов
- Screen reader support (ARIA labels)
- Минимальный размер touch target: 44x44px
- Контрастность текста: 4.5:1 (обычный), 3:1 (крупный)

---

### 8.4. Cross-platform

**Поддержка:**
- ✅ Web (desktop + mobile)
- ✅ iOS (native)
- ✅ Android (native)

**Особенности:**
- Карта работает только на web (Leaflet)
- На native: заглушка "Карта доступна в браузере" + ссылка на web-версию
- Альтернатива (будущее): `react-native-maps` для native

---

### 8.5. Browser support

**Минимальные версии:**
- Chrome/Edge: 90+
- Safari: 14+
- Firefox: 88+
- Mobile Safari: 14+
- Chrome Android: 90+

---

## 9. Метрики успеха

### 9.1. Количественные метрики

| Метрика | Текущее | Цель |
|---------|---------|------|
| Time to first interaction (web) | ~3.5s | <2s |
| Bounce rate на `/map` | 45% | <30% |
| Avg. session duration | 2:15 | >4:00 |
| Route builds per session | 0.3 | >1.0 |
| Фильтры используют | 18% | >40% |
| Mobile users | 35% | >50% |

---

### 9.2. Качественные метрики

**До рефакторинга:**
- ❌ Пользователи не понимают, как построить маршрут
- ❌ На мобильном неудобно работать с фильтрами
- ❌ Нет обратной связи при действиях

**После рефакторинга:**
- ✅ Onboarding объясняет функционал
- ✅ Progressive disclosure снижает когнитивную нагрузку
- ✅ Toast-уведомления подтверждают действия
- ✅ Мобильный UX на уровне Google Maps

---

### 9.3. A/B тесты

**Эксперименты:**
1. **Peek Preview** — с изображениями vs без
2. **Фильтры** — все открыты vs progressive disclosure
3. **Onboarding** — 3 шага vs 5 шагов
4. **Карточки** — compact vs detailed по умолчанию

**Метрика успеха:** Конверсия в построение маршрута

---

## 10. Roadmap

### Phase 1: Foundation (P1) — 2 недели

**Week 1:**
- ✅ Bottom Sheet collision fix
- ✅ Toast notifications
- ✅ Error states улучшение
- ✅ Tabs визуальное улучшение

**Week 2:**
- ✅ Progressive disclosure фильтров
- ✅ Bottom Sheet анимация
- ✅ Onboarding для карты
- ✅ Когнитивная нагрузка анализ + fixes

---

### Phase 2: Enhancement (P2) — 4 недели

**Week 3-4:**
- ✅ Peek Preview с изображениями
- ✅ Список — группировка
- ✅ Route mode инструкции
- ✅ Loading states унификация
- ✅ Quick Actions избранное

**Week 5-6:**
- ✅ Share маршрута
- ✅ Dark mode для карты
- ✅ Геокодер
- ✅ Legend
- ✅ Карточки компактность (начало)

**Week 7:**
- ✅ Карточки компактность (завершение)
- ✅ Route mode UI
- ✅ MapPageSkeleton
- ✅ Map controls position

**Week 8:**
- ✅ Clustering визуализация
- ✅ Performance lazy loading
- ✅ Testing + bug fixes

---

### Phase 3: Polish (P3) — опционально

**Future sprints:**
- Desktop адаптивная панель
- Accessibility клавиатура
- Save маршрута
- Heatmap mode
- Street View
- Offline mode
- Legacy cleanup

---

## 11. Зависимости

### 11.1. Текущие библиотеки

```json
{
  "react-leaflet": "^4.x",
  "leaflet": "^1.9.x",
  "@shopify/flash-list": "^1.x",
  "react-native-gesture-handler": "^2.x",
  "react-native-reanimated": "^3.x",
  "@tanstack/react-query": "^5.x"
}
```

---

### 11.2. Новые библиотеки (предложения)

```json
{
  "react-joyride": "^2.x",        // Onboarding tours
  "leaflet.heat": "^0.2.x",        // Heatmap layer
  "leaflet.markercluster": "^1.5.x" // Better clustering (опция)
}
```

---

## 12. Файлы для изменения

### Высокий приоритет (P1)

```
screens/tabs/MapScreen.tsx                   (контроллер)
components/MapPage/MapMobileLayout.tsx       (mobile UI)
components/MapPage/FiltersPanel.tsx          (фильтры)
components/MapPage/FiltersPanelBody.tsx      (фильтры body)
components/MapPage/MapBottomSheet.tsx        (bottom sheet)
components/MapPage/SegmentedControl.tsx      (tabs)
screens/tabs/map.styles.ts                   (стили)
components/ui/ErrorDisplay.tsx               (ошибки)
utils/toast.ts                               (toast notifications)
```

---

### Средний приоритет (P2)

```
components/MapPage/MapPeekPreview.tsx        (peek preview)
components/MapPage/TravelListPanel.tsx       (список)
components/MapPage/AddressListItem.tsx       (карточка)
components/MapPage/RouteBuilder.tsx          (route mode)
components/MapPage/RouteStats.tsx            (route stats)
components/MapPage/MapPageSkeleton.tsx       (skeleton)
components/MapPage/Map/MapControls.tsx       (контролы)
components/MapPage/Map/ClusterLayer.tsx      (кластеры)
components/MapPage/Map/MapLayers.tsx         (слои/тёмная тема)
components/MapPage/QuickActions.tsx          (quick actions)
```

---

### Новые файлы

```
components/MapPage/MapOnboarding.tsx         (onboarding)
components/MapPage/RouteShareButton.tsx      (share)
components/MapPage/MapGeocoder.tsx           (геокодер)
components/MapPage/SaveRouteModal.tsx        (save route)
components/MapPage/Map/MapHeatmapLayer.tsx   (heatmap)
components/MapPage/StreetViewModal.tsx       (street view)
components/MapPage/OfflineBanner.tsx         (offline)
```

---

## 13. Визуальные референсы

### 13.1. Вдохновение

**Map interfaces:**
- **Google Maps** — референс для мобильного UX
- **Apple Maps** — референс для минимализма
- **Mapbox** — референс для кастомизации
- **Komoot** — референс для route planning

**Bottom Sheet:**
- **Google Maps** — peek preview + snap points
- **Apple Music** — плавная анимация
- **Uber** — route UI

---

### 13.2. Цветовая палитра (карта)

**Светлая тема:**
- Primary: `#2D5BFF` (синий — активные элементы)
- Success: `#00C48C` (зелёный — построенный маршрут)
- Warning: `#FFA94D` (оранжевый — кластеры)
- Surface: `#FFFFFF` (белый — панели)
- Border: `#E5E9F0` (светло-серый)

**Тёмная тема:**
- Primary: `#5B8DFF` (светло-синий)
- Success: `#00E0A0` (яркий зелёный)
- Warning: `#FFB870` (яркий оранжевый)
- Surface: `#1E2530` (тёмно-серый)
- Border: `#2E3744` (серый)

---

## 14. Acceptance Criteria

### ✅ P1 Done When:

- [ ] Bottom Sheet не перекрывает контролы карты
- [ ] При построении маршрута показывается toast
- [ ] При ошибке — дружелюбное сообщение + иллюстрация
- [ ] Первый визит — onboarding (3 шага)
- [ ] Фильтры — primary/secondary группировка
- [ ] Tabs — badge с количеством мест
- [ ] Анимации smooth (60fps)

### ✅ P2 Done When:

- [ ] Peek Preview — показывает thumbnail изображений
- [ ] Список — группировка по расстоянию
- [ ] Route mode — есть инструкции
- [ ] Скелеты везде единообразные
- [ ] Кнопка "Мои места" фильтрует избранное
- [ ] Кнопка "Поделиться" копирует URL маршрута
- [ ] Тёмная тема — тёмные тайлы карты
- [ ] Геокодер — поиск по адресу работает
- [ ] Legend — показывает категории мест
- [ ] Карточки — 2 варианта (compact/detailed)
- [ ] Кластеры — цветовой gradient

---

## 15. Заключение

Рефакторинг страницы карты — критически важен для улучшения UX приложения MeTravel. Текущая реализация работает, но имеет проблемы с usability, особенно на мобильных устройствах.

**Ключевые выводы:**
1. **Progressive disclosure** — не показывать всё сразу
2. **Обратная связь** — подтверждать действия пользователя
3. **Мобильный UX** — Bottom Sheet не должен мешать
4. **Onboarding** — объяснять функционал новым пользователям
5. **Performance** — lazy loading, мемоизация, оптимизация

**Приоритет:** Начать с P1 (2 недели), затем P2 (4 недели). P3 — опционально.

**Ожидаемый результат:** Интуитивная, быстрая и приятная карта, которая конвертирует пользователей в активных путешественников.

---

**Документ подготовлен:** 6 февраля 2026  
**Версия:** 1.0  
**Автор:** AI UI/UX Дизайнер  
**Статус:** Готово к review

