# ТЗ: переработка хлебных крошек (Breadcrumbs) и стабилизация layout без «пустых зон»

## 1) Контекст и проблема
Сейчас хлебные крошки рендерятся в `CustomHeader` и скрываются на главной (`/`, `/index`). Из‑за того, что блок крошек то есть, то нет, меняется высота верхней области экрана, что визуально выглядит как «дергание» (layout shift / CLS). Быстрая фиксация через постоянный резерв высоты решает дергание, но создаёт нежелательную «пустую полосу» на страницах, где крошек нет.

Дополнительно:
- `Breadcrumbs.tsx` для страниц путешествия может подгружать название через React Query. Поздняя подстановка текста может менять ширину/переносы и давать микросдвиги внутри строки.
- Хлебные крошки сейчас стилистически выглядят как отдельная полоса (фон, нижняя граница) и при отсутствии контента воспринимаются как пустая зона.

## 2) Цели
- Устранить **визуальные дергания** при навигации между страницами.
- Избавиться от **пустых зон**: если место под крошки зарезервировано — оно должно быть полезным.
- Не влиять на поведение футера: футер не должен «растягиваться»/перепрыгивать из‑за изменения высоты верхней части.
- Сделать breadcrumbs **максимально user‑friendly**:
  - понятный контекст “где я нахожусь”
  - быстрый возврат на уровень выше
  - адекватное поведение на мобайле и при длинных названиях
  - доступность (клавиатура/скринридер)

## 3) Нецели (в рамках этого ТЗ)
- Полная переработка глобального Header/Nav.
- Изменение маршрутизации, структуры URL и названий страниц.
- Полная замена дизайн‑системы.

## 4) Предлагаемое UX‑решение (ключевая идея)
Вместо «Breadcrumbs как иногда появляющейся полосы» вводим единый **контекстный бар** фиксированной высоты под основным хедером.

### Компонент: `HeaderContextBar`
- Всегда занимает одинаковую высоту (например `32px` desktop/tablet, `36px` mobile).
- Всегда содержит контент (нет пустой полосы):
  - **Если глубина навигации > 1**: отображаем breadcrumbs.
  - **Если главная/корневой раздел**: отображаем *Page Context* вместо крошек:
    - заголовок текущего раздела (например: «Путешествия», «Квесты», «Карта»)
    - опционально: компактный summary (например страна/фильтры/кол-во найденных) — только если это уже есть в дизайне и не перегружает.

Таким образом:
- высота верха всегда стабильна (нет CLS)
- нет пустой зоны (бар всегда “что‑то говорит”)

## 5) Правила отображения и сценарии
### 5.1 Desktop/Tablet
- **Показываем breadcrumbs**, если:
  - пользователь не на главной и не на корневом уровне раздела (глубина > 1)
- **Показываем Page Context**, если:
  - главная
  - корневой экран раздела (например “Квесты” на `/quests`)

### 5.2 Mobile
Цель мобайла — максимально читабельная и полезная строка без “лапши”:
- Слева: **Back‑кнопка** (стрелка назад) → ведёт на уровень выше (или `router.back()` если выше неизвестно/нет)
- Справа/в центре: **текущий заголовок страницы** (1 строка, ellipsis)
- Если breadcrumbs доступны и короткие — можно показывать “Главная / Раздел” в 1 строку, но приоритет за back + title.

## 6) Обработка длинных цепочек и длинных названий
- Всегда 1 строка по высоте.
- Обрезание:
  - последний элемент (текущая страница) — ellipsis
  - элементы слева могут скрываться по правилу “collapse middle”:
    - пример: `Главная / … / Польша / Варшавские Лазенки`
- Минимальная кликабельная зона для элемента: `>= 36px` по высоте.

## 7) Навигационные правила
- Все элементы, кроме последнего, кликабельны.
- Последний элемент (текущий) — не кликабельный, визуально выделен.
- На мобайле back‑кнопка имеет приоритет:
  - если breadcrumb chain доступен → back ведёт на предыдущий crumb
  - иначе → `router.back()`

## 8) Доступность (a11y)
- Контейнер: `accessibilityRole="navigation"` (web: `role="navigation"`, `aria-label="Breadcrumb"`).
- Каждый элемент:
  - ссылка/кнопка с понятным label
  - текущая страница: `aria-current="page"` (web)
- Поддержка клавиатуры:
  - tab‑навигация по элементам
  - фокус‑стили соответствуют `globalFocusStyles`

## 9) Дизайн‑правила (UI)
- Высота `HeaderContextBar` фиксированная.
- Не использовать отдельный “залитый фон + граница”, если бар пустой. Поскольку бар всегда с контентом, допускается лёгкий фон или разделитель, но без ощущения второй шапки.
- Текст:
  - размер 12–13px desktop, 13–14px mobile
  - контраст согласно палитре `DESIGN_TOKENS`

## 10) Техническая реализация (предложение)
### 10.1 Новый слой абстракции
Вынести логику определения цепочки в хук:
- `useBreadcrumbModel()` → возвращает:
  - `items: Array<{ label, path, isCurrent }>`
  - `depth`
  - `parent?: { label, path }`
  - `pageContextTitle` (для корня)

### 10.2 Рендер
- `CustomHeader` рендерит:
  - основной header row
  - `HeaderContextBar` (всегда)

### 10.3 Устранение микросдвигов текста
- Для travel‑страницы:
  - по возможности передавать `travelName` из экрана деталей (чтобы исключить late label swap)
  - если name всё же грузится, то резервировать ширину/делать placeholder текста в 1 строку (не меняя высоту)

## 11) Критерии приемки
- При навигации между главной и любым вложенным экраном **нет заметного дергания** (визуально) и нет изменения высоты верхнего блока.
- На главной нет “пустой полосы”: контекстный бар показывает полезный контент.
- На мобильных:
  - есть back‑кнопка
  - заголовок страницы читаемый, 1 строка, без переноса
- Breadcrumbs корректно локализованы и не содержат технических сегментов (`travels` уже исключён).
- Доступность: работает tab‑фокус и корректные accessibility роли.

## 12) Метрики/проверки
- Web: прогнать e2e (если есть) на отсутствие layout shift в верхней области при переходах.
- Ручная проверка:
  - / (главная)
  - /quests
  - /quests/[id]
  - /travels/[slug]
  - /map

## 13) План внедрения (миграция)
1) Добавить `HeaderContextBar` (параллельно текущим breadcrumbs), спрятать за флагом.
2) Перенести логику вычисления crumbs в `useBreadcrumbModel()`.
3) Включить новый бар по умолчанию.
4) Удалить устаревшие стили/условия, приводящие к CLS.
