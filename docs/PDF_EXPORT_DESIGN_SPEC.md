# ТЗ: Улучшение дизайна PDF-экспорта (книга путешествий)

> Дата: 6 февраля 2026
> Область: дизайн и вёрстка генерируемого PDF, без изменений бэкенда
> Основа: анализ V1 генератора (`EnhancedPdfGenerator`), 12 тем, 6 типов страниц, парсера контента, рендерера блоков и UI настроек

---

## Содержание

1. [Текущее состояние](#1-текущее-состояние)
2. [Выявленные проблемы](#2-выявленные-проблемы)
3. [Что улучшить](#3-что-улучшить)
4. [Что добавить](#4-что-добавить)
5. [Что убрать / исправить](#5-что-убрать--исправить)
6. [Приоритизация](#6-приоритизация)

---

## 1. Текущее состояние

### Архитектура генерации

- **V1 генератор** (`services/pdf-export/generators/EnhancedPdfGenerator.ts`, ~2280 строк) — единственный активный генератор. V2 делегирует к V1.
- **Страницы**: Обложка → Оглавление → [Фото-страница + Контент-страница + Галерея? + Карта?] × N → Чек-листы? → Финальная страница.
- **Темы**: 12 тем (`PdfThemeConfig.ts`, ~1230 строк): minimal, light, dark, travel-magazine, classic, modern, romantic, adventure, illustrated, black-white, sepia, newspaper.
- **Галереи**: 5 layout'ов (grid, masonry, collage, polaroid, slideshow).
- **Парсер контента**: HTML → структурированные блоки (заголовки, параграфы, списки, цитаты, изображения, таблицы, info/warning/tip/danger блоки).
- **Изображения**: проксируются через `images.weserv.nl` с разрешением до 2400px (для печати 300 DPI).

### Типы страниц в PDF

| Страница | Генератор | Описание |
|---|---|---|
| Обложка | `CoverPageGenerator` + inline в V1 | Фоновое изображение, заголовок, автор, цитата, декоративные элементы |
| Оглавление | `renderTocPage` | Список путешествий с номерами страниц |
| Фото путешествия | `renderTravelPhotoPage` | Полноразмерное фото с заголовком поверх |
| Контент | `renderTravelContentPage` | Описание, рекомендации, плюсы/минусы, inline-галерея, QR-код |
| Галерея | `renderGalleryPages` | Отдельная страница(ы) с фотографиями |
| Карта | `renderMapPage` | Leaflet-скриншот или SVG, список локаций с QR-кодами |
| Чек-листы | `renderChecklistPage` | Сетка 3×N с категориями (одежда, еда, электроника и т.д.) |
| Финальная | `renderFinalPage` | «Спасибо», цитата, брендинг |

---

## 2. Выявленные проблемы

### 2.1. Типографика и читаемость

- **Проблема**: `object-fit: contain` на всех изображениях (обложка, фото-страница, галерея) — фото не заполняют отведённую область, появляются большие пустые поля по бокам.
  - **Файлы**: `EnhancedPdfGenerator.ts` (строки 296, 310, 529, 572, 611, 777), `TravelPageGenerator.ts` (строки 104, 161, 250), `GalleryPageGenerator.ts` (все layout'ы)
  - **Ожидание**: `object-fit: cover` для обложки и фото-страниц; `contain` допустим только для inline-галерей с мелкими превью.

- **Проблема**: Заголовки на обложке и фото-страницах используют `overflow-wrap: normal; word-break: normal; hyphens: none` — длинные названия путешествий (кириллица!) могут выходить за пределы блока.
  - **Файл**: `EnhancedPdfGenerator.ts` (строки 356-358, 811-813)

- **Проблема**: `text-align: justify` для абзацев в контент-странице (`BlockRenderer.ts:100`) создаёт «рваные» межсловные интервалы на узких колонках, особенно в кириллице.

### 2.2. Обложка

- **Проблема**: Два генератора обложки (`CoverPageGenerator.ts` и inline `renderCoverPage` в V1) — фактически используется `CoverPageGenerator`, но inline-код дублирует логику (~200 строк мёртвого кода).

- **Проблема**: Декоративные круги (`renderDecorativeElements`) выглядят как артефакты на фоне реального фото — `rgba(255,255,255,0.1)` круги бессмысленны при наличии фотографии.

- **Проблема**: Рамка `border: 2px solid rgba(255,255,255,0.25)` на обложке с `inset: 15mm` — на белых/светлых фото практически не видна, на тёмных — выглядит как дефект.

- **Проблема**: Заголовок обёрнут в полупрозрачный box (`background: rgba(0,0,0,0.28)`), но при этом есть отдельный overlay — двойное затемнение приводит к грязному виду.

### 2.3. Фото-страница путешествия

- **Проблема**: Фото занимает `min-height: 235mm` при `object-fit: contain` — при вертикальных фото огромные пустые области слева/справа; при горизонтальных — сверху/снизу.

- **Проблема**: Градиент поверх фото (`linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.55) 55%, rgba(0,0,0,0.78) 100%)`) начинается слишком рано (55%) — затемняет больше половины изображения.

- **Проблема**: Заголовок в полупрозрачном box'е поверх gradient-overlay — тройной слой затемнения (фон блока + gradient + text-shadow), что снижает контраст вместо того чтобы его повышать.

### 2.4. Контент-страница

- **Проблема**: Секция «Описание» всегда показывается, даже если описание пустое — рендерится заголовок + текст «Описание путешествия отсутствует». Это занимает место и выглядит непрофессионально.

- **Проблема**: Секции «Описание», «Рекомендации», «Плюсы/Минусы» используют одинаковый визуальный стиль (иконка + цветной заголовок + разделительная линия), но при этом плюсы/минусы в цветных карточках — визуальная иерархия нарушена.

- **Проблема**: QR-код внизу контент-страницы — `width: 50mm; height: 50mm` (~5×5 см) — занимает слишком много места. Для телефонного сканирования достаточно 25×25 мм.

- **Проблема**: Inline-галерея на контент-странице (превью 4 фото + «+N») дублирует полноценную галерею, если она включена в настройках. Пользователь видит одни и те же фото дважды.

### 2.5. Галерея

- **Проблема**: Подпись к фото — «Фото 1», «Фото 2» — бесполезная информация. Нет интеграции с метаданными фото (название, описание, дата).

- **Проблема**: Цитата на первой странице галереи (`getGalleryQuote`) — случайная мотивационная цитата не связана с конкретным путешествием и выглядит как заполнение пространства.

- **Проблема**: Галерея не использует реальные подписи из галереи путешествия (поле `caption` в `GalleryPhoto`), хотя тип `GalleryPhoto` их поддерживает.

### 2.6. Карта

- **Проблема**: SVG-fallback карты (`buildRouteSvg`) — только точки без соединительных линий маршрута. Визуально не читается как маршрут.

- **Проблема**: Leaflet-скриншот карты (`generateLeafletRouteSnapshot`) использует `object-fit: contain` — при широком маршруте карта мелкая с большими пустыми зонами.

- **Проблема**: QR-коды для каждой локации (`24mm × 24mm` каждый) — при 5+ локациях они занимают больше места, чем сама информация о локации. На странице A4 список из 8 локаций с QR-кодами не помещается.

### 2.7. Чек-листы

- **Проблема**: Чек-лист использует `<ul>` с обычными маркерами — нет чекбоксов. Заявлено «Подходит для печати и отметок», но нет визуальных чекбоксов.

- **Проблема**: Сетка `grid-template-columns: repeat(3, minmax(0, 1fr))` — при 5 секциях чек-листа третья строка имеет 2 карточки из 3, что выглядит несимметрично.

### 2.8. Финальная страница

- **Проблема**: V1 `renderFinalPage` использует `background: #ffffff` — жёстко, не адаптируется к темам. Тёмные темы (dark, sepia) получают белую финальную страницу.

- **Проблема**: Нет итоговой статистики (количество стран, дней, километров) — хотя `FinalPageGenerator` (V2) это поддерживает, V1 не использует.

### 2.9. Общие проблемы вёрстки

- **Проблема**: Нет `@font-face` или `@import` для нестандартных шрифтов в темах. Google Fonts подключаются через `<link>`, но при генерации PDF в offline-режиме шрифты не загружаются — fallback на system-ui.

- **Проблема**: Все темы используют одинаковые `pagePadding: 25mm` — при этом содержимое (текст) получает очень узкую ширину ~160mm на A4. Для журнальных тем (travel-magazine, newspaper) это слишком щедрые отступы.

- **Проблема**: Нет running headers/footers — номер страницы отображается как `position: absolute; bottom: 15mm; right: 25mm`, но нет названия путешествия/секции вверху страницы. Теряется контекст при просмотре отдельных страниц.

- **Проблема**: Нет drop caps (буквиц) или других полиграфических приёмов — контент-страницы выглядят как простой HTML, а не как книга/журнал.

---

## 3. Что улучшить

### 3.1. Изображения: `object-fit: cover` вместо `contain` (P1)

**Текущее**: Все изображения используют `contain` — фото с letterbox/pillarbox.

**Решение**:
- **Обложка**: `object-fit: cover` (фото всегда заполняет всю область)
- **Фото-страница**: `object-fit: cover` (полностраничное фото)
- **Галерея** (grid/masonry/collage): `object-fit: cover` для ячеек
- **Галерея** (slideshow, 1 фото): `object-fit: contain` с `background` из размытой версии фото (blur backdrop)
- **Inline-превью**: оставить `contain`
- **Карта**: `object-fit: cover` для Leaflet-скриншота

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts`, `TravelPageGenerator.ts`, `GalleryPageGenerator.ts`, `MapPageGenerator.ts`, `BlockRenderer.ts`

---

### 3.2. Обложка: упрощение слоёв (P1)

**Текущее**: 3 слоя затемнения (blur-фон + gradient-overlay + полупрозрачный box заголовка).

**Решение**:
- Убрать полупрозрачный box вокруг заголовка — заголовок напрямую поверх overlay
- Overlay: один продуманный градиент вместо нескольких слоёв. Для тёмных фото — мягче (0.3-0.4), для светлых — сильнее (0.5-0.7). Уже есть `analyzeImageBrightness` — использовать его результат
- Убрать декоративные круги (`renderDecorativeElements`) — они не несут смысловой нагрузки
- Рамку (`inset: 15mm; border: 2px`) сделать **опциональной** — показывать только для тем classic, romantic, illustrated

**Затрагиваемые файлы**: `CoverPageGenerator.ts`, `EnhancedPdfGenerator.ts` (удалить дублирующий `renderCoverPage`)

---

### 3.3. Фото-страница: правильное затемнение (P1)

**Текущее**: Градиент начинается с 55%, тройное затемнение.

**Решение**:
- Градиент overlay: начинать с 70-75% высоты, максимальная непрозрачность 0.65 (сейчас 0.78)
- Убрать полупрозрачный box вокруг заголовка — `text-shadow` достаточно для читаемости
- Добавить компактную полоску с метаданными (страна • год • дни) в нижний левый угол вместо текущего layout

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`renderTravelPhotoPage`)

---

### 3.4. Контент-страница: информационная иерархия (P1)

**Текущее**: Все секции визуально одинаковы, пустое описание рендерится.

**Решение**:
- **Не рендерить** секцию «Описание» при пустом `description` — никаких заголовков и текста «отсутствует»
- **Визуальная иерархия**: Описание — обычный текст без декоративного заголовка. Рекомендации — в info-блоке. Плюсы/минусы — в цветных карточках (уже есть, оставить).
- **Уменьшить QR**: с 50mm до 28mm; убрать label «Онлайн-версия» — QR с подписью URL внизу достаточно
- **Inline-галерея**: не показывать, если есть отдельная страница галереи (`hasGallery === true`). Это исключит дублирование фото.

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`renderTravelContentPage`, `buildInlineGallerySection`)

---

### 3.5. Галерея: реальные подписи (P2)

**Текущее**: «Фото 1», «Фото 2» + случайная цитата.

**Решение**:
- Использовать `caption` из данных фото (если есть); fallback: не показывать подпись вместо «Фото N»
- Убрать случайную цитату из галереи — она отвлекает и не несёт информации
- Если у фото есть `description` или дата — показать

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`renderGalleryPages`, `buildGalleryCaption`)

---

### 3.6. Карта: маршрутная линия в SVG-fallback (P2)

**Текущее**: SVG показывает только точки без соединительных линий.

**Решение**:
- Добавить `<polyline>` или `<path>` соединяющую точки в порядке маршрута
- Стиль: пунктирная линия `stroke-dasharray: 4,3` цвета `accentStrong`, `stroke-width: 1.2`
- QR-коды локаций: уменьшить с 24mm до 16mm; при >5 локациях — показывать только 1 общий QR на Google Maps с маршрутом

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`buildRouteSvg`, `buildLocationList`)

---

### 3.7. Чек-листы: визуальные чекбоксы (P2)

**Текущее**: Обычные `<li>` без чекбоксов.

**Решение**:
- Заменить `<ul>` на кастомную разметку с пустыми квадратами (☐) перед каждым пунктом
- CSS: `border: 1.5px solid ${colors.border}; width: 12px; height: 12px; border-radius: 2px; display: inline-block;`
- При 4+ секциях: использовать `grid-template-columns: repeat(2, 1fr)` вместо 3 — карточки будут шире и читабельнее

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`renderChecklistPage`)

---

### 3.8. Финальная страница: тематизация и статистика (P2)

**Текущее**: Белый фон, без статистики.

**Решение**:
- Использовать `colors.cover.backgroundGradient` для фона (как в `FinalPageGenerator` V2), а не `#ffffff`
- Добавить итоговую статистику: количество путешествий, стран, общее число дней (данные уже есть в `TravelForBook`)
- Статистика в компактных карточках (3 числа в ряд)

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`renderFinalPage`)

---

### 3.9. Типографика: justify → left, буквицы (P2)

**Текущее**: `text-align: justify` с кириллицей.

**Решение**:
- Заменить `text-align: justify` на `left` для тем с bodyFont serif (classic, romantic, illustrated, sepia) — justify плохо работает с длинными кириллическими словами
- Оставить `justify` только для газетных тем (newspaper, black-white) где колоночная вёрстка подразумевает выравнивание
- Добавить буквицу (drop cap) для первого абзаца описания путешествия:
  ```css
  .travel-content-page p:first-of-type::first-letter {
    float: left;
    font-size: 3.2em;
    line-height: 0.85;
    padding-right: 4pt;
    font-weight: 700;
    color: ${colors.accent};
    font-family: ${typography.headingFont};
  }
  ```
- Только для тем: classic, romantic, illustrated, travel-magazine

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`buildHtmlDocument`, `renderTravelContentPage`), `BlockRenderer.ts`

---

### 3.10. Нумерация страниц: running header (P3)

**Текущее**: Только номер страницы в правом нижнем углу.

**Решение**:
- Добавить running header на контент-страницы: `название путешествия` (слева) — `номер страницы` (справа)
- Шрифт: `caption.size`, цвет `textMuted`, разделительная линия (`border-bottom: 0.5pt solid ${colors.borderLight}`)
- Не показывать на обложке, оглавлении и финальной странице

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (все `render*Page` методы)

---

## 4. Что добавить

### 4.1. Blur-backdrop для одиночных фото (P2)

**Описание**: Когда фото в режиме `contain` (slideshow, одиночное фото), пустые области заполняются размытой версией того же фото.

**Реализация**:
```html
<div style="position: relative; overflow: hidden;">
  <!-- Размытый фон -->
  <img src="photo.jpg" style="position: absolute; inset: -20px; width: calc(100% + 40px); height: calc(100% + 40px); object-fit: cover; filter: blur(20px); opacity: 0.4;" />
  <!-- Основное фото -->
  <img src="photo.jpg" style="position: relative; width: 100%; height: 100%; object-fit: contain;" />
</div>
```

**Применять**: slideshow-галерея, одиночные фото в inline-галерее

**Затрагиваемые файлы**: `EnhancedPdfGenerator.ts` (`renderGalleryPages`, `buildInlineGallerySection`)

---

### 4.2. Разделительная страница между путешествиями (P3)

**Описание**: При 3+ путешествиях в книге — добавить мини-разделитель (полу-страница) с номером путешествия, названием и страной перед каждым новым путешествием.

**Реализация**: Компактная секция (не отдельная страница) с:
- Номер путешествия крупно (акцентным цветом)
- Название
- Страна и год
- Разделительная линия или декоративный элемент

**Опция**: Добавить в `BookSettings` флаг `includeSeparatorPages: boolean` (default: true при >2 путешествий)

---

### 4.3. Статистическая мини-карточка путешествия (P3)

**Описание**: На контент-странице, перед описанием — компактная горизонтальная полоса с ключевыми цифрами.

**Данные** (из `TravelForBook`):
- Количество дней (`number_days`)
- Страна/город (`countryName`)
- Год (`year`)
- Количество фото (`gallery.length`)
- Количество локаций (`travelAddress.length`)

**Визуал**: Иконка + число + label в горизонтальном ряду, фон `surfaceAlt`, `border-radius`.

---

### 4.4. Альтернативные layout'ы фото-страницы (P3)

**Описание**: Сейчас есть 3 layout'а в `TravelPageGenerator` (full-bleed, framed, split), но V1 использует только один собственный вариант.

**Решение**: Интегрировать layout'ы из `TravelPageGenerator` в V1:
- Добавить в `BookSettings` поле `photoPageLayout: 'full-bleed' | 'framed' | 'split'` (default: `'full-bleed'`)
- Full-bleed: текущий стиль (фото на всю страницу)
- Framed: фото в рамке с подписью снизу (более «книжный» стиль)
- Split: 70% фото + 30% цветной блок с названием

---

## 5. Что убрать / исправить

### 5.1. Удалить дублирующий `renderCoverPage` из V1 (P1)

**Текущее**: `EnhancedPdfGenerator.ts` содержит `renderCoverPage` (~200 строк), который не вызывается — используется `CoverPageGenerator`.

**Действие**: Удалить метод `renderCoverPage` из `EnhancedPdfGenerator.ts`.

---

### 5.2. Убрать рендер пустого описания (P1)

**Текущее**: При отсутствии описания рендерится заголовок «Описание» + текст «Описание путешествия отсутствует».

**Действие**: Если `descriptionBlocks.length === 0` — не рендерить секцию вообще.

**Файл**: `EnhancedPdfGenerator.ts` (строки 937-963)

---

### 5.3. Убрать декоративные круги с обложки (P1)

**Действие**: Удалить `renderDecorativeElements()` из `CoverPageGenerator.ts` или сделать условным (только для тем без фото).

---

### 5.4. Убрать случайные цитаты из галереи (P2)

**Текущее**: `getGalleryQuote` выбирает случайную мотивационную цитату для каждого путешествия.

**Действие**: Убрать цитату из `renderGalleryPages`. Если нужен текст — показать описание путешествия (первые 100 символов).

---

### 5.5. Исправить дублирование `escapeHtml` (P3)

**Текущее**: Метод `escapeHtml` дублируется в 6 файлах: `EnhancedPdfGenerator.ts`, `CoverPageGenerator.ts`, `TravelPageGenerator.ts`, `GalleryPageGenerator.ts`, `FinalPageGenerator.ts`, `MapPageGenerator.ts`.

**Действие**: Вынести в общую утилиту `services/pdf-export/utils/htmlUtils.ts`:
```ts
export function escapeHtml(text: string): string { ... }
export function buildSafeImageUrl(url: string): string { ... }
```

---

### 5.6. Исправить дублирование вспомогательных label-функций (P3)

**Текущее**: `getTravelLabel`, `getDaysLabel`, `getPhotoLabel`, `getCountryLabel`, `getLocationLabel` — дублируются в разных генераторах.

**Действие**: Вынести в `services/pdf-export/utils/pluralize.ts`.

---

## 6. Приоритизация

### P1 — Критично (влияет на визуальное качество PDF) ✅

| # | Задача | Сложность | Влияние | Статус |
|---|---|---|---|---|
| 3.1 | `object-fit: cover` для основных изображений | Низкая | **Высокое** — устраняет пустые области | ✅ |
| 3.2 | Обложка: упрощение слоёв затемнения | Средняя | **Высокое** — обложка — первое впечатление | ✅ |
| 3.3 | Фото-страница: правильный градиент | Низкая | **Высокое** — каждое путешествие начинается с фото | ✅ |
| 3.4 | Контент: убрать пустое описание, уменьшить QR, убрать дублирование галереи | Средняя | **Высокое** — экономия места, профессиональный вид | ✅ |
| 5.1 | Удалить дублирующий `renderCoverPage` | Низкая | Среднее — уменьшает объём кода | ✅ |
| 5.2 | Убрать рендер пустого описания | Низкая | **Высокое** — избавляет от «заглушек» | ✅ |
| 5.3 | Убрать декоративные круги | Низкая | Среднее — чище обложка | ✅ |

### P2 — Важно (полировка дизайна) ✅

| # | Задача | Сложность | Влияние | Статус |
|---|---|---|---|---|
| 3.5 | Галерея: реальные подписи | Низкая | Среднее | ✅ |
| 3.6 | Карта: маршрутная линия | Средняя | Среднее | ✅ |
| 3.7 | Чек-листы: чекбоксы | Низкая | Среднее | ✅ |
| 3.8 | Финальная страница: тема + статистика | Средняя | Среднее | ✅ |
| 3.9 | Типографика: буквицы, выравнивание | Средняя | Среднее | ✅ |
| 4.1 | Blur-backdrop для одиночных фото | Средняя | Среднее | ✅ |
| 5.4 | Убрать цитаты из галереи | Низкая | Низкое | ✅ |

### P3 — Nice-to-have (дополнительные фичи) ✅

| # | Задача | Сложность | Влияние | Статус |
|---|---|---|---|---|
| 3.10 | Running header | Средняя | Среднее | ✅ |
| 4.2 | Разделительные страницы | Средняя | Низкое | ✅ |
| 4.3 | Статистическая карточка | Низкая | Низкое | ✅ |
| 4.4 | Альтернативные layout'ы фото-страницы | Высокая | Среднее | ✅ |
| 5.5 | Рефакторинг `escapeHtml` | Низкая | Низкое | ✅ |
| 5.6 | Рефакторинг label-функций | Низкая | Низкое | ✅ |

### Дополнительно — Структурный рефакторинг ✅

| # | Задача | Статус |
|---|---|---|
| R.1 | Извлечение `renderGalleryPages` → `V1GalleryRenderer` | ✅ |
| R.2 | Извлечение `renderMapPage` → `V1MapRenderer` | ✅ |
| R.3 | Извлечение `renderFinalPage` → `V1FinalRenderer` | ✅ |
| R.4 | Общие хелперы → `V1RenderHelpers` | ✅ |
| R.5 | Дедупликация `escapeHtml` во всех 6 page-генераторах | ✅ |
| R.6 | Дедупликация label-функций в CoverPage/FinalPage/MapPage | ✅ |
| R.7 | Удаление dead code (galleryQuotes, неиспользуемые импорты) | ✅ |
| R.8 | Unit-тесты для V1 рендереров (24 теста) | ✅ |

---

## Ограничения

- **Бэкенд не меняется** — все данные берутся из `TravelForBook`
- **Дизайн-система** — PDF-темы живут в `PdfThemeConfig.ts`, не зависят от `DESIGN_TOKENS`
- **Шрифты** — подключаются через Google Fonts; при offline-генерации используются системные fallback
- **Тестирование** — каждое изменение должно проходить `yarn lint` + `yarn test:run`; визуальную проверку делать через `Ctrl+P → Print → Save as PDF` в Chrome

---

*Документ составлен на основе анализа 12 тем оформления, 8 генераторов страниц, парсера контента, рендерера блоков, UI настроек и 8 пресетов экспорта.*
