# Руководство по тестированию детальной страницы путешествия

## Обзор

Этот документ описывает автоматизированные тесты для детальной страницы путешествия (`/travels/[id]`).

## Файлы с тестами

### E2E тесты (Playwright)

1. **`e2e/travel-detail-page.spec.ts`** - Основные E2E сценарии
   - TC-001: Загрузка детальной страницы (P1)
   - TC-002: Галерея изображений (P1)
   - TC-003: Карта и точки маршрута (P1)
   - TC-004: Список точек маршрута (P2)
   - TC-005: Quick Facts (P2)
   - TC-006: Секции контента (P1)
   - TC-007 & TC-009: Избранное (P1)
   - TC-010: Информация об авторе (P2)
   - TC-014: Боковое меню навигации Desktop (P2)
   - TC-015: Компактное меню Mobile (P2)
   - TC-016: Поделиться путешествием (P2)
   - TC-017 & TC-018: Похожие путешествия (P3)
   - TC-019: Breadcrumbs (P3)
   - TC-020: 404 обработка (P1)
   - TC-021: Мобильная адаптивность (P1)
   - TC-022: SEO метатеги (P1)
   - TC-023: Schema.org разметка (P2)
   - TC-025: Обработка ошибок (P1)
   - TC-026: Ленивая загрузка изображений (P2)
   - TC-027: Accessibility (P2)

2. **`e2e/travel-detail-interactions.spec.ts`** - Интерактивные функции
   - TC-011: YouTube видео (P3)
   - TC-012: Счетчик просмотров (P3)
   - TC-013: Кнопка редактирования (P1)
   - TC-028: Экспорт в PDF (P3)
   - TC-029: Переход между путешествиями (P3)
   - TC-030: Модерация и статусы (P2)
   - Дополнительные проверки взаимодействия

3. **`e2e/travel-detail-performance.spec.ts`** - Производительность
   - TC-024: Метрики производительности (P2)
   - Размер ресурсов
   - Количество HTTP запросов
   - CLS (Cumulative Layout Shift)
   - Оптимизация изображений
   - Управление памятью

### Unit тесты (Jest)

4. **`__tests__/components/travel/TravelDetailsContainer.full.test.tsx`** - Unit тесты компонентов
   - Структура компонента
   - Security и санитизация
   - Quick Facts
   - Галерея
   - Карта
   - Автор
   - Секции контента
   - Адаптивность
   - SEO
   - Accessibility
   - Обработка ошибок

## Запуск тестов

### E2E тесты (Playwright)

```bash
# Установка Playwright (первый раз)
npx playwright install

# Запуск всех E2E тестов
yarn e2e

# Запуск только тестов детальной страницы
yarn e2e e2e/travel-detail-page.spec.ts
yarn e2e e2e/travel-detail-interactions.spec.ts
yarn e2e e2e/travel-detail-performance.spec.ts

# Запуск в headed режиме (с браузером)
yarn e2e:headed

# Запуск в UI режиме (интерактивный)
yarn e2e:ui

# Запуск конкретного теста
yarn e2e -g "TC-001"
```

### Unit тесты (Jest)

```bash
# Запуск всех unit тестов
yarn test:run

# Запуск только тестов TravelDetailsContainer
yarn test __tests__/components/travel/TravelDetailsContainer.full.test.tsx

# Запуск в watch режиме
yarn test

# С покрытием
yarn test:coverage
```

## Переменные окружения для E2E

```bash
# API URL для тестов
export E2E_API_URL=https://metravel.by

# Отключить автоматический вебсервер (если сервер уже запущен)
export E2E_NO_WEBSERVER=1
export BASE_URL=http://localhost:8081

# Настройка прокси
export E2E_API_PROXY_TARGET=https://metravel.by
export E2E_API_PROXY_INSECURE=true
export E2E_API_PROXY_TIMEOUT_MS=20000

# Настройка очистки созданных путешествий
export E2E_API_CLEANUP_TIMEOUT_MS=20000
export E2E_API_CLEANUP_BUDGET_MS=60000
export E2E_API_CLEANUP_CONCURRENCY=2

# Путь к списку путешествий (по умолчанию /travelsby)
export E2E_TRAVELS_LIST_PATH=/travelsby
```

## Структура тестов

### Приоритеты

- **P1 (Critical)** - Критичные сценарии, должны выполняться в CI/CD
- **P2 (Important)** - Важные сценарии, рекомендуется выполнять регулярно
- **P3 (Nice-to-have)** - Дополнительные сценарии, опционально

### Паттерны именования

```typescript
// E2E тесты
test.describe('Travel Details - [Feature Area]', () => {
  test('TC-XXX: [описание на русском]', async ({ page }) => {
    // тест
  });
});

// Unit тесты
describe('TravelDetailsContainer - [Feature Area]', () => {
  test('[описание на русском]', () => {
    // тест
  });
});
```

## Покрытие тест-кейсов

### Полностью покрыто автоматизацией

✅ TC-001: Загрузка детальной страницы  
✅ TC-002: Галерея изображений  
✅ TC-003: Карта и точки маршрута  
✅ TC-004: Список точек маршрута  
✅ TC-005: Quick Facts  
✅ TC-006: Секции контента  
✅ TC-007: Добавление в избранное  
✅ TC-009: Попытка добавить без авторизации  
✅ TC-010: Информация об авторе  
✅ TC-011: YouTube видео  
✅ TC-012: Счетчик просмотров  
✅ TC-014: Боковое меню Desktop  
✅ TC-015: Компактное меню Mobile  
✅ TC-016: Поделиться  
✅ TC-017: Похожие путешествия  
✅ TC-019: Breadcrumbs  
✅ TC-020: 404 обработка  
✅ TC-021: Мобильная адаптивность  
✅ TC-022: SEO метатеги  
✅ TC-023: Schema.org разметка  
✅ TC-024: Производительность  
✅ TC-025: Обработка ошибок  
✅ TC-026: Ленивая загрузка  
✅ TC-027: Accessibility  
✅ TC-030: Модерация и статусы  

### Частично покрыто

⚠️ TC-008: Удаление из избранного (требует авторизации)  
⚠️ TC-013: Кнопка редактирования (требует авторизации как автор)  
⚠️ TC-018: Путешествия автора (проверяется косвенно)  
⚠️ TC-028: Экспорт в PDF (если функция не реализована)  
⚠️ TC-029: Переход между путешествиями (если функция не реализована)  

### Не покрыто автоматизацией

❌ Нет - все критичные сценарии покрыты

## Отладка тестов

### Playwright

```bash
# Запуск с отладкой
PWDEBUG=1 yarn e2e e2e/travel-detail-page.spec.ts

# Генерация трейса
yarn e2e --trace on

# Просмотр отчета
yarn playwright show-report
```

### Jest

```bash
# Запуск с отладкой через Node
node --inspect-brk node_modules/.bin/jest __tests__/components/travel/TravelDetailsContainer.full.test.tsx

# Отладка в VS Code/WebStorm - используйте встроенный дебаггер
```

## CI/CD интеграция

### Минимальный набор для CI

```bash
# Запуск критичных E2E тестов
yarn e2e e2e/travel-detail-page.spec.ts

# Запуск всех unit тестов
yarn test:run

# Проверка lint
yarn lint
```

### Полный набор (nightly builds)

```bash
# Все E2E тесты
yarn e2e

# Все unit тесты с покрытием
yarn test:coverage

# Performance тесты
yarn e2e e2e/travel-detail-performance.spec.ts
```

## Известные ограничения

1. **Авторизация**: Некоторые тесты требуют авторизации. В текущей версии они проверяют только доступность UI элементов.

2. **Динамический контент**: Тесты работают с реальными данными из API, поэтому результаты могут варьироваться.

3. **Производительность**: Метрики производительности зависят от сети и окружения.

4. **Опциональные функции**: Некоторые функции (экспорт в PDF, навигация между путешествиями) могут быть не реализованы.

## Best Practices

1. **Используйте data-testid**: Добавляйте `testid` атрибуты для стабильных селекторов
2. **Избегайте хрупких селекторов**: Не используйте CSS классы для поиска элементов
3. **Добавляйте waitFor**: Всегда ждите загрузки асинхронного контента
4. **Проверяйте доступность**: Убедитесь, что элементы видимы и кликабельны
5. **Логируйте контекст**: Используйте annotations для отладки
6. **Graceful degradation**: Тесты должны корректно обрабатывать отсутствие опциональных данных

## Поддержка

При возникновении проблем:

1. Проверьте консоль браузера в headed режиме
2. Изучите скриншоты и видео из `test-results/`
3. Запустите тест с трейсингом для детальной диагностики
4. Проверьте переменные окружения

## Обновление тестов

При изменении компонентов:

1. Обновите селекторы если изменились testid
2. Добавьте новые тест-кейсы для новой функциональности
3. Обновите документацию
4. Запустите все тесты локально перед коммитом

## Метрики качества

Целевые показатели:

- **E2E покрытие**: > 80% критичных сценариев (P1)
- **Unit покрытие**: > 70% кода компонентов
- **Performance**: LCP < 2.5s, CLS < 0.1
- **Accessibility**: Все интерактивные элементы доступны с клавиатуры
- **Success rate**: > 95% тестов проходят стабильно
