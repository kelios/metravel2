# ТЗ: Подписка / Отписка — фронтенд-доработка

> Версия: 1.0 | Дата: 2026-02-08
> Статус: Анализ текущей реализации + требования к доработке
> Скоуп: **только фронтенд** (бэкенд API уже реализован)

---

## 1. Общее описание

Функциональность «Подписаться / Отписаться» позволяет авторизованным пользователям Metravel подписываться на авторов путешествий и управлять списком подписок. Подписка даёт пользователю доступ к ленте путешествий выбранных авторов на странице «Подписки».

---

## 2. Анализ текущей реализации (AS-IS)

### 2.1 Архитектура

| Слой | Файл | Описание |
|------|------|----------|
| **API** | `api/user.ts` | 4 функции: `subscribeToUser`, `unsubscribeFromUser`, `fetchMySubscriptions`, `fetchMySubscribers` |
| **Хук** | `hooks/useSubscription.ts` | Хук `useSubscription(targetUserId)` — состояние подписки, optimistic mutations, toggle |
| **Кнопка** | `components/ui/SubscribeButton.tsx` | Универсальная кнопка «Подписаться» / «Вы подписаны» |
| **Экран** | `app/(tabs)/subscriptions.tsx` | Страница «Подписки» — список авторов с их путешествиями |
| **Query keys** | `queryKeys.ts` | `mySubscriptions`, `mySubscribers` |

### 2.2 API-эндпоинты (существующие, бэкенд готов)

| Метод | Эндпоинт | Назначение |
|-------|----------|------------|
| POST | `/user/{id}/subscribe/` | Подписаться на пользователя |
| DELETE | `/user/{id}/unsubscribe/` | Отписаться от пользователя |
| GET | `/user/subscriptions/` | Список моих подписок (массив `UserProfileDto`) |
| GET | `/user/subscribers/` | Список моих подписчиков (массив `UserProfileDto`) |

### 2.3 Модель данных (фронтенд)

```typescript
// api/user.ts
interface UserProfileDto {
  id: number;
  first_name: string | null;
  last_name: string | null;
  avatar: string | null;
  user: number | null;        // FK на auth User
  youtube: string;
  instagram: string;
  twitter: string;
  vk: string;
}
```

### 2.4 Точки интеграции кнопки `SubscribeButton`

| Место | Файл | Контекст |
|-------|------|----------|
| Профиль автора (публичный) | `app/(tabs)/user/[id].tsx` | Под аватаром и именем пользователя |
| Карточка автора на странице путешествия | `components/travel/AuthorCard.tsx` | В блоке действий (подписка + «Написать») |
| Боковая панель путешествия (desktop) | `components/travel/CompactSideBarTravel.tsx` | Рядом с кнопкой «Написать» |

### 2.5 Реализованные функции

- **Кнопка подписки** — отображает «Подписаться» (primary) или «Вы подписаны» (outline) с иконками `user-plus` / `user-check`
- **Optimistic updates** — при нажатии UI обновляется мгновенно, откат при ошибке
- **Скрытие на своём профиле** — кнопка не рендерится, если `targetUserId === currentUserId`
- **Редирект на логин** — неавторизованный пользователь перенаправляется на страницу входа
- **Страница подписок** — список авторов с аватарами, именами, количеством путешествий, горизонтальным скроллом карточек путешествий
- **Отписка со страницы подписок** — кнопка `user-minus` с подтверждением (`confirmAction`)
- **Навигация к сообщениям** — кнопка «Написать» (`mail`) → `/messages?userId=X`
- **Навигация к профилю** — клик по автору → `/user/{id}`
- **Тесты** — unit-тесты для API (`subscriptions.test.ts`), компонента (`SubscribeButton.test.tsx`), экрана (`subscriptions.test.tsx`)

### 2.6 Выявленные проблемы и ограничения

#### Критические

| # | Проблема | Детали |
|---|----------|--------|
| **S1** | **Нет счётчика подписчиков / подписок в профиле** | На странице `user/[id].tsx` нет отображения количества подписчиков и подписок пользователя. Пользователь не видит «социальный вес» автора. |
| **S2** | **Нет уведомлений о новых подписчиках** | Пользователь не узнаёт, что на него подписались. Нет badge, нет push, нет in-app уведомления. |

#### Существенные

| # | Проблема | Детали |
|---|----------|--------|
| **S3** | **Нет ленты обновлений подписок** | Страница «Подписки» показывает статичный список авторов и их путешествий, но нет хронологической ленты «Новое от ваших подписок» (новые путешествия, отсортированные по дате). |
| **S4** | **Загрузка путешествий авторов — N+1 запросов** | На странице подписок для каждого автора выполняется отдельный `fetchMyTravels({ user_id })`. При 20 подписках — 20 параллельных запросов. Нет batch-эндпоинта. |
| **S5** | ~~**Нет вкладки «Подписчики»**~~ | ✅ **РЕШЕНО.** Добавлен переключатель «Подписки» / «Подписчики» с `SubscriberSection` (аватар, имя, `SubscribeButton`, кнопка «Написать»). |
| **S6** | ~~**Кнопка не показывает состояние загрузки при первом рендере**~~ | ✅ **РЕШЕНО.** Spinner + `disabled` + нейтральный label `...` во время `isLoading`. |
| **S7** | ~~**Нет обработки ошибок мутаций в UI**~~ | ✅ **РЕШЕНО.** `showToast` в `onError` обеих мутаций в `useSubscription`. |
| **S8** | ~~**Страница подписок не в навигации**~~ | ✅ **РЕШЕНО.** Пункт «Подписки» в `AccountMenu` (секция «Аккаунт»). |

#### Минорные

| # | Проблема | Детали |
|---|----------|--------|
| **S9** | ~~**Нет анимации при подписке/отписке**~~ | ✅ **РЕШЕНО.** Scale-анимация 0.95→1.0 (150ms) через `Animated.sequence` в `SubscribeButton`. |
| **S10** | ~~**Нет поиска по подпискам**~~ | ✅ **РЕШЕНО.** Поле поиска по имени на обеих вкладках с клиентской фильтрацией. |
| **S11** | **Соцсети в UserProfileDto не используются** | Поля `youtube`, `instagram`, `twitter`, `vk` загружаются, но нигде не отображаются в контексте подписок. |
| **S12** | **Нет пагинации на странице подписок** | Все подписки загружаются одним запросом. При большом количестве подписок (50+) может быть проблема с производительностью. |

---

## 3. Требования к доработке (TO-BE) — только фронтенд

### 3.1 Фаза 1 — Улучшение существующего UX

#### 3.1.1 Счётчики подписчиков / подписок в профиле пользователя (S1)

**Цель:** Показать социальный контекст автора.

**Файлы для изменения:**
- `app/(tabs)/user/[id].tsx`
- `hooks/useSubscription.ts` (или новый хук `useSubscriptionCounts`)

**Требования:**
- Под именем пользователя на странице `user/[id].tsx` отображать:
  ```
  12 подписчиков · 5 подписок
  ```
- Для текущего пользователя (свой профиль): показывать оба счётчика.
- Для чужого профиля: показывать только количество подписчиков.
- Счётчики кликабельны — переход на страницу подписок/подписчиков (Фаза 2).
- Данные: использовать `fetchMySubscribers().length` для подписчиков текущего пользователя. Для чужого профиля — **требуется бэкенд-эндпоинт** `GET /user/{id}/subscribers-count/` (вне скоупа фронтенда, пока показывать только для своего профиля).

**Критерий приёмки:** На странице профиля отображаются счётчики; при подписке/отписке счётчик обновляется.

#### 3.1.2 Обработка ошибок мутаций (S7)

**Цель:** Информировать пользователя об ошибках.

**Файлы для изменения:**
- `hooks/useSubscription.ts`
- `components/ui/SubscribeButton.tsx`

**Требования:**
- При ошибке `subscribeToUser` / `unsubscribeFromUser` показывать toast-уведомление:
  - «Не удалось подписаться. Попробуйте позже.»
  - «Не удалось отписаться. Попробуйте позже.»
- Использовать существующий механизм toast/snackbar (если есть) или `Alert.alert` как fallback.
- Optimistic rollback сохраняется как есть.

**Критерий приёмки:** При сетевой ошибке пользователь видит сообщение; кнопка возвращается в предыдущее состояние.

#### 3.1.3 Корректное состояние загрузки кнопки (S6)

**Цель:** Не вводить пользователя в заблуждение во время загрузки.

**Файлы для изменения:**
- `components/ui/SubscribeButton.tsx`

**Требования:**
- Пока `isLoading === true` (загрузка списка подписок), кнопка должна:
  - Показывать spinner/skeleton вместо текста «Подписаться».
  - Быть `disabled` (не реагировать на нажатие).
- После загрузки — показывать корректное состояние («Подписаться» или «Вы подписаны»).

**Критерий приёмки:** Кнопка не показывает «Подписаться» для уже подписанного пользователя в момент загрузки.

#### 3.1.4 Вкладка «Подписчики» на странице подписок (S5)

**Цель:** Дать пользователю возможность видеть, кто на него подписан.

**Файлы для изменения:**
- `app/(tabs)/subscriptions.tsx`

**Требования:**
- Добавить переключатель вкладок (tabs/segmented control) вверху страницы:
  - **«Подписки»** (текущий функционал) — на кого я подписан.
  - **«Подписчики»** — кто подписан на меня.
- Вкладка «Подписчики»:
  - Использовать `fetchMySubscribers()` (API уже есть).
  - Отображать список профилей: аватар, имя, кнопка «Подписаться в ответ» (`SubscribeButton`), кнопка «Написать».
  - Пустое состояние: «У вас пока нет подписчиков».
- Активная вкладка сохраняется при навигации (query param `?tab=subscribers` или локальный state).

**Критерий приёмки:** Пользователь может переключаться между «Подписки» и «Подписчики»; список подписчиков загружается и отображается корректно.

### 3.2 Фаза 2 — Расширение функциональности

#### 3.2.1 Лента обновлений от подписок (S3)

**Цель:** Показывать новые путешествия от авторов, на которых подписан пользователь.

**Файлы для изменения:**
- `app/(tabs)/subscriptions.tsx` (или новый экран)

**Требования:**
- Добавить третью вкладку **«Лента»** или сделать её основной.
- Лента показывает путешествия авторов из подписок, отсортированные по дате публикации (новые сверху).
- Пагинация (infinite scroll).
- Карточки путешествий в формате `TabTravelCard`.
- **Зависимость от бэкенда:** Нужен эндпоинт `GET /travels/?subscriptions=true` или аналог, который возвращает путешествия только от авторов из подписок. Без этого — клиентская агрегация (загрузка путешествий каждого автора и merge + sort).

**Критерий приёмки:** Пользователь видит хронологическую ленту путешествий от авторов из подписок.

#### 3.2.2 Поиск по подпискам (S10)

**Цель:** Быстрый поиск автора в списке подписок.

**Файлы для изменения:**
- `app/(tabs)/subscriptions.tsx`

**Требования:**
- Добавить поле поиска над списком авторов.
- Фильтрация по имени/фамилии (клиентская, т.к. список уже загружен).
- Поиск доступен на всех платформах (desktop + mobile).

**Критерий приёмки:** Ввод текста фильтрует список авторов в реальном времени.

#### 3.2.3 Анимация кнопки подписки (S9)

**Цель:** Улучшить тактильный feedback.

**Файлы для изменения:**
- `components/ui/SubscribeButton.tsx`

**Требования:**
- При нажатии: scale-анимация (0.95 → 1.0, 150ms).
- При смене состояния: fade-transition текста и иконки (200ms).
- На iOS: haptic feedback (`Haptics.impactAsync(ImpactFeedbackStyle.Light)`).

**Критерий приёмки:** Нажатие на кнопку сопровождается визуальной и тактильной обратной связью.

#### 3.2.4 Доступ к подпискам из навигации (S8)

**Цель:** Сделать страницу подписок доступной из основной навигации.

**Файлы для изменения:**
- `app/(tabs)/_layout.tsx`
- Или: добавить ссылку в меню профиля / настройки

**Требования:**
- Вариант А: Добавить пункт «Подписки» в меню профиля / аккаунта (если есть dropdown/drawer).
- Вариант Б: Добавить иконку в header навигации (для авторизованных).
- Вариант В: Оставить `HIDDEN` в tabs, но добавить ссылку на странице профиля текущего пользователя.
- Выбор варианта — по согласованию с дизайнером.

**Критерий приёмки:** Авторизованный пользователь может попасть на страницу подписок не более чем за 2 клика из любого экрана.

---

## 4. Требования к тестированию

### 4.1 Существующие тесты (сохранить)

| Файл | Покрытие |
|------|----------|
| `__tests__/api/subscriptions.test.ts` | API: subscribe, unsubscribe, fetchMySubscriptions, fetchMySubscribers |
| `__tests__/components/SubscribeButton.test.tsx` | Кнопка: рендер состояний, нажатие, redirect, null для своего профиля |
| `__tests__/app/subscriptions.test.tsx` | Экран: login prompt, empty state, список авторов, счётчик |

### 4.2 Новые тесты (по фазам)

#### Фаза 1

| Файл | Покрытие |
|------|----------|
| `__tests__/components/SubscribeButton.test.tsx` | Добавить: состояние loading (spinner, disabled); toast при ошибке |
| `__tests__/app/subscriptions.test.tsx` | Добавить: переключение вкладок «Подписки» / «Подписчики»; пустое состояние подписчиков; рендер списка подписчиков |
| `__tests__/app/user-profile.test.tsx` | Добавить: отображение счётчиков подписчиков/подписок |

#### Фаза 2

| Файл | Покрытие |
|------|----------|
| `__tests__/app/subscriptions.test.tsx` | Добавить: поиск по подпискам; лента обновлений |
| E2E: `e2e/subscriptions.spec.ts` | Подписка → проверка на странице подписок; отписка с подтверждением; переключение вкладок |

---

## 5. Нефункциональные требования

| Параметр | Требование |
|----------|------------|
| **Производительность** | Загрузка списка подписок < 300ms; optimistic update < 50ms (визуально мгновенно) |
| **Доступность** | WCAG 2.1 AA: `accessibilityLabel` на кнопке подписки меняется в зависимости от состояния; `aria-pressed` для toggle-кнопки; фокус с клавиатуры |
| **Платформы** | Web (desktop + mobile), iOS, Android |
| **Безопасность** | Только авторизованные пользователи; нельзя подписаться на себя; XSS-защита имён пользователей |
| **Лимиты** | Нет ограничения на количество подписок (фронтенд); rate-limiting — на стороне бэкенда |

---

## 6. Приоритизация

| Задача | Приоритет | Оценка (фронтенд) | Зависимость от бэкенда |
|--------|-----------|--------------------|------------------------|
| 3.1.1 Счётчики в профиле | **Высокий** | 2–3 ч | Частично (для чужого профиля нужен эндпоинт) |
| 3.1.2 Обработка ошибок | **Высокий** | 1–2 ч | Нет |
| 3.1.3 Состояние загрузки кнопки | **Высокий** | 0.5–1 ч | Нет |
| 3.1.4 Вкладка «Подписчики» | **Средний** | 3–4 ч | Нет (API есть) |
| 3.2.1 Лента обновлений | **Средний** | 6–8 ч | Да (batch-эндпоинт) |
| 3.2.2 Поиск по подпискам | **Низкий** | 1–2 ч | Нет |
| 3.2.3 Анимация кнопки | **Низкий** | 1–2 ч | Нет |
| 3.2.4 Навигация к подпискам | **Средний** | 1–2 ч | Нет |
| Тесты (Фаза 1) | **Высокий** | 3–4 ч | Нет |
| Тесты (Фаза 2 + E2E) | **Средний** | 4–6 ч | Нет |

**Итого Фаза 1:** ~8–12 ч фронтенд  
**Итого Фаза 2:** ~14–20 ч фронтенд

---

## 7. Диаграмма компонентов (текущая + планируемая)

```
app/(tabs)/user/[id].tsx (PublicUserProfileScreen)
├── useSubscription(userId)
├── SubscribeButton ──────────── POST /user/{id}/subscribe/
│                                DELETE /user/{id}/unsubscribe/
├── [NEW] Счётчики подписчиков/подписок
│
app/(tabs)/subscriptions.tsx (SubscriptionsScreen)
├── useAuth()
├── useQuery(mySubscriptions) ── GET /user/subscriptions/
├── [NEW] useQuery(mySubscribers) ── GET /user/subscribers/
├── [NEW] Tab: «Подписки» / «Подписчики»
│
├── Tab «Подписки» (текущий)
│   ├── AuthorSection
│   │   ├── Avatar + Name (→ /user/{id})
│   │   ├── Actions: mail (→ /messages?userId=X), user-minus (отписка)
│   │   └── ScrollView<TabTravelCard> (путешествия автора)
│   └── [NEW] Поиск по имени
│
├── [NEW] Tab «Подписчики»
│   └── SubscriberSection
│       ├── Avatar + Name
│       ├── SubscribeButton (подписаться в ответ)
│       └── Actions: mail
│
components/ui/SubscribeButton.tsx
├── useSubscription(targetUserId)
├── [NEW] Loading skeleton state
├── [NEW] Error toast on mutation failure
├── [NEW] Scale/fade animation
│
components/travel/AuthorCard.tsx
├── SubscribeButton
│
components/travel/CompactSideBarTravel.tsx
├── SubscribeButton
```

---

## 8. Сравнение с модулем избранного (Favorites)

Для справки — модуль избранного (`context/FavoritesContext.tsx`, `stores/favoritesStore.ts`) реализован более зрело:

| Возможность | Избранное | Подписки |
|-------------|-----------|----------|
| Optimistic updates | ✅ | ✅ |
| Обработка ошибок в UI | ✅ Toast | ✅ Toast (S7) |
| Счётчик в профиле | ✅ Badge | ✅ Счётчики (S1) |
| Доступ из навигации | ✅ Tab | ✅ AccountMenu (S8) |
| Пустое состояние | ✅ С CTA | ✅ С CTA |
| Поиск/фильтрация | ✅ | ✅ По имени (S10) |
| Анимация | ❌ Нет | ✅ Scale (S9) |
| Тесты | ✅ | ✅ 25 unit + 5 E2E |

---

## 9. Лог реализации

| Дата | Что сделано |
|------|------------|
| 2026-02-08 | **Фаза 1.1 (S1):** Счётчики подписчиков/подписок на странице профиля `user/[id].tsx`. |
| 2026-02-08 | **Фаза 1.2 (S7):** Toast-уведомления при ошибке подписки/отписки в `useSubscription`. |
| 2026-02-08 | **Фаза 1.3 (S6):** Spinner + disabled + нейтральный label при загрузке в `SubscribeButton`. |
| 2026-02-08 | **Фаза 1.4 (S5):** Вкладка «Подписчики» с `SubscriberSection` в `subscriptions.tsx`. |
| 2026-02-08 | **Фаза 2.2 (S10):** Поиск по имени на обеих вкладках с клиентской фильтрацией. |
| 2026-02-08 | **Фаза 2.3 (S9):** Scale-анимация 0.95→1.0 (150ms) в `SubscribeButton`. |
| 2026-02-08 | **Фаза 2.4 (S8):** Пункт «Подписки» уже был в `AccountMenu` (секция «Аккаунт»). |
| 2026-02-08 | **Тесты:** 25 unit-тестов (API: 4, SubscribeButton: 12, subscriptions screen: 8, user profile: 1). 5 E2E-сценариев (Playwright). |

### Зависимости от бэкенда (ожидают реализации)

| Эндпоинт / функция | Статус | Описание |
|------------------|--------|----------|
| `GET /user/{id}/subscribers-count/` | ⏳ Ожидает | Счётчик подписчиков для чужого профиля (S1) |
| `GET /travels/?subscriptions=true` | ⏳ Ожидает | Лента обновлений от подписок (S3) |
| Batch-эндпоинт путешествий | ⏳ Ожидает | Устранение N+1 запросов (S4) |
| Push/in-app уведомления | ⏳ Ожидает | Уведомления о новых подписчиках (S2) |
